[% INCLUDE "intranet-top.inc" %]

<link rel="stylesheet" type="text/css" href="[% themelang %]/includes/epoch_styles.css ">

<script src="/includes/jquery/tablesorter/jquery.tablesorter.js"></script>
<link href="/includes/jquery/tablesorter/blue/style.css" type="text/css" rel="stylesheet">
<!--<script src="/includes/jquery/jquery.bgiframe.min.js"></script>
<script src="/includes/jquery/jquery.dimensions.js"></script>
<script src="/includes/jquery/ui.mouse.js"></script>
<script src="/includes/jquery/jquery.autocomplete.js"></script>
<link href="/includes/jquery/jquery.autocomplete.css" type="text/css" rel="stylesheet">-->

<!-- Se incluyen las librerias necesarias para manejar autocomplete -->
[% INCLUDE "AutocompleteHelper.inc" %]

<script language="javascript">

function OnChangeComboTablasSeudonimos(){
	
	var tipo= $('#tabla').val();

	switch(tipo){
		case "temas": 
			$('#content_search_temas').show();
			$('#content_search_autores').hide();
			$('#content_search_editoriales').hide();
			$('#search_temas').val('');
		break;
		case "autores": 
			$('#content_search_temas').hide();
			$('#content_search_autores').show();
			$('#content_search_editoriales').hide();
			$('#search_autores').val('');
		break;
		case "editoriales": 
			$('#content_search_temas').hide();
			$('#content_search_autores').hide();
			$('#content_search_editoriales').show();
			$('#search_editoriales').val('');
			
		break;
		case "Sin Seleccionar": ;
		break;
	}

}

function consultarTablaSeudonimos(seudonimo){

	var tabla= $("#tabla").val();

	objAH=new AjaxHelper(updateConsultarTablaSeudonimos);
	objAH.debug= true;
	objAH.url= '/cgi-bin/koha/catalogacion/configuracion/controlAutoridades/controlAutoridadesDB.pl';
	objAH.tipo= 'consultaTablasSeudonimos';
	objAH.tabla= tabla;
	objAH.seudonimo= seudonimo;
	//se envia la consulta
	objAH.sendToServer();
}

function updateConsultarTablaSeudonimos(responseText){

	$('#resultSeudonimos').html(responseText);
	$('#tablaSeudonimos').tablesorter({	
						widgets: ['zebra'],
						headers: { 0: { sorter: false},
								2: { sorter: false},
								3: { sorter: false}
							}
				});
}

/*
function AutocompleteSeudonimos(idInput, tipo, flag){
	// q= valor de campoHelp
	$("#"+idInput).search();
	$("#"+idInput).autocomplete('/cgi-bin/koha/autocompletables/controlAutoridadesAutocomplete.pl',{
 		formatItem: function(row){
// 			return row[0]+" - "+row[1];
			return row[1];
		},
		minChars:1,
        	matchSubset:1,
        	matchContains:1,
		maxItemsToShow:10,
        	cacheLength:10,
        	selectOnly:1,
		extraParams:{accion: tipo}	
	});//end autocomplete
	$("#"+idInput).result(function(event, data, formatted) {
		$("#"+idInput).val(data[1]);

//  		//creo un objeto para la autoridad con la q se va a trabajar
 		seudonimo= new object_seudonimo(data[1], data[0]);

		if(flag != 'seudonimo'){
			//creo un objeto para la autoridad con la q se va a trabajar
 			seudonimo_selected= new object_seudonimo(data[1], data[0]);
			//traigo info de seudonimos de la autoridad con la que se esta trabajando
 			consultarTablaSeudonimos(data[0]);
		}
	});
}
*/

//*********************************************Objeto Sinonimo*************************************************

function object_seudonimo(text, ID){
	this.text= text;
	this.ID= ID;
}

var objects_array= new Array();
//******************************************Fin***Objeto Sinonimo***********************************************

//******************************************TextArea************************************************************

function pushSeudonimo(){
    seudonimo.text = $.trim(seudonimo.text);
	if (!exist(seudonimo.text, objects_array)){
		objects_array.push(seudonimo);
		mapToTextArea('textAreaSeudonimos', objects_array);
        $('#search_autor_seudonimo').val('');
        $('#search_tema_seudonimo').val('');
        $('#search_editorial_seudonimo').val('');
        $('#search_autor_seudonimo').focus;
	}else{
		alert("Ya existe el elmento");
	}
	//si hay elementos habilito el boton pop
	if(objects_array.length > 0){
		$('#pop').attr('disabled', false);
	}
}

function exist(text, vector){
	var found= false;
	var long= vector.length;
	var i= 0;
	while (!(found) && (i<long)){
		if(vector[i].text == text){
			found= true;
		}else{
			i++;
		}
	}
	return found;
}

function mapToTextArea(idTextArea, vector){
	var seudonimo;

	$('#'+idTextArea).val('');
	for (var i=0;i<vector.length;i++){
		seudonimo= vector[i].text;
		$('#'+idTextArea).val(seudonimo + '\n' + $('#'+idTextArea).val() );
	}
	//deshabilito boton pop	
	$('#pop').attr('disabled', false);
}

function popSeudonimo(){
	var obj= objects_array.pop();
	mapToTextArea('textAreaSeudonimos', objects_array);
	//si se vacia, deshabilito el boton pop
	if(objects_array.length == 0){
		$('#pop').attr('disabled', true);
	}
}

function clearDataTextArea(){
	//clear data
	objects_array= new Array();
	//actualizo el textarea
	mapToTextArea('textAreaSeudonimos', objects_array);
}

//****************************************************Fin TextArea******************************************

//*********************************************ABM Seudonimos************************************************
function updateGuardarDatos(){
	consultarTablaSeudonimos(seudonimo_selected.ID);
	clearDataTextArea();
}

function guardarDatos(){
	//validar datos
	var tabla= $('#tabla').val();
	
 	var seudonimosJSON;
	//pasa el arreglo a formato json
 	seudonimosJSON=JSONstring.make(objects_array);

	objAH=new AjaxHelper(updateGuardarDatos);
	objAH.debug= true;
	objAH.url= '/cgi-bin/koha/catalogacion/configuracion/controlAutoridades/controlAutoridadesDB.pl';
	objAH.tipo= 'insertarSeudonimos';
	objAH.tabla= tabla;
	objAH.id= seudonimo_selected.ID;
 	objAH.seudonimos= seudonimosJSON;
	//se envia la consulta
	objAH.sendToServer();

}

function deleteSeudonimo(idDelete){
	var tabla= $('#tabla').val();

	var is_confirmed = confirm('Confirma la baja del seudonimo?');

	if (is_confirmed) {
	
		objAH=new AjaxHelper(updateDeleteSeudonimo);
		objAH.debug= true;
		objAH.url= '/cgi-bin/koha/catalogacion/configuracion/controlAutoridades/controlAutoridadesDB.pl';
		objAH.tipo= 'eliminarSeudonimos';
		objAH.tabla= tabla;
		objAH.id= seudonimo_selected.ID;
		objAH.idDelete= idDelete;
		//se envia la consulta
		objAH.sendToServer();
	}

}

function updateDeleteSeudonimo(responseText){

	var Messages=JSONstring.toObject(responseText);

	setMessages(Messages);

	consultarTablaSeudonimos(seudonimo_selected.ID);
}

//****************************************Fin****ABM Seudonimos************************************************

function crearObjeto(idInput, idInputHidden, flag){
/*@params idInput, idInputHidden, flag
*/
	var id= $('#'+idInputHidden).val();
	var text= $('#'+idInput).val();
	//creo un objeto para la autoridad con la q se va a trabajar
	seudonimo= new object_seudonimo(text, id);

	if(flag != 'seudonimo'){
		//creo un objeto para la autoridad con la q se va a trabajar
		seudonimo_selected= new object_seudonimo(text, id);
		//traigo info de seudonimos de la autoridad con la que se esta trabajando
		consultarTablaSeudonimos(id);
	}
}

function onCompleteTemas(){
	crearObjeto('search_temas', 'search_temas_hidden', 'NULL');
}

function onCompleteTemasSeudonimo(){
	crearObjeto('search_tema_seudonimo', 'search_tema_seudonimo_hidden', 'seudonimo');
}

function onCompleteAutores(){
	crearObjeto('search_autores', 'search_autores_hidden', 'NULL');
}

function onCompleteAutoresSeudonimo(){
	crearObjeto('search_autor_seudonimo', 'search_autor_seudonimo_hidden', 'seudonimo');
}

function onCompleteEditoriales(){
	crearObjeto('search_editoriales', 'search_editoriales_hidden', 'NULL');
}

function onCompleteEditorialesSeudonimo(){
	crearObjeto('search_editorial_seudonimo', 'search_editorial_seudonimo_hidden', 'seudonimo');
}

$(document).ready(function(){
	// Help
	$("#topichelp").hide();
	$("#tophelper img.showhelp ").click(function(){
						$("#topichelp").slideToggle('fast');
					});

// 	AutocompleteSeudonimos('search_temas','autocompleteTemas','');
	CrearAutocompleteTemas({	IdInput: 'search_temas', 
								IdInputHidden: 'search_temas_hidden', 
								callBackFunction: onCompleteTemas,
						});

// 	AutocompleteSeudonimos('search_tema_seudonimo','autocompleteTemas','seudonimo');

	CrearAutocompleteTemas({	IdInput: 'search_tema_seudonimo', 
								IdInputHidden: 'search_tema_seudonimo_hidden', 
								callBackFunction: onCompleteTemasSeudonimo,
						});

 	$('#content_search_temas').hide();


// 	AutocompleteSeudonimos('search_autores','autocompleteAutores','');
	CrearAutocompleteAutores({	IdInput: 'search_autores', 
								IdInputHidden: 'search_autores_hidden', 
								callBackFunction: onCompleteAutores,
							});

// 	AutocompleteSeudonimos('search_autor_seudonimo','autocompleteAutores','seudonimo');
	CrearAutocompleteAutores({	IdInput: 'search_autor_seudonimo', 
								IdInputHidden: 'search_autor_seudonimo_hidden', 
								callBackFunction: onCompleteAutoresSeudonimo,
						});

 	$('#content_search_autores').hide();

// 	AutocompleteSeudonimos('search_editoriales','autocompleteEditoriales','');
	CrearAutocompleteEditoriales({	IdInput: 'search_editoriales', 
									IdInputHidden: 'search_editoriales_hidden', 
									callBackFunction: onCompleteEditoriales,
					});

// 	AutocompleteSeudonimos('search_editorial_seudonimo','autocompleteEditoriales','seudonimo');
	CrearAutocompleteEditoriales({	IdInput: 'search_editorial_seudonimo', 
									IdInputHidden: 'search_editorial_seudonimo_hidden', 
									callBackFunction: onCompleteEditorialesSeudonimo,
					});

 	$('#content_search_editoriales').hide();	


	//registro evento para input de seudonimos
	$('#search_autor_seudonimo').keydown(
		function (e) {
			if(e.which == 13){
				pushSeudonimo();
			}
		});
	$('#search_tema_seudonimo').keydown(
		function (e) {
			if(e.which == 13){
				pushSeudonimo();
			}
		});
	$('#search_editorial_seudonimo').keydown(
		function (e) {
			if(e.which == 13){
				pushSeudonimo();
			}
		});


});

</script>

<div style="position: static;" id="tophelper">
<img class="showhelp" src="[% themelang %]/images/help.gif" alt="Descricion de la Ventana">
    <div style="display: block;" id="topichelp">
        <p>Descripcion breve para lo q sirve la ventana....</p>
    </div>
</div>

<table width="100%"  border="0" cellpadding="0" cellspacing="0" align="center">
	<tr>
		<td class="pagetitle" >Control de Autoridades - Seud&oacute;nimos</td>
	</tr>
	<tr>	
		<td class="lineagruesa"  align="left" colspan="3"></td>
	</tr>

</table>
<br>

<br>
<div class="formElemets">
<ul>
	<li>Seleccione la tabla</li>
	<li>
		<Select id="tabla" name="tabla" onChange="OnChangeComboTablasSeudonimos();">
			<option value="Sin Seleccionar">Sin Seleccionar</option>
			<option value="autores">Autores</option>
			<option value="temas">Temas</option>
			<option value="editoriales">Editoriales</option>
		</Select>
	</li>

	<div id="content_search_autores">
		<li>Autores:</li>
		<li>
				<input id="search_autores" type="text" size="50">
				<input id="search_autores_hidden" type="hidden">
		</li>
		<li>Autor Seud&oacute;nimo:</li>
		<li>	
				<input id="search_autor_seudonimo" type="text" size="50">
				<input id="search_autor_seudonimo_hidden" type="hidden">
		</li>
	</div>
	<div id="content_search_temas">
		<li>Temas:</li>
		<li>
				<input id="search_temas" type="text" size="50">
				<input id="search_temas_hidden" type="hidden">
		</li>
		<li>Tema Seud&oacute;nimo:</li>
		<li>
				<input id="search_tema_seudonimo" type="text" size="50">
				<input id="search_tema_seudonimo_hidden" type="hidden">
		</li>
	</div>
	<div id="content_search_editoriales">
		<li>Editoriales:</li>
		<li>
				<input id="search_editoriales" type="text" size="50">
				<input id="search_editoriales_hidden" type="hidden">
		</li>
		<li>Editorial Seud&oacute;nimo:</li>
		<li>
				<input id="search_editorial_seudonimo" type="text" size="50">
				<input id="search_editorial_seudonimo_hidden" type="hidden">
		</li>
	</div>
	<li>
		<input id="push" type="button" onClick="pushSeudonimo();" value=">>" title="Agregar Seud&oacute;nimo"> 
		<input id="pop" type="button" onClick="popSeudonimo();" value="<<" title="Sacar Seud&oacute;nimo" disabled=true>
	</li>
	<li>
		<textarea id="textAreaSeudonimos" style="height:60px; width:230px;" readonly></textarea>
	</li>

	<li><hr></hr></li>
	<li><input  src="[% themelang %]/images/guardar.png" type="image"  value="Guardar Seudónimo" title="Guardar Seudónimo" onClick="guardarDatos()">
	</li>
	<li><div id="resultSeudonimos"></div></li>
</ul>
</div>

[% INCLUDE "intranet-bottom.inc" %]
