[% INCLUDE   'intranet-top.inc'  %]

[% INCLUDE   'ChangePasswordHelper.inc'  %]

<script type="text/javascript">

function objeto_usuario(){
    this.text;
    this.ID;
}


function guardarCambiarPassword(){

     [% IF plainPassword == 0 %]
         var nroRandom   = [% nroRandom %];
         var hash_actual = b64_sha256(b64_sha256(b64_md5($("#actualpassword").val()))+nroRandom);
         var key         = b64_sha256(b64_md5($("#actualpassword").val()));
         var hash_new1   = encriptar(b64_md5($("#newpassword1").val()),key);
         var hash_new2   = encriptar(b64_md5($("#newpassword2").val()),key);

         $("#actual_password").val(hash_actual);
         $('#new_password1').val(hash_new1);
         $('#new_password2').val(hash_new2);
     [% ELSE %]
	     var hash_actual = $("#actualpassword").val();;
         var hash_new1   = $("#newpassword1").val();
         var hash_new2   = $("#newpassword2").val();
	     $("#actual_password").val(hash_actual);
	     $('#new_password1').val(hash_new1);
	     $('#new_password2').val(hash_new2);
     [% END %]
     $("#datosAEnviar").submit();
     return true;
    startOverlay();
}

function updateGuardarCambiarPassword(responseText){
    var Messages= JSONstring.toObject(responseText);
    setMessages(Messages);
}

$(document).ready(function() {
    
    usuario= new objeto_usuario();
    usuario.text= "[% completo %]";
    usuario.ID= "[% nro_socio %]";

});

</script>

<form action='[% url_prefix %]/usuarios/change_passwordDB.pl' method="POST" name="datosAEnviar" id="datosAEnviar">
        <input type="hidden" name="new_password1" id="new_password1" value="">
        <input type="hidden" name="new_password2" id="new_password2" value="">
        <input type="hidden" name="usuario" id="usuario" value="[% nro_socio %]">
        <input type="hidden" name="changePassword" id="changePassword" value="">
        <input type="hidden" name="actual_password" id="actual_password" value="">
        <input type="hidden" name="token" value="[% token %]" id="token">
</form>

[% IF cambioForzado %]
    <fieldset>
      <legend class="titulo_legend">[% 'Cambio de contrase&ntilde;a obligatorio' | i18n %]</legend>
      <p class="warning">
          [% 'Para su seguridad, es obligatorio que cambie su contrase&ntilde;a actual.' | i18n %]
          [% 'Disculpe las molestas. MERAN' | i18n %]
      </p>
    </fieldset>
[% END %]

[% IF mensaje %]
    <fieldset>
        <legend class="titulo_legend_warning">[% 'Error' | i18n %]</legend>
        <div class='tableMsgUser'>
            <font class='fontMsgUser'>
                <b>
                    <div id='mensajes'>
                        [% mensaje %]
                    </div>
                </b>
            </font>
        </div>
    </fieldset>
[% END %]

<fieldset>
    
    <legend class="titulo_legend">[% 'Cambio de contrase&ntilde;a' | i18n %]</legend>
      <section class="center-section-form">
       <form class="form-horizontal" onsubmit="false;">
          
             <div class="control-group">
                           <label class="control-label" for="actualpassword">[% "Contrase&ntilde;a Actual" | i18n %]</label>
                           <div class="controls">
                                    <input type="password" class="input focused" id="actualpassword" name="actualpassword" tabindex="1">
                           </div>
              </div>
              <div class="control-group">
                           <label class="control-label" for="newpassword1">[% "Nueva Contrase&ntilde;a" | i18n %]</label>
                           <div class="controls">
                                    <input type="password" class="input focused" id="newpassword1" name="newpassword1" tabindex="2">
                           </div>
              </div>
              <div class="control-group">
                           <label class="control-label" for="newpassword2">[% "Repetir contrase&ntilde;a" | i18n %]</label>
                           <div class="controls">
                                    <input type="password" class="input focused" id="newpassword2" name="newpassword2" tabindex="2">
                           </div>
              </div>
        
                      

       <!-- <li class="sub_item">
            <label for="actualpassword">[% 'Contrase&ntilde;a Actual' | i18n %]:</label>
            <input type="password" name="actualpassword" id="actualpassword">
        </li>-->
      <!--  <li class="sub_item">
            <label for="newpassword1">[% 'Nueva Contrase&ntilde;a' | i18n %]:</label>
            <input type="password" name="newpassword1" id="newpassword1">
        </li>-->
      <!--  <li class="sub_item">
            <label for="newpassword2">[% 'Repetir contrase&ntilde;a' | i18n %]:</label>
            <input type="password" name="newpassword2" id="newpassword2">
        </li>-->
              <div class="form-actions">
                  [% PERL %]
                                      print C4::AR::Filtros::to_Button(   text    => "[% 'Confirmar contrase&ntilde;a' | i18n %]",
                                                                          boton   => "boton_agregar",
                                                                          onClick => "guardarCambiarPassword();",
                                                                          title   => "[% 'Confirmar contrase&ntilde;a' | i18n %]",
                                                                          inline  => "1",
                                              ) ;
                  [% END %]
              </div>

               
        </form>
   </section>
</fieldset>

[% INCLUDE 'intranet-bottom.inc' %]
