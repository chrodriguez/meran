[% INCLUDE  "intranet-top.inc" %]

<script src="/intranet-tmpl/blue/includes/circulacion.js"></script>
<script src="/intranet-tmpl/blue/includes/MessageHelper.js"></script>

<!-- Se incluyen las librerias necesarias para manejar autocomplete -->
[% INCLUDE "AutocompleteHelper.inc" %]

<script>

/*=================================================================REVISADO===================================================================*/


ID_N1=0; //para saber el id del nivel 1
ID_N2=0; //para saber el id del nivel 2
ID_N3=0; //para saber el id del nivel 3

function borrarN3(id2, id3){
	if( window.confirm("[% 'Esta; seguro que desea borrarlo?' | i18n %]") ){
		ID_N2= id2;
		objAH=new AjaxHelper(updateBorrarN3);
		objAH.debug= true;
		objAH.url="/cgi-bin/koha/catalogacion/estructura/nuevo/estructuraCataloDB.pl";
 		objAH.id3_array= [id3];
		objAH.nivel=3;
		objAH.itemtype=$("#id_tipo_doc").val();
		objAH.tipoAccion="ELIMINAR_NIVEL";
		objAH.sendToServer();
	}
}

function updateBorrarN3(responseText){
    var info=JSONstring.toObject(responseText);  
    var Messages= info.Message_arrayref;
    setMessages(Messages);
	ejemplaresDelGrupo(ID_N2);
}

//muestra los ejemplares del grupo
function ejemplaresDelGrupo(id2){

	objAH=new AjaxHelper(updateEjemplaresDelGrupo);
	objAH.debug= true;
	objAH.url= '/cgi-bin/koha/catalogacion/estructura/nuevo/estructuraCataloDB.pl';
	objAH.id2= id2;
	objAH.tipoAccion= 'MOSTRAR_DETALLE_NIVEL3';
	//se envia la consulta
	objAH.sendToServer();

}

function updateEjemplaresDelGrupo(responseText){
	$('#ejemplaresDelGrupo'+objAH.id2).html(responseText);
	zebra('tablaResult');
}


function buscarUsuario(id2, id3){
	objAH=new AjaxHelper(updateBuscarUsuario);
	objAH.debug= true;
	objAH.url='/intranet-tmpl/blue/includes/popups/buscarUsuario.inc';
	objAH.debug= true;
	objAH.sendToServer();

	items_array[0]=id3;
 	grupo= id2;
}

function updateBuscarUsuario(responseText){

	vBuscarUsuario=new WindowHelper({draggable: true, opacity: true});
	vBuscarUsuario.debug= true;
	vBuscarUsuario.html=responseText;
	vBuscarUsuario.create();	
	vBuscarUsuario.titulo= 'Buscar Usuario';
	vBuscarUsuario.height('30%');
	vBuscarUsuario.width('40%');
	vBuscarUsuario.open();
}

$(document).ready(function(){
	zebra("tablaResult");	

});

/*=============================================================FIN====REVISADO================================================================*/

function detalleMARC(id3){
	objAH=new AjaxHelper(updateInfoMARC);
	objAH.debug= true;
	objAH.url= "/cgi-bin/koha/busquedas/MARCDetalle.pl";
	objAH.id3= id3;
	//se envia la consulta
	objAH.sendToServer();
}

function updateInfoMARC(responseText){
	$('#detalleComun').slideUp("slow");
	$('#detalleMARC').html(responseText);
	$('#detalleMARC').show();
}

function verDivs(){
	$('#detalleComun').slideDown("slow");
	$('#detalleComun').show();
	$('#detalleMARC').slideUp("slow");
}

function filtroPorAutor(id){
	location.href="filtrado.pl?origen=detalle&idAutor="+id;
}


function editarEjemplares(id1,id2,itemtype){
	var obj=new objeto_datos();
	objAH.debug= true;
	obj.itemtype=itemtype;
	obj.id1=id1;
	obj.id2=id2;
	obj.json=0;
	obj=JSONstring.make(obj);
	location.href="../catalogacion/estructura/editarEjemplar.pl?obj="+obj;
}


/*************************************************CIRCULACUION***************************************************/
// ESTO PARECE QUE NO SE VA A USAR
function objeto_datos(){
	this.array_ids3;
	this.usuario;
	this.id3;
	this.accion;
}


/******************************************CIRCULACUION DESDE EL DETALLE****************************************/
var items_array = new Array();
// parche, ver si se puede hacer mejor
var grupo;


function renovar(accion,userId,userNom,id2,id3){
	
	array=new Array;
	array[0]= id3;
	usuario=new objeto_usuario();
	usuario.ID=userId;
	usuario.text=userNom;

	objAH=new AjaxHelper(generaDivDevRen);
	objAH.debug= true;
	objAH.url= '/cgi-bin/koha/circ/circulacionDB.pl';
	objAH.tipoAccion= 'RENOVACION';
	objAH.datosArray= array;
	objAH.nro_socio= usuario.ID;
	//se envia la consulta
	objAH.sendToServer();
	//guardo el id2 para actualizar los ejemplares del grupo, por ahora lo hago asi!!!!!!!
	grupo= id2;
}

function devolver(accion,userId,userNom,id2,id3){

	array=new Array;
	array[0]= id3;
	usuario=new objeto_usuario();
	usuario.ID=userId;
	usuario.text=userNom;

	objAH=new AjaxHelper(generaDivDevRen); //llama a generar div de ciculacion.js
	objAH.debug= true;
	objAH.url= '/cgi-bin/koha/circ/circulacionDB.pl';
	objAH.tipoAccion= 'DEVOLUCION';
	objAH.datosArray= array;
	objAH.nro_socio= usuario.ID;
	//se envia la consulta
	objAH.sendToServer();
	//guardo el id2 para actualizar los ejemplares del grupo, por ahora lo hago asi!!!!!!!
	grupo= id2;
}

//esta funcion esta REDEFINIDA, de la funcion que se encuentra en circulacion.js, invocada por la 
function updateInfoDevRen(responseText){
// 	alert("ejecuto updateInfoDevRen local!!!!!!!");
	cancelarDiv();
	clearMessages();

	var infoHash= JSONstring.toObject(responseText);
	var messageArray= infoHash.messages;
	var ticketsArray= infoHash.tickets;
	var mensajes= '';
	for(i=0; i<messageArray.length;i++){
		imprimirTicket(ticketsArray[i].ticket,i);
  		setMessages(messageArray[i]);
	}

	ejemplaresDelGrupo(grupo);
}

function confirmarPrestamo(){

 	if(usuario.ID != ""){	

		objAH=new AjaxHelper(generaDivPrestamo);
		objAH.debug= true;
		objAH.url= '/cgi-bin/koha/circ/circulacionDB.pl';
		objAH.tipoAccion= 'CONFIRMAR_PRESTAMO';
		objAH.datosArray= items_array;
		objAH.nro_socio=usuario.ID;
		//se envia la consulta
		objAH.sendToServer();
		vBuscarUsuario.close();
	}
}


//esta funcion esta REDEFINIDA de la libreria de circulacion.js, es invocada desde la funcion prestar()
function updateInfoPrestarReserva(responseText){
	cancelarDiv();
// 	clearMessages();

	var infoHash= JSONstring.toObject(responseText);
	var messageArray= infoHash.messages;
	var ticketsArray= infoHash.tickets;
	var mensajes= '';
	for(var i=0; i<messageArray.length;i++){
		imprimirTicket(ticketsArray[i].ticket,i);
  		setMessages(messageArray[i]);
	}
	ejemplaresDelGrupo(grupo);
}

/************************************************FIN CIRCULACUION************************************************/

function borrarGrupo(id1,id2){
	objAH=new AjaxHelper(updateBorrarGrupo);
	objAH.debug= true;
	objAH.url= "/cgi-bin/koha/busquedas/detalleDB.pl";
	objAH.id1= id1;
	objAH.id2= id2;
	objAH.accion="BORRAR_GRUPO";
	//se envia la consulta
	objAH.sendToServer();
}

function updateBorrarGrupo(responseText){
	var Messages= JSONstring.toObject(responseText);
	setMessages(Messages);
	//oculto todo el grupo con los items
	$('#grupo'+objAH.id2).slideUp('slow');
	//borro el contenido
	$('#grupo'+objAH.id2).html('');
}



function borrarNivel1(id1){
	objAH=new AjaxHelper(updateBorrarNivel1);
	objAH.debug= true;
	objAH.url= "/cgi-bin/koha/busquedas/detalleDB.pl";
	objAH.id1= id1;
	objAH.accion="BORRAR_NIVEL1";
	//se envia la consulta
	objAH.sendToServer();
}

function updateBorrarNivel1(responseText){
	var Messages= JSONstring.toObject(responseText);
	setMessages(Messages);
	//oculto todo el registro con los grupos y sus items
	$('#detalleComun').slideUp('slow');
	//borro el contenido
	$('#detalleComun').html('');
}



</script>

<div id="confirmar_div" class="pane"></div>
<br>


<!-- PARA PODER CREAR EL FORMULARIO -->
<div id="formulario"></div>

<div id="detalleMARC"></div>

<!-- Mensajes de Informacion al Usuario -->
<div class="tableMsgUser">
	<font class="fontMsgUser"><b>
	<div id="mensajes"></div>
	</b></font>
</div>

<div id="detalleComun">
<div id="titulo">
	<p class="pagetitle"> 
		[% titulo %]
		[% FOREACH datosautor %]
			(<a class="click" onClick="filtroPorAutor([% id %])">[% completo %]</a>)
		[% END %]
	</p>
</div>

<!-- ---------------Registro de libro TABLE------- -->
<table cellspacing="0" cellpadding="0" border="0" align="left"  class="tablaresultado" width="100%">
	<tr valign="top" height="24" class="tablaresultadoTitle">
		  <td width="1%" align="left" valign="top"><img src="[% themelang %]/images/izquierda.png"></td>
		  <td  valign="middle" height="24"><b>Registro de Documento</b> [% id1 %]</td>
		  <td width="1%" valign="top" align="right"><img src="[% themelang %]/images/derecha.png"></td>
	</tr>
</table>

<div class="detalle">
	<a href="agregarDocumento.pl?id1=[% id1 %]&tipoAccion=MODIFICAR_NIVEL_1">
	<input 	type="image" name="submit" value="modify" border="0"  src="[% themelang %]/images/editar.png" border=0 title="Editar Nivel 1">
	</a>

	<input TYPE="image" name="delete"  VALUE="delete" BORDER=0 src="[% themelang %]/images/borrar.png"   onClick="if (window.confirm('&#191;Est&aacute; seguro que desea borrarlo?')) {borrarNivel1([% id1 %]);} else {return false;}" title="Borrar Nivel 1">
	<br>
	[% FOREACH nivel1 %]

		[% IF liblibrarian %]
			[% IF dato %]
				[% liblibrarian %]: <b>[% dato %]</b><br>
			[% END %]
		[% END %]

	[% END %]
	<hr>
	N&uacute;mero Total de Ejemplares:<b> [% cantItemN1 %]</b> 
</div>

[% FOREACH nivel2 %]

<div id="grupo[% id2 %]">
	<div>
		<p style="font-size: 11pt" align="center" class="tablaresultadoTitle">
				[% id2 %] GRUPO - [% tipo_documento %]
			</p>
	</div>

<div class="detalle">
<!-- NIVEL 2 -->
	<div id="[% id2 %]" style="position: relative; float:right;"></div>
	
	<a href="agregarDocumento.pl?id1=[% id1 %]&id2=[% id2 %]&tipoAccion=MODIFICAR_NIVEL_2">
	<input 	type="image" name="submit" value="modify" border="0"  src="[% themelang %]/images/editar.png" title="Editar Nivel 2">	
	</a>

	<input 	TYPE="image" name="delete"  VALUE="delete" BORDER=0 src="[% themelang %]/images/borrar.png"   
			onClick="if (window.confirm('&#191;Est&aacute; seguro que desea borrarlo?')) {borrarGrupo([% id1 %],[% id2 %]);} else {return false;}" 
			title="Borrar Grupo">
	<br>
	[% IF amazon_cover %]
		<div class='amazon_cover_detail' style="position: relative; float:right;">
				<img name="cover"  VALUE="" BORDER=0 src="[% themelang %]/[% lang %]/[% amazon_cover %]" title="Tapa" >
		</div>
		<br>
	[% END %]

	[% FOREACH nivel2_array %]
		
			[% IF liblibrarian %]
				[% IF dato %]
					[% liblibrarian %]: <b>[% dato %]</b><br>
				[% END %]
			[% END %]

	[% END %]<!-- END FOREACH nivel2_array -->

	[% IF cantItems %]
		Cantidad de Items: [% cantItems %]<br>
	[% END %]
		
	<hr>
		Ejemplares Disponibles:<b> [% disponibles %]</b><br>
		Reservas Realizadas: <b> [% cantReservas %]</b><br>
		Reservas en Espera: <b> [% cantReservasEnEspera %]</b><br>
		Ejemplares Prestados:<b> [% cantPrestados %]</b><br>
	<hr>
	<div id="ejemplaresDelGrupo[% id2 %]" >
		

	<table cellspacing="0" cellpadding="0"  width="100%" class="tablaResult" width="100%">
		<tr align="center" cellpadding="0"  valign="middle" class="tablaresultadoTitle">

				<td width="1%" align="left" valign="top"><img src="[% themelang %]/images/izquierda.png">
				</td>
				<td colspan="2" >
					<b>Edici&oacute;n</b>
					<a href="agregarDocumento.pl?id1=[% id1 %]&id2=[% id2 %]&id3=[% id3 %]&tipoAccion=MODIFICAR_NIVEL_3">
						<input TYPE="image" name="submit"  VALUE="modificar" src="[% themelang %]/images/editar.png" title="Editar Todos">
					</a>
				</td>
				<td><b>Sig. Top.</b> </td>
					<td><b>C&oacute;digo</b></td>
					<td><b>Disponibilidad</b></td>
					<td><b>Vencimiento</b></td>
				<td width="20%"  colspan="2"><b>Circulaci&oacute;n</b></td>
				<td>MARC</td>
				<td width="1%" align="right" valign="top"><img src="[% themelang %]/images/derecha.png"></td>
			
		</tr>
							
[% FOREACH nivel3 %]
		<tr align="center">
			<td width="10%" colspan="2" valign="middle" height="25">
<!-- 			 IF sePuedeEditar  -->
				<a href="agregarDocumento.pl?id1=[% id1 %]&id2=[% id2 %]&id3=[% id3 %]&tipoAccion=MODIFICAR_NIVEL_3">
				<input TYPE="image" name="submit"  VALUE="modify" src="[% themelang %]/images/editar.png" title="Editar Ejemplar">
				</a>
<!-- 			END  -->
			</td>
			<td width="6%" valign="middle">
<!-- 			IF sePuedeBorrar -->
				<input TYPE="image" name="delete"  VALUE="delete" src="[% themelang %]/images/borrar.png" 
				onClick="borrarN3('[% id2 %]','[% id3 %]')" title="Borrar Ejemplar">
<!-- 			END  -->
			</td>
			<td>[% nivel3_array.getSignatura_topografica %]</td>
			<td>
				<a href='/cgi-bin/koha/busquedas/detalleItem.pl?id1=[% id1 %]&id2=[% id2 %]&id3=[% id3 %]&barcode=[% barcode %]&signatura_topografica=[% signatura_topografica %]' title='Detalle de disponibilidad'>
						[% nivel3_array.getBarcode %]
				</a>
			</td>
			<td>
				<span class="[% clase %]">
				[% nivel3_array.ref_disponibilidad.getNombre %]
			[% IF usuario %]
				<b>[% usuario %]</b>
			[% END %]
				</span>
			</td>
			<td>
				<span class="[% claseFecha %]">
					[% IF vencimiento %]
						[% vencimiento %]
					[% ELSE %]
						-------
					[% END %]
				</span>
			</td>
			<td valign="middle" colspan="2">
			[% IF prestado %]

				<input type="image" src="[% themelang %]/images/item-return.png" title="Devolver" 
					onClick="devolver('DEVOLUCION','[% nro_socio %]','[% usuarioNombre %]','[% id2 %]','[% id3 %]')">
				[% IF renew %]
					<input type="image" src="[% themelang %]/images/renew.png" title="Renovar" 
							onClick="renovar('RENOVACION','[% nro_socio %]','[% usuarioNombre %]','[% id2 %]','[% id3 %]')">
				[% END %]
			[% ELSE %]
				<input type="image" src="[% themelang %]/images/item-prestar.png" title="Realizar pr&eacute;stamo" 
						onClick="buscarUsuario('[% id2 %]','[% id3 %]');">
			[% END %]
			</td>
		
			<td colspan="2">
				<input TYPE="image" name="marc"  VALUE="detalle MARC" src="[% themelang %]/images/MARC.png" title="Detalle MARC" 
						onClick="detalleMARC('[% id3 %]')">
			</td>
		</tr>
[% END %]<!-- END FOREACH NIVEL 3 -->
	
	</table>
			<br><hr class="lineagruesa"><br>
			
		</div> <!--end <div id="ejemplaresDelGrupo -->
	</div>

</div> <!--Fin <div id="grupo TMPL_VAR NAME='id2'-->

[% END %]<!-- END FOREACH Nivel 2-->

</div> <!-- Fin DIV detalleComun -->

[% INCLUDE "intranet-bottom.inc" %]
