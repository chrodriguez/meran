[% INCLUDE "intranet-top.inc" %] 


<script type="text/javascript">
      TYPE_FILE= "picture";
</script>

<script type="text/javascript" src="/intranet-tmpl/includes/circulacion-min.js"></script>
<script type="text/javascript" src="/intranet-tmpl/includes/usuarios/usuariosReales-min.js"></script>
<script type="text/javascript" src="/includes/jquery/jquery.fileUploader-min.js"></script>
<script type="text/javascript" src="/includes/jquery/jquery.livequery-min.js"></script>

[% INCLUDE "WindowHelper.inc" %] 
[% INCLUDE "ChangePasswordHelper.inc"  %]

<script type="text/javascript">

var objAH;
NRO_SOCIO_AUTH = '[% nro_socio %]';

//*************************************Para manejar el historial de prestamos***********************************
function ordenar(orden){
	objAH.sort(orden);
}

function changePage(ini){
	objAH.changePage(ini);
}

function mostrarHistorialDePrestamos(){
	objAH               = new AjaxHelper(updateMostrarHistorialDePrestamos);
	objAH.debug         = true;
    objAH.cache         = true;
    objAH.showOverlay   = true;
	objAH.url=URL_PREFIX+'/usuarios/reales/historialPrestamos.pl';
	objAH.nro_socio     = USUARIO.ID;
	objAH.funcion       = 'changePage';
	objAH.sendToServer();
}

function updateMostrarHistorialDePrestamos(responseText){
	$('#historialPrestamos').html(responseText);
	zebra('tablaHistorialPrestamos');
	$.scrollTo('#historialPrestamos');
}

function mostrarHistorialDeReservas(){
    objAH               = new AjaxHelper(updateMostrarHistorialDeReservas);
    objAH.debug         = true;
    objAH.cache         = true;
    objAH.showOverlay   = true;
    objAH.url=URL_PREFIX+'/usuarios/reales/historialReservas.pl';
    objAH.nro_socio     = USUARIO.ID;
    objAH.funcion       = 'changePage';
    objAH.sendToServer();
}

function updateMostrarHistorialDeReservas(responseText){
    $('#historialReservas').html(responseText);
    zebra('tablaHistorialReservas');
    $.scrollTo('#historialReseravs');
}

//*******************************Fin Para manejar el historial de prestamos************************************

//*************************************Para manejar el historial de sanciones***********************************

function mostrarHistorialDeSanciones(){
    objAH               = new AjaxHelper(updateMostrarHistorialDeSanciones);
    objAH.debug         = true;
    objAH.cache         = true;
    objAH.showOverlay   = true;
    objAH.url=URL_PREFIX+'/usuarios/reales/historialSanciones.pl';
    objAH.nro_socio     = USUARIO.ID;
    objAH.funcion       = 'changePage';
    objAH.sendToServer();
}

function updateMostrarHistorialDeSanciones(responseText){
    $('#historialSanciones').html(responseText);
    zebra('tablaHistorialSanciones');
    $.scrollTo('#historialSanciones');
}


//*******************************Fin Para manejar el historial de sanciones************************************

//************************************Para manejar la circulacion**********************************************
//REDEFINIDO, se encuentra en circulacion.js
function updateInfoRenovar(responseText){
	//jAlert("ejecuto updateInfoRenovar LOCAL!!!");
	cancelarDiv();

	var infoHash= JSONstring.toObject(responseText);
	var messageArray= infoHash.messages;
	var ticketsArray= infoHash.tickets;
	
	var mensajes= '';
	for(i=0; i<messageArray.length;i++){
		imprimirTicket(ticketsArray[i].ticket,i);
  		setMessages(messageArray[i]);
	}

	detallePrestamos(USUARIO.ID);
	//puede que llegue al  max de prestamos y se cancelen las reservas
	detalleReservas(USUARIO.ID);
	//puede que luego de devolver el usuario sea sancionado
	detalleSanciones(USUARIO.ID);
}

//REDEFINIDO, se encuentra en circulacion.js, se llama luego de realizar un prestamo
function updateInfoPrestarReserva(responseText){
// 	jAlert("ejecuto updateInfoPrestarReserva LOCAL!!!");
	cancelarDiv();
// 	/*clearMessages*/();

	var infoHash= JSONstring.toObject(responseText);
	var messageArray= infoHash.messages;
	var ticketsArray= infoHash.tickets;
	var mensajes= '';
	for(var i=0; i<messageArray.length;i++){
		imprimirTicket(ticketsArray[i].ticket,i);
  		setMessages(messageArray[i]);
	}

	detalleReservas(USUARIO.ID);
	detallePrestamos(USUARIO.ID);
    //puede que el usuario este sancionado
    detalleSanciones(USUARIO.ID);
}


//REDEFINIDO, se ejecuta cancelarReserva de circulacion.js y luego se ejecuta esta funcion
function updateInfoCancelacion(responseText){

	var Messages=JSONstring.toObject(responseText);
	setMessages(Messages);
	detalleReservas(USUARIO.ID);
}

function detalleUsuario(){
	objAH               = new AjaxHelper(updateDetalleUsuario);
	objAH.url=URL_PREFIX+'/usuarios/reales/detalleUsuario.pl';
	objAH.debug         = true;
    objAH.showOverlay   = true;
	objAH.nro_socio     = USUARIO.ID;
	objAH.sendToServer();
}

function updateDetalleUsuario(responseText){
    if (!verificarRespuesta(responseText))
            return(0);
    $('#detalleUsuario').html(responseText);
    detalleReservas(USUARIO.ID);
}

function prestamosInterBibliotecarios(){
    objAH               = new AjaxHelper(updatePrestamosInterBibliotecarios);
    objAH.url=URL_PREFIX+'/usuarios/reales/usuariosRealesDB.pl';
    objAH.debug         = true;
    objAH.showOverlay   = true;
    objAH.nro_socio     = USUARIO.ID;
    objAH.tipoAccion    = 'PRESTAMO_INTER_BIBLIO';
    objAH.sendToServer();
}

function updatePrestamosInterBibliotecarios(responseText){
//se crea el objeto que maneja la ventana para modificar los datos del usuario
    if (!verificarRespuesta(responseText))
        return(0);
//     vPrestamoInterBibliotecario=new WindowHelper({draggable: true, opacity: true});
//     vPrestamoInterBibliotecario.html=responseText;
//     vPrestamoInterBibliotecario.titulo= PRESTAMO_INTER_BIBLIO;
//     vPrestamoInterBibliotecario.create();
//     vPrestamoInterBibliotecario.height('420px');
//     vPrestamoInterBibliotecario.width('650px');
//     vPrestamoInterBibliotecario.open();

    $('#basic-modal-content').html(responseText);
    $('#basic-modal-content').modal({   containerCss:{
            backgroundColor:"#fff",
    //         borderColor:"#0063dc",
            height:420,
            padding:0,
            width:650
        },
    });
}


function generarLibreDeuda(){
    objAH               = new AjaxHelper(updateGenerarLibreDeuda);
    objAH.url=URL_PREFIX+'/usuarios/reales/usuariosRealesDB.pl';
    objAH.debug         = true;
    objAH.showOverlay   = true;
    objAH.nro_socio     = USUARIO.ID;
    objAH.tipoAccion    = 'GENERAR_LIBRE_DEUDA';
    objAH.sendToServer();
}

function updateGenerarLibreDeuda(responseText){

    if (!verificarRespuesta(responseText))
        return(0);

    var Messages=JSONstring.toObject(responseText);
    if(Messages){
        setMessages(Messages);
    }
}

function createFileUploader(){
	if($("#uploader")[0] != null){

      
		$("#uploader").fileUploader({
						// perl script
                        file_types: "jpg",
						ajaxFile: "uploadPicture.pl",
						nro_socio: USUARIO.ID,
                        type_file: "foto",
                        uploadFolder: "/ajaxMultiFileUpload/upload/",
						funcionOnComplete: function (){
                                    onCompleteFileUpload(USUARIO.ID);
								}
		});

	}
}

function onCompleteFileUpload(){
    $('#foto').html("<img border='0' width='96px' height='96px' title='" + USUARIO.text + "(" + USUARIO.ID + ")' alt='" + USUARIO.text + "(" + USUARIO.ID + ")' src='[% themelang %]/pictures/" + USUARIO.ID + ".jpg'>");
    $('#div_uploader').hide();
    $('#fake_file').val('');
    $('#div_boton_eliminar_foto').show();
}

function detallePrestamos(socio){

	objAH               = new AjaxHelper(updateDetallePrestamos);
	objAH.url=URL_PREFIX+'/usuarios/reales/detallePrestamos.pl';
    objAH.showOverlay   = true;
	objAH.nro_socio     = socio;
	objAH.sendToServer();
}

function updateDetallePrestamos(responseText){
	$('#prestamos').html(responseText);
	zebra('prestamosResult');
	checkedAll('checkAllPrestamos','chkboxPrestamos');	
	detalleSanciones(USUARIO.ID);
}

function detalleReservas(socio){

	objAH               = new AjaxHelper(updateDetalleReservas);
	objAH.url=URL_PREFIX+'/usuarios/reales/detalleReservas.pl';
    objAH.showOverlay   = true;
	objAH.nro_socio     = socio;
	objAH.sendToServer();
}


function updateDetalleReservas(responseText){
	$('#reservas').html(responseText);
	zebra('reseravsAsignadasResult');
	zebra('reservasEnEsperaResult');
	checkedAll('checkAllReservas','chkboxReservas');
	detallePrestamos(USUARIO.ID);
}

function updateInfoDevolver(responseText){
	cancelarDiv();
    if (!verificarRespuesta(responseText))
        return(0);

	var infoHash= JSONstring.toObject(responseText);
	var messageArray= infoHash.Messages_arrayref;
	setMessages(messageArray);

	detallePrestamos(USUARIO.ID);
	detalleReservas(USUARIO.ID);
	//puede que luego de devolver el usuario sea sancionado
	detalleSanciones(USUARIO.ID);
}


function detalleSanciones(socio){

    objAH               = new AjaxHelper(updateDetalleSanciones);
    objAH.showOverlay   = true;
    objAH.url=URL_PREFIX+'/usuarios/reales/detalleSanciones.pl';
    objAH.nro_socio     = socio;
    objAH.sendToServer();
}

function updateDetalleSanciones(responseText){
    $('#sanciones').html(responseText);
}
//**********************************Fin**Para manejar la circulacion********************************************

$(document).ready(function(){
	
	//definido en circulacion.js
	USUARIO         = new objeto_usuario();
	USUARIO.text    = "[% socio_modificar.persona.getApeYNom %]";
    USUARIO.ID      = '[% socio_modificar.getNro_socio %]';
	detalleUsuario();

    makeToggle('toggle_container_block','trigger1',mostrarHistorialDePrestamos, 'historialPrestamos',true);
    makeToggle('toggle_container_block','trigger2',mostrarHistorialDeSanciones, 'historialSanciones',true);
    makeToggle('toggle_container_block','trigger3',mostrarHistorialDeReservas, 'historialReservas',true);
});

</script>

    <div id="confirmar_div"></div>

<div id="resultBusqueda">
	<!-- 	DETALLE USUARIO -->
	<div id="detalleUsuario"></div>
		
	<!--DETALLE DE PRESTAMOS-->
	<div id="prestamos"></div>
	
	<!-- DETALLE DE RESERVAS -->
	<div id="reservas"></div>
	
	<!-- DETALLE DE SANCIONES -->
	<div id="sanciones"></div>

    <div>
        <fieldset>
            <legend class="titulo_legend_resaltado trigger1 click titulo_legend" title='[% "click para acceder al Historial de Pr&eacute;stamos" | i18n %]'>
                            [% "Historial de Pr&eacute;stamos" | i18n %]
            </legend>
	        <!-- DETALLE DEL HISTORICO DE PRESTAMOS DEL USUARIO -->
	        <div id="historialPrestamos" class="toggle_container_block" style="display:none"></div>
        </fieldset>
    </div>

    <div>
        <fieldset>
            <legend class="titulo_legend_resaltado trigger3 click titulo_legend" title='[% "click para acceder al Historial de Reservas" | i18n %]'>
                            [% "Historial de Reservas" | i18n %]
            </legend>   
            <!-- DETALLE DEL HISTORICO DE RESERVAS DEL USUARIO -->
            <div id="historialReservas" class="toggle_container_block" style="display:none"></div>
        </fieldset>
    </div>

    <div>
        <fieldset>
            <legend class="titulo_legend_resaltado trigger2 click titulo_legend" title='[% "click para acceder al Historial de Reservas" | i18n %]'>
                            [% "Historial de Sanciones" | i18n %]
            </legend>   
            <!-- DETALLE DEL HISTORICO DE SANCIONES DEL USUARIO -->
            <div id="historialSanciones" class="toggle_container_block" style="display:none"></div>
        </fieldset>
    </div>
</div>

[% INCLUDE "intranet-bottom.inc" %]
