[% INCLUDE "intranet-top.inc" %]

<script src="/intranet-tmpl/blue/includes/jquery/jquery.bgiframe.min.js"></script>
<script src="/intranet-tmpl/blue/includes/jquery/jquery.dimensions.js"></script>
<script src="/intranet-tmpl/blue/includes/jquery/ui.core.js"></script>
<script src="/intranet-tmpl/blue/includes/jquery/ui.draggable.js"></script>
<script src="/intranet-tmpl/blue/includes/jquery/ui.draggable.ext.js"></script>
<script src="/intranet-tmpl/blue/includes/jquery/ui.mouse.js"></script>

<script>
// ********************************************REVISADO***************************************************

//Arreglos globales de objetos
//arreglo de objetos campo
CAMPOS_ARRAY= new Array();
//arreglo de objetos subcampo
SUBCAMPOS_ARRAY= new Array();

function inicializar(){
    //arreglo de objetos campo
    CAMPOS_ARRAY= new Array();
    //arreglo de objetos subcampo
    SUBCAMPOS_ARRAY= new Array();
    $("#resultAgregarCampo").html('');
}

function ordenar(orden){
    objAH.sort(orden);
}

function changePage(ini){
    objAH.changePage(ini);
}

//Muestra lo catalogado seguen el nivel y el tipo de item seleccionado (nivel > 1)
function eleccionDeNivel(){
	var nivel=$("#nivel").val();
	var ObjDiv = $("#divitemtype");
	if((nivel == '1') || (nivel == 'Niveles')){ObjDiv.hide();}
	else{ObjDiv.show();}
	
	objAH=new AjaxHelper(updateEleccionDeNivel);
    objAH.debug= true;
	objAH.url="/cgi-bin/koha/catalogacion/estructura/nuevo/estructuraCataloDB.pl";
	objAH.nivel=nivel;
    objAH.tipoAccion= 'MOSTRAR_CAMPOS';
	objAH.itemtype=$('#tipo_nivel3_id').val();
	objAH.sendToServer();

}

function updateEleccionDeNivel(responseText){
    $("#resultCatalogacion").html(responseText);
    zebra("tablaResult");
}

function modificarOrden(id, accion){
    objAH=new AjaxHelper(eleccionDeNivel);
    objAH.debug= true;
    objAH.url="/cgi-bin/koha/catalogacion/estructura/nuevo/estructuraCataloDB.pl";
    objAH.idMod=id;
    objAH.tipoAccion= accion; //SUBIR_ORDEN, BAJAR_ORDEN
    objAH.sendToServer();
}

function visibilidad(id){
    objAH=new AjaxHelper(eleccionDeNivel);
    objAH.debug= true;
    objAH.url="/cgi-bin/koha/catalogacion/estructura/nuevo/estructuraCataloDB.pl";
    objAH.id=id;
    objAH.tipoAccion= 'CAMBIAR_VISIBILIDAD';
    objAH.sendToServer();
}

//Elimina el campo en la estructura inicial del catalogo
function eliminarCampo(id){
    objAH=new AjaxHelper(eleccionDeNivel);
    objAH.debug= true;
    objAH.url="/cgi-bin/koha/catalogacion/estructura/nuevo/estructuraCataloDB.pl";
    objAH.idMod=id;
    objAH.tipoAccion= 'ELIMINAR_CAMPO';
    objAH.sendToServer();
}

function mostrarAgregarCampo(){
    $("#modificar").hide();
    objAH=new AjaxHelper(updateMostrarAgregarCampo);
    objAH.url="/cgi-bin/koha/catalogacion/estructura/nuevo/estructuraCataloDB.pl";
    objAH.tipoAccion="MOSTRAR_FORM_AGREGAR_CAMPOS";
    objAH.sendToServer();
}

function updateMostrarAgregarCampo(responseText){
    $("#resultAgregarCampo").show();
    $("#resultAgregarCampo").html(responseText);
    scrollTo('resultAgregarCampo');
    enable_disableSelects();

}

function cancelarEstructuraCatalogacion(){
    $("#resultAgregarCampo").slideUp('slow');
    //y borrar variables, objetos y arrays
    inicializar();
}   

function mostrarTablaRef(){
    objAH=new AjaxHelper(updateMostrarTablaRef);
    objAH.debug= true;
    objAH.url="/cgi-bin/koha/catalogacion/estructura/nuevo/estructuraCataloDB.pl";
    objAH.tipoAccion="GENERAR_ARREGLO_TABLA_REF";
    objAH.sendToServer();
}

function updateMostrarTablaRef(responseText){
    var tablaRef_array=JSONstring.toObject(responseText);
    //se inicializa el combo
    $("#tablaRef").html('');
    var options = "<option value='-1'>Seleccionar Tabla Ref</option>";
    
    for (x=0;x < tablaRef_array.length;x++){
         options+= "<option value=" + tablaRef_array[x].referencia +" >" + tablaRef_array[x].referencia + "</option>";
    }
    $("#tablaRef").append(options);
    enable_disableSelects();
}

/*
 * eleccionCampoX
 * Funcion que se ejecuta cuando se selecciona un valor del combo campoX (ej. 1xx), y hace un llamado a la 
 * funcion que ejecuta el ajax, con los parametros correspondiente a la accion realizada.
 */
function eleccionCampoX(){
    if ( $("#campoX").val() != -1){
        objAH=new AjaxHelper(updateEleccionCampoX);
        objAH.url="/cgi-bin/koha/catalogacion/estructura/nuevo/estructuraCataloDB.pl";
        objAH.campoX=$('#campoX').val();
        objAH.nivel=$('#nivel').val();
        objAH.tipoAccion="GENERAR_ARREGLO_CAMPOS";
        objAH.sendToServer();
    }
    else
        enable_disableSelects();

}

//se genera el combo en el cliente
function updateEleccionCampoX(responseText){
    //Arreglo de Objetos Global
    var campos_array=JSONstring.toObject(responseText);
    //se inicializa el combo
    $("#campo").html('')
    var options = "<option value='-1'>Seleccionar CampoX</option>";
    
    for (x=0;x < campos_array.length;x++){
         CAMPOS_ARRAY[campos_array[x].tagfield]= $.trim(campos_array[x].liblibrarian);   
         options+= "<option value=" + campos_array[x].tagfield +" >" + campos_array[x].tagfield + "</option>";
    }
    $("#campo").append(options);
    //se agrega la info al combo
    enable_disableSelects();

}

function eleccionCampo(){
    if ($("#campo").val() != -1){
        objAH=new AjaxHelper(updateEleccionCampo);
        objAH.debug= true;
        objAH.url="/cgi-bin/koha/catalogacion/estructura/nuevo/estructuraCataloDB.pl";
        objAH.campo=$('#campo').val();
        objAH.nivel=$('#nivel').val();
        objAH.tipoAccion="GENERAR_ARREGLO_SUBCAMPOS";
        objAH.sendToServer();
    }
    else
        enable_disableSelects();

}


//se genera el combo en el cliente
function updateEleccionCampo(responseText){
    $('#nombre_campo').html(CAMPOS_ARRAY[$("#campo").val()]);
    //Arreglo de Objetos Global
    var subcampos_array=JSONstring.toObject(responseText);
    //se inicializa el combo
    $("#subcampo").html('');
    var options = "<option value='-1'>Seleccionar SubCampo</option>";
    
    for (x=0;x < subcampos_array.length;x++){
         SUBCAMPOS_ARRAY[ subcampos_array[x].tagsubfield ]= $.trim(subcampos_array[x].liblibrarian);
         options+= "<option value=" + subcampos_array[x].tagsubfield +" >" + subcampos_array[x].tagsubfield + "</option>";
    }
    //se agrega la info al combo
    $("#subcampo").append(options);
    enable_disableSelects();
}


function enable_disableSelects(){
    $("#campo").removeAttr('disabled');
    $("#subcampo").removeAttr('disabled');
    $("#tablaRef").removeAttr('disabled');
    $("#tipoInput").removeAttr('disabled');
    if ( $('#campoX').val() == -1){
         $("#campo").attr('disabled',true);
         $("#subcampo").attr('disabled',true);
         $("#tablaRef").attr('disabled',true);
         $("#tipoInput").attr('disabled',true);
    }
    else
      if ( $('#campo').val() == -1){
         $("#subcampo").attr('disabled',true);
         $("#tablaRef").attr('disabled',true);
         $("#tipoInput").attr('disabled',true);
      }
    else
       if ( $('#subcampo').val() == -1){
         $("#tablaRef").attr('disabled',true);
         $("#tipoInput").attr('disabled',true);
        }
    else
      if ( $('#tablaRef').val() == -1){
         $("#tipoInput").attr('disabled',true);
       }
}


function armarComboCampos()(){
    objAH=new AjaxHelper(updateEleccionCampo);
    objAH.debug= true;
    objAH.url="/cgi-bin/koha/catalogacion/estructura/nuevo/estructuraCataloDB.pl";
    objAH.tabla=$('#tablaRef').val();
    objAH.tipoAccion="GENERAR_ARREGLO_CAMPOS_REFERENCIA";
    objAH.sendToServer();
}

function updateArmarComboCampos(){
    //Arreglo de Objetos Global
    var camposSelect_array=JSONstring.toObject(responseText);
    //se inicializa el combo
    $("#camposSelect").html('');
    var options = "<option value='-1'>Seleccionar SubCampo</option>";
    var joinedFields = "";
    for (x=0;x < camposSelect_array.length;x++){
         joinedFields+= camposSelect_array[x]+", ";
         options+= "<option value=" + camposSelect_array[x] +" >" + camposSelect_array[x] + "</option>";
    }
    //se agrega la info al combo
    $("#camposSelect").append(options);
    enable_disableSelects();
}

function eleccionTablaRef(){

    armarComboCampos();
    enable_disableSelects();

}

function eleccionSubCampo(){

    if ($('#subcampo').val() != -1){
        $('#liblibrarian').val(SUBCAMPOS_ARRAY[$('#subcampo').val()]);
        mostrarTablaRef();
    }
    else 
        enable_disableSelects();
}


/*
 * agregarEstructuraCatalogacion
 */
function agregarEstructuraCatalogacion(){ 
    objAH=new AjaxHelper(updateAgregarEstructuraCatalogacion);
    objAH.debug= true;
    objAH.url="/cgi-bin/koha/catalogacion/estructura/nuevo/estructuraCataloDB.pl";
    objAH.nivel= $('#nivel').val();
    objAH.itemtype= $('#tipo_nivel3_id').val();
    objAH.campo= $('#campo').val();
    objAH.subcampo= $('#subcampo').val();
    objAH.liblibrarian= $('#liblibrarian').val();
    objAH.tipoInput= $('#tipoInput').val();
    objAH.tabla= $('#tabla').val();
    objAH.referencia= $('#referencia').val();
//     objAH.varios= $('#nivel').val();
    objAH.tipoAccion= "GUARDAR_ESTRUCTURA_CATALOGACION";
    objAH.sendToServer();
}

function updateAgregarEstructuraCatalogacion(responseText){
    var Messages=JSONstring.toObject(responseText);
    setMessages(Messages);
    if (! (hayError(Messages) ) ){
        eleccionDeNivel();
        inicializar();
    }
}


function abrirVentanaHelperMARC(){
    objAH=new AjaxHelper(updateAbrirVentanaHelperMARC);
    objAH.url='/intranet-tmpl/blue/includes/popups/helpCamposMARC.inc';
    objAH.debug= true;
    objAH.sendToServer();
}

function updateAbrirVentanaHelperMARC(responseText){
//se crea el objeto que maneja la ventana para modificar los/cgi-bin/koha/usuarios/reales/usuariosRealesDB.pl' datos del usuario
    vHelperMARC=new WindowHelper({draggable: false, opacity: true});
    vHelperMARC.debug= true;
    vHelperMARC.html=responseText;
    vHelperMARC.titulo= 'Ayuda campos MARC';
    vHelperMARC.draggable= true;
    vHelperMARC.create(); 
    vHelperMARC.dimmer_On= false;
    vHelperMARC.height('60%');
    vHelperMARC.width('50%');
    vHelperMARC.open();
}

// ********************************************FIN REVISADO***************************************************




function objetoRespuesta(campo,subcampo,lib,tipo,oblig,tabla){
	this.campo=campo;
	this.subcampo=subcampo;
	this.lib=lib;
	this.tipoInput=tipo;
	this.obligatorio=oblig;
	this.tabla=tabla;
	this.orden="";
	this.camposRef="";
	this.separador="";
}

function guardarCamposModificados(accion){

	var objeto=new objetoRespuesta($('#tagField').val(),$('#subcampo').val(),$('#lib').val(),$('#tipoInput').val(),$('#obligatorio').val(),$('#tabla').val());
	if ($('#tabla').val() != -1){
		objeto.orden=$('#orden').val();
		objeto.camposRef=$('#camposRef').val();
		objeto.separador=$('#separador').val();
	}

	objAH=new AjaxHelper(updateInfoEstrCatalogo);//La funcion y el objeto estan en seleccionCamposMarc.js
	objAH.url="/cgi-bin/koha/catalogacion/estructura/estructuraCataloResults.pl";
	objAH.nivel=$('#nivel').val();
	objAH.itemtype=$('#tipo_nivel3_id').val();
	objAH.objeto=objeto;
	objAH.accion=accion;
	objAH.sendToServer();
	$("#result").html("");
}

function guardarModificaciones(accion){
	objAH=new AjaxHelper(updateInfoEstrCatalogo);//La funcion y el objeto estan en seleccionCamposMarc.js
	objAH.url="/cgi-bin/koha/catalogacion/estructura/estructuraCataloResults.pl";
	objAH.nivel=$('#nivel').val();
	objAH.itemtype=$('#tipo_nivel3_id').val();
	objAH.idMod=$('#idMod').val();
	objAH.accion=accion;
	
	var objeto=new objetoRespuesta($('#campoMod').val(),$('#subcampoMod').val(),$('#textoMod').val(),$('#selectTipo').val(),"",$('#tablaMod').val());
	if($('#tablaMod').val() != -1){
		objAH.idinforef=$('#idinforef').val();
		objeto.orden=$('#ordenMod').val();
		objeto.camposRef=$('#camposRefMod').val();
		objeto.separador=$('#separadorMod').val();
	}
	objAH.objeto=objeto;
	objAH.sendToServer();
}

function editarCampo(id,accion){
	$("#result").html("");
	$('#idMod').val(id);
	
	objAH=new AjaxHelper(updateInfoEstrCatalogo);//La funcion y el objeto estan en seleccionCamposMarc.js
	objAH.url="/cgi-bin/koha/catalogacion/estructura/estructuraCataloResults.pl";
	objAH.nivel=$('#nivel').val();
	objAH.itemtype=$('#tipo_nivel3_id').val();
	objAH.idMod=id;
	objAH.accion=accion;
	objAH.sendToServer();
}



</script>
<div style="text-align: right;"><span class="click" onClick="abrirVentanaHelperMARC();">Ayuda MARC</span></div>
<table width="100%"  border="0" cellpadding="0" cellspacing="0" align="center">
	<tr>
		<td class="pagetitle" >Modificaci&oacute;n de campos MARC </td>
	</tr>
	<tr>	
		<td class="lineagruesa"  align="left" colspan="3"></td>
	</tr>

</table>

<br><br>
<label for="nivel" style="float: left; width:13%" >
	Nivel:
</label>
[% selectNivel %]


<div id="divitemtype" style="display:none;">

    <p>
    <label for="itemtype" style="float: left; width:13%;">
	    Tipo de item: 
    </label>
    [% selectItemType %]
    </p>

</div>

<!-- estos dos no se si usan -->
<div id= "result2"></div>
<div id= "result"></div>

<!-- PARA MOSTRAR TEMPLATE PARA AGREGAR CAMPOS -->
<div id= "resultAgregarCampo"></div>
<!-- PARA MOSTRAR LO CATALOGADO -->
<div id= "resultCatalogacion"></div>

[% INCLUDE "intranet-bottom.inc" %]

