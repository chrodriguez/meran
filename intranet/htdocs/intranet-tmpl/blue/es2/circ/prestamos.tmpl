<!-- TMPL_INCLUDE NAME="intranet-top.inc" -->

<script src="/intranet-tmpl/blue/es2/includes/jquery/jquery.js"></script>
<script src="/intranet-tmpl/blue/es2/includes/SearchHelper.js"></script>
<script src="/intranet-tmpl/blue/es2/includes/json/jsonStringify.js"></script>
<script src="/intranet-tmpl/blue/es2/includes/state.js"></script>
<script src="/intranet-tmpl/blue/es2/includes/util.js"></script>

<script src="/intranet-tmpl/blue/es2/includes/jquery/jquery.bgiframe.min.js"></script>
<script src="/intranet-tmpl/blue/es2/includes/jquery/jquery.dimensions.js"></script>
<script src="/intranet-tmpl/blue/es2/includes/jquery/ui.mouse.js"></script>
<script src="/intranet-tmpl/blue/es2/includes/jquery/jquery.autocomplete.js"></script>
<link href="/intranet-tmpl/blue/es2/includes/jquery/jquery.autocomplete.css" type="text/css" rel="stylesheet">


<script language="javascript" type="text/javascript">


//*********************************************Prestamos******************************************
function itemPrestamo(){
	this.id3= '';
	this.id3Old= '';
	this.barcode= '';
	this.tipoPrestamo= '';
}

function tipoPrestamo(){
	codPrestamo= '';
	descripcion= '';
}

function infoPrestamo(){
	this.id3= '';
	this.id3Old= '';
// 	this.titulo='';
// 	this.autor= '';
// 	this.unititle= '';
// 	this.edition= '';
	this.tipoPrestamo; //este es el tipo de prestamo para el id3
}

var infoPrestamos_array= new Array();

function generaComboPrestamo(responseText){
	
	infoArray= JSONstring.toObject(responseText);
// 	CAMBIAR TABLA POR ESTILOS!!!!!!!!!!!!!!!!!!!
	var html="<table width='95%' cellspacing='0' cellpadding='0' border='1' bgcolor='white' align='center'>";
	html= html + "<tr align='center'><td class='fontmsg'>";
	var i;
	

	for(i=0; i<infoArray.length;i++){
	
		var infoPrestamoObj= new infoPrestamo();
		infoPrestamoObj.id3Old= infoArray[i].id3Old;
// 		infoPrestamoObj.titulo= infoArray[i].titulo;
// 		infoPrestamoObj.autor= infoArray[i].autor;
// 		infoPrestamoObj.unititle= infoArray[i].unititle;
// 		infoPrestamoObj.edition= infoArray[i].edicion;
		infoPrestamos_array[i]= infoPrestamoObj;
 
		var comboItems =crearCombo(infoArray[i].items, 'comboItems' + i);
		var comboTipoPrestamo =crearCombo(infoArray[i].tipoPrestamo, 'tiposPrestamos' + i);
		
		html= html + infoArray[i].titulo + "<br>";
		html= html + infoArray[i].autor + "<br>";
		html= html + infoArray[i].unititle + "<br>";
		html= html + infoArray[i].edicion + "<br>";
		html= html + "C&oacute;digo de barras: " + comboItems + "<br>";
		html= html + "Tipo de pr&eacute;stamo: " + comboTipoPrestamo + "<br>";
	}

	html= html + "</td></tr></table>";
	html= html + "<center><input type='button' value='Aceptar' onClick='prestar()'><input type='button' value='Cancelar' onClick='cancelarPrestamo();'></center><br>"

	$('#confirmar_prestamos').html(html);

	HiddeState();
}

function cancelarPrestamo(){
	$('#confirmar_prestamos').html('');
}

function updateInfoPrestamo(){
	$('#confirmar_prestamos').html('');
	detalleReservas(usuario.ID);
}

function prestar(){
	

	for(var i=0; i< infoPrestamos_array.length; i++){
		//se setea el id3 que se va a prestar
		infoPrestamos_array[i].id3= $('#comboItems' + i).val();
		infoPrestamos_array[i].tipoPrestamo= $('#tiposPrestamos' + i).val();
	}
	
	objBusqueda=new SearchHelper(updateInfoPrestamo, Init);
	objBusqueda.url= '/cgi-bin/koha/circ/circulacionDB.pl';
	objBusqueda.tipoAccion= 'PRESTAMO';
	objBusqueda.infoPrestamos= infoPrestamos_array;
	objBusqueda.borrowernumber= usuario.ID;
	//se envia la consulta
	objBusqueda.sendToServer();
}

function crearCombo(items_array, idSelect){

	var opciones= '';	
	var html= "<select id='" + idSelect + "'>";
	var i;

	for(i=0;i<items_array.length;i++){

		opciones= opciones + "<option value=" + items_array[i].value + ">" + items_array[i].label + "</option>";

	}
	
	html= html + opciones + "</select>";
	return html;
}
//**********************************************FIN Prestamos*************************************



function object_usuario(){
	this.text;
	this.ID;
}

var objects_array= new Array();

function AutocompleteUsuario(idInput){
	// q= valor de campoHelp
	$("#"+idInput).search();
	$("#"+idInput).autocomplete('/cgi-bin/koha/autocompletables/usuarioAutocomplete.pl',{
 		formatItem: function(row){
			return row[0];
		},
		minChars:1,
        	matchSubset:1,
        	matchContains:1,
		maxItemsToShow:10,
        	cacheLength:10,
        	selectOnly:1,
	});//end autocomplete
	$("#"+idInput).result(function(event, data, formatted) {
		//muestro en el input el usuario seleccioinado
		$("#"+idInput).val(data[0]);
	
 		usuario= new object_usuario();
		usuario.text= data[0];
		usuario.ID= data[1];
		
		detalleUsuario(data[1]);
		detalleReservas(data[1]);
	});
}

function updateInfoUsuario(responseText){
	
	$('#detalleUsuario').slideDown('slow');
	$('#detalleUsuario').html(responseText);
	HiddeState();

}


function updateInfoReservas(responseText){
	
	$('#tablaReservas').slideDown('slow');
	$('#tablaReservas').html(responseText);
	zebra('tablaReservas');
	HiddeState();

}

var objBusqueda;

function detalleUsuario(borrower){

	objBusqueda=new SearchHelper(updateInfoUsuario, Init);
	objBusqueda.url= '/cgi-bin/koha/circ/detalleUsuario.pl';
	objBusqueda.borrowernumber= borrower;
	//se envia la consulta
	objBusqueda.sendToServer();
}

function detalleReservas(borrower){

	objBusqueda=new SearchHelper(updateInfoReservas, Init);
	objBusqueda.url= '/cgi-bin/koha/circ/detalleReservas.pl';
	objBusqueda.borrnumber= borrower;
	//se envia la consulta
	objBusqueda.sendToServer();
}


//**********************************************************************************************************

// IGUAL A LA DE devoluciones.tmpl (realizarDevORen), DISTINTA ACCION Y NOMBRE DE CHECKBOX!!!!!!!!!!!!!!!
// Recomiendo ponerla en un js con la de autocomplete de usuario y las otras tambien y limpiar algunas librerias.
function realizarPrestamo(){
	var chck=$("input[@name='chkbox2']:checked");
	var array= new Array;
	var long=chck.length;
	var borrowernumber=$("#borrowernumber").val();
	if ( long == 0){
		alert("Elija al menos un documento para prestar");
	}
	else{

		for(var i=0; i< long; i++){
			array[i]=chck[i].value;
		}
		objBusqueda=new SearchHelper(generaComboPrestamo, Init);
		objBusqueda.url= '/cgi-bin/koha/circ/circulacionDB.pl';
		objBusqueda.tipoAccion= 'CONFIRMAR_PRESTAMO';
		objBusqueda.ids3= array;
		objBusqueda.borrowernumber=borrowernumber;
		//se envia la consulta
		objBusqueda.sendToServer();
	}
}



function confirm_cancelation(tipoReserva){
	var is_confirmed = confirm('Esta seguro que desea cancelar la reserva?');
        if (is_confirmed) {
		var formu;
		if(tipoReserva == "espera"){
			formu=document.getElementById('resevEspera');
		}
		else{
			formu=document.getElementById('formPrestar');
		}
		formu.action="/cgi-bin/koha/cancelreserv.pl";
		formu.submit();
        }
}

function checkedAll(){
	var checks=document.getElementsByTagName("input");
	if (checks.length>0){
		for(i=0;i<checks.length;i++){
			if(checks[i].type == "checkbox"){
				if(checks[i].checked){checks[i].checked=false}
                   	 	else{checks[i].checked=true}
			}
		}
	}
}


// VER SI ESTO SE USA!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! 
//Selecciona los checkbox seleccionados por el usuario para devolver.
var stringCheckbox= '<!-- TMPL_VAR NAME="chkbox" -->';
var checkbox=stringCheckbox.split(",");
var cantChk= checkbox.length;
if(cantChk != 0 && stringCheckbox != ""){
	for (var i=0; i< checkbox.length; i++){
		var ch=document.getElementById(checkbox[i]);
        	ch.checked=true;	
	}
}

//**********************************************************************************************************


$(document).ready(function() {
	//se crea el autocomplete para buscar el usuario
	AutocompleteUsuario('usuarioAutocomplete');
});

</script>

<table width="100%"  border="0" cellpadding="0" cellspacing="0" align="center">
	<tr>
		<td class="pagetitle" >
			Pr&eacute;stamos
		</td>
	</tr>
	<tr>
		<td class="lineagruesa"  align="left" colspan="3"></td>
	</tr>
</table>

<div id="buscarUsuario">
	<table border="0" cellpadding="0" cellspacing="0"  align="center" width="100%">
		<tr class="tablaresultadoTitle">
			<td align="left" valign="top"><img src="<!-- TMPL_VAR NAME='interface' -->/<!-- TMPL_VAR name='theme' -->/images/izquierda.png">
			</td>
			<td>
				<b>Ingrese Apellido y Nombres, DNI o Legajo del usuario</b>
			</td>
			<td valign="top" align="right"><img src="<!-- TMPL_VAR NAME='interface' -->/<!-- TMPL_VAR name='theme' -->/images/derecha.png"></td>
		</tr>
		<tr><td colspan="3">&nbsp;</td></tr>
		<tr>
			<td width="1%">&nbsp;</td>
			<td align="center">
				<input id="usuarioAutocomplete" type="text" class="inputFontNormal" size="40">
			</td>
			<td width="1%">&nbsp;</td>
		</tr>
	</table>
</div> 

<div id="confirmar_prestamos"></div>
<div id="mensajes"></div>
<div id="detalleUsuario"></div>
<div id="tablaReservas"></div>

<!-- TMPL_INCLUDE name="intranet-bottom.inc" -->
