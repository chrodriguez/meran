[% INCLUDE "intranet-top.inc" %]

<!-- para manejar la ventana de campos MARC -->
<script src="/intranet-tmpl/includes/popups/helpCamposMARC.js"></script>

<script>

//arreglo de objetos campo
CAMPOS_ARRAY= new Array();
//arreglo de objetos subcampo
SUBCAMPOS_ARRAY= new Array();
//para mantener el encabezado
ENCABEZADO= 0;


/*
 * eleccionCampoX
 * Funcion que se ejecuta cuando se selecciona un valor del combo campoX (ej. 1xx), y hace un llamado a la 
 * funcion que ejecuta el ajax, con los parametros correspondiente a la accion realizada.
 */
function eleccionCampoX(){
//     if ( $("#campoX").val() != -1){
        objAH=new AjaxHelper(updateEleccionCampoX);
		objAH.debug= true;
        objAH.url="/cgi-bin/koha/catalogacion/estructura/estructuraCataloDB.pl";
        objAH.campoX=$('#campoX').val();
        objAH.nivel=$('#niveles_id').val();
        objAH.tipoAccion="GENERAR_ARREGLO_CAMPOS";
        objAH.sendToServer();
//     }
}

//se genera el combo en el cliente
function updateEleccionCampoX(responseText){
    //Arreglo de Objetos Global
    var campos_array=JSONstring.toObject(responseText);
    //se inicializa el combo
    $("#campo").html('')
    var options = "<option value='-1'>Seleccionar Campo</option>";
    
    for (x=0;x < campos_array.length;x++){
         CAMPOS_ARRAY[campos_array[x].tagfield]= $.trim(campos_array[x].liblibrarian);   
         options+= "<option value=" + campos_array[x].tagfield +" >" + campos_array[x].tagfield + "</option>";
    }
    $("#campo").append(options);
    //se agrega la info al combo
//     enable_disableSelects();
}



function eleccionCampo(){
//     if ($("#campo").val() != -1){
        objAH=new AjaxHelper(updateEleccionCampo);
        objAH.debug= true;
        objAH.url="/cgi-bin/koha/catalogacion/estructura/estructuraCataloDB.pl";
        objAH.campo=$('#campo').val();
        objAH.nivel=$('#niveles_id').val();
        objAH.tipoAccion="GENERAR_ARREGLO_SUBCAMPOS";
        objAH.sendToServer();
//     }
//     else
//         enable_disableSelects();

}


//se genera el combo en el cliente
function updateEleccionCampo(responseText){
//     $('#nombre_campo').html(CAMPOS_ARRAY[$("#campo").val()]);
    //Arreglo de Objetos Global
    var subcampos_array=JSONstring.toObject(responseText);
    //se inicializa el combo
    $("#subcampo").html('');
    var options = "<option value='-1'>Seleccionar SubCampo</option>";
    
    for (x=0;x < subcampos_array.length;x++){
         SUBCAMPOS_ARRAY[ subcampos_array[x].tagsubfield ]= $.trim(subcampos_array[x].liblibrarian);
         options+= "<option value=" + subcampos_array[x].tagsubfield +" >" + subcampos_array[x].tagsubfield + "</option>";
    }
    //se agrega la info al combo
    $("#subcampo").append(options);
//     enable_disableSelects();
}



function eleccionSubCampo(){

// 	objAH=new AjaxHelper(updateEleccionSubCampo);
// 	objAH.debug= true;
// 	objAH.url= '/cgi-bin/koha/catalogacion/visualizacionOPAC/visualizacionOpacResults.pl';
// 	objAH.campoX= $('#campoX').val();
// 	objAH.encabezados= $('#encabezados').val();
// 	objAH.campo= $('#campo').val();
// 	objAH.accion= 'SELECCION_SUB_CAMPO';
// 	objAH.nivel= $('#nivel').val();
// 	objAH.itemtype= $('#comboTiposItems').val();
// 	//se envia la consulta
// 	objAH.sendToServer();
}

// function updateEleccionSubCampo(responseText){
// 	$('#result').html(responseText);
// 	$('#guardar')[0].disabled = false;
// }


/*
* Esta funcion abre una ventan para agregar el encabezado
*/
function agregarEncabezado(){
	objAH=new AjaxHelper(updateAgregarEncabezado);
	objAH.debug= true;
	objAH.url='/cgi-bin/koha/catalogacion/visualizacionOPAC/visualizacionOpacDB.pl';
	objAH.tipoAccion= 'AGREGAR_ENCABEZADO_VISUALIZACION_OPAC';
	objAH.sendToServer();
}


function updateAgregarEncabezado(responseText){
	vAgregarEncabezado=new WindowHelper({draggable: true, opacity: true});
	vAgregarEncabezado.debug= true;
	vAgregarEncabezado.html=responseText;
	vAgregarEncabezado.titulo= AGREGAR_ENCABEZADO;
	vAgregarEncabezado.create();	
	vAgregarEncabezado.height('60%');
	vAgregarEncabezado.width('50%');
	vAgregarEncabezado.open();
}

function cambiarVisibilidad(idEstCat){

	objAH=new AjaxHelper(armarTablaVisualizacion);
	objAH.debug= true;
	objAH.url= '/cgi-bin/koha/catalogacion/visualizacionOPAC/visualizacionOpacDB.pl';
	objAH.id= idEstCat;
	objAH.tipoAccion= 'CAMBIAR_VISIBILIDAD';
	//se envia la consulta
	objAH.sendToServer();
}

function cambiarVisibilidadEncabezado(id){

	objAH=new AjaxHelper(updateCambiarVisibilidadEncabezado);
	objAH.debug= true;
	objAH.url= '/cgi-bin/koha/catalogacion/visualizacionOPAC/visualizacionOpacDB.pl';
	objAH.encabezado= id;
	objAH.tipoAccion= 'CAMBIAR_VISIBILIDAD_ENCABEZADO';
	//se envia la consulta
	objAH.sendToServer();
}

function updateCambiarVisibilidadEncabezado(){
	cargarTablaEncabezados();
}

function seleccionarEncabezado(id){
	
	ENCABEZADO= id;
	//oculto el boton de guardar
	$('#guardar').show();
	//oculto el boton de modificar
	$('#modificar').hide();
	$('#idEncabezado').val(id);
// 	eleccionCampoX();
	//muestro la tabla con resultados catalogados
	armarTablaVisualizacion();
}


//para guardar el id de la fila seleccionada
var idestcatopac;

function modificarVisualizacion(id){

	objAH=new AjaxHelper(updateModificarVisualizacion);
	objAH.debug= true;
	objAH.url= '/cgi-bin/koha/catalogacion/visualizacionOPAC/visualizacionOpacDB.pl';
	objAH.id= id;
	objAH.tipoAccion= 'MODIFICAR_CONFIGURACION_VISUALIZACION';
	//se envia la consulta
	objAH.sendToServer();
}

function updateModificarVisualizacion(responseText){
	$('#divAgregarModificarVisualizacion').html(responseText);
	$('#divAgregarModificarVisualizacion').slideDown('slow');
}


function validarDatosEncabezado(){
	if($('#nomEncabezadoAlta')[0].value == ""){
		jAlert('Ingrese el encabezado');
		$('#nomEncabezadoAlta')[0].focus();
	}else {
		saveEncabezado();
		vAgregarEncabezado.close();
		//refresh info, muestro el nuevo encabezado
		changeNivel();
	};
}

function agregarConfVisualizacion(){

	objAH=new AjaxHelper(updateAgregarConfVisualizacion);
	objAH.debug= true;
	objAH.url= '/cgi-bin/koha/catalogacion/visualizacionOPAC/visualizacionOpacDB.pl';
	objAH.tipoAccion= 'AGREGAR_CONFIGURACION_VISUALIZACION';
	//se envia la consulta
	objAH.sendToServer();
}

function updateAgregarConfVisualizacion(responseText){
	$('#divAgregarModificarVisualizacion').html(responseText);	
	$('#divAgregarModificarVisualizacion').slideDown('slow');
}

function guardarConfVisualizacion(){

	objAH=new AjaxHelper(updateGuardarConfVisualizacion);
	objAH.debug= true;
	objAH.url= '/cgi-bin/koha/catalogacion/visualizacionOPAC/visualizacionOpacDB.pl';
	objAH.textoPredecesor= $('#textoPredecesor').val();
	objAH.textoSucesor= $('#textoSucesor').val();
	objAH.separador= $('#separador').val();
	objAH.campo= $('#campo').val();
	objAH.subcampo= $('#subcampo').val();
	objAH.idencabezado= $('#idEncabezado').val();
 	objAH.tipoAccion= 'ESTRUCTURA_VISUALIZACION';
	//se envia la consulta
	objAH.sendToServer();
}

function updateGuardarConfVisualizacion(responseText){

	var Mensaje= JSONstring.toObject(responseText);
  	setMessages(Mensaje);

	//arma la tabla de configuracion de visualizacion 
	armarTablaVisualizacion();
// 	eleccionCampoX();
}

function deleteRowVisualizacion(id){

    jConfirm(CONFIRMA_LA_BAJA,CONFIRMA_LA_BAJA,function(){
        objAH=new AjaxHelper(updateDeleteRowVisualizacion);
        objAH.debug= true;
        objAH.url= '/cgi-bin/koha/catalogacion/visualizacionOPAC/visualizacionOpacDB.pl';
        objAH.tipoAccion= 'DELETE';
        objAH.tabla= 'ESTRUCTURA_VISUALIZACION';
        objAH.idestcatopac= id;
        //se envia la consulta
        objAH.sendToServer();
  });
}

function updateDeleteRowVisualizacion(responseText){

	var Mensaje= JSONstring.toObject(responseText);
  	setMessages(Mensaje);

	armarTablaVisualizacion();
}

function armarTablaVisualizacion(){

	objAH=new AjaxHelper(updateArmarTablaVisualizacion);
	objAH.debug= true;
	objAH.url= '/cgi-bin/koha/catalogacion/visualizacionOPAC/visualizacionOpacDB.pl';
	objAH.encabezados= $('#idEncabezado').val();
	objAH.tipoAccion= 'MOSTAR_TABLA_VISUALIZACION';
	//se envia la consulta
	objAH.sendToServer();
}

function updateArmarTablaVisualizacion(responseText){
	$('#divTablaVisualizacion').html(responseText);
	$('#divTablaVisualizacion').slideDown('slow');
	zebra('tablesorter');
}

function validarDatos(){
	var ok= true;
// y esto para que esta!!!!!!!
	seleccionarEncabezado
	if($('#campoX').selectedIndex == 0){
		jAlert("Seleccione el filtro para campos");
		$('#campoX').focus();
		ok= false;
	}

	if(($('#campo').selectedIndex == 1)&&(ok)){
		jAlert("Seleccione el campo");
		$('#campo').focus();
		ok= false;
	}

	if(($('#subcampo').selectedIndex == 1)&&(ok)){
		jAlert("Seleccione el subcampo");
		$('#subcampo').focus();
		ok= false;
	}

	if(($('#textoPredecesor').value == "")&&(ok)){
		jAlert("Ingrese el texto predecesor");
		$('#textoPredecesor').focus();
		ok= false;
	}

	if(($('#textoSucesor').value == "")&&(ok)){
		jAlert("Ingrese el texto sucesor");
		$('#textoSucesor').focus();
		ok= false;
	}

	if(($('#separador').value == "")&&(ok)){
		jAlert("Ingrese el separador");
		$('#separador').focus();
		ok= false;
	}
	
	if(ok){
	//se guarda la configuracion de visualizacion
		guardarConfVisualizacion();
	}
}

function changeNivel(){
	$('#divTablaVisualizacion').html('');
	cargarTablaEncabezados();
// 	$('#result').html('');
}

function updateNombreEncabezado(idEncabezado, nombre){

	objAH=new AjaxHelper(cargarTablaEncabezados);
	objAH.debug= true;
	objAH.url= '/cgi-bin/koha/catalogacion/visualizacionOPAC/visualizacionOpacDB.pl';
	objAH.encabezado= idEncabezado;
	objAH.nombre= nombre;
	objAH.tipoAccion= 'CAMBIAR_NOMBRE_ENCABEZADO';
	//se envia la consulta
	objAH.sendToServer();

}

//este no se va a usar si se modifican los datos en la fila de la tabla
function modificarEncabezado(idEncabezado){

	$('#updateEncabezado').slideDown('slow');
	$('#nombreNuevo').val(jQuery.trim($('#encabezado'+idEncabezado).text()));
	$('#nombreNuevo').keyup(
		function () {
			$('#encabezado'+idEncabezado).text($('#nombreNuevo').val());
		});

	$('#nombreNuevo').keypress(
		function (e) {
			if(e.which == 13){
				updateNombreEncabezado(idEncabezado, $('#nombreNuevo').val());
				$('#updateEncabezado').slideUp('slow');
			}
		});
}

function EditCell(idObj, id){
	estado= $('#' + idObj + ' > div')[0].getAttribute('selected');

	var array_aux= $('#tablaEncabezados tr > td > div');

	//recorro los input para editar que se puedan estar mostrando
	var valor;
	for(i=0;i<array_aux.length;i++){
		if($('#' + array_aux[i].id)[0].getAttribute('selected') == 'on'){
			valor= $('#' + array_aux[i].id + '> input').val();
			$('#'+array_aux[i].id).html("");
			$('#'+array_aux[i].id).html($.trim(valor));
			$('#'+array_aux[i].id)[0].setAttribute('selected', 'off');
			$('#'+array_aux[i].id)[0].setAttribute('align', 'center');
		}
	}

	if( estado == 'off' ){

		var valor= $('#'+idObj + " > div").html();
		$('#' + idObj + ' > div')[0].setAttribute('selected', 'on');
		var inputO= "<input id='inputUpdate' type='text' size='50' />";
		$('#'+idObj + " > div").html("");
		$('#'+idObj + " > div").html(inputO);

		$('#'+idObj)[0].setAttribute('align', 'left');
		$('#inputUpdate').val($.trim(valor));
		$('#inputUpdate').focus();
		
//agredo eventos al input donde se va a ingresar la actualizacion
		$('#inputUpdate').keypress(
		function (e) {
			var nuevoValor;
		// onEsc
			if(e.which == 0){
				$('#'+idObj + " > div").html("");
				$('#'+idObj + " > div").html(valor);
				$('#' + idObj + ' > div')[0].setAttribute('selected', 'off');
				$('#'+idObj)[0].setAttribute('align', 'center');
			}
		// onEnter
			if(e.which == 13){
				nuevoValor= $('#inputUpdate').val();
				updateNombreEncabezado(id, nuevoValor);
				$('#'+idObj + " > div").html("");
				$('#'+idObj + " > div").html(nuevoValor);
				$('#' + idObj + ' > div')[0].setAttribute('selected', 'off');
				$('#'+idObj)[0].setAttribute('align', 'center');
			}
		});

	}
}

function changeTipoItem(){
	//se llama al mismo evento
	changeNivel();
}

//muestra la tabla de los encabezados, segun nivel e itemtype
function cargarTablaEncabezados(){

	objAH=new AjaxHelper(updateCargarTablaEncabezados);
	objAH.debug= true;
	objAH.url= '/cgi-bin/koha/catalogacion/visualizacionOPAC/visualizacionOpacDB.pl';
	objAH.nivel= $('#niveles_id').val();
	objAH.tipo_documento= $('#comboTiposItems').val();
	objAH.tipoAccion= 'CARGAR_TABLA_ENCABEZADOS';
	//se envia la consulta
	objAH.sendToServer();

}

function updateCargarTablaEncabezados(responseText){
	$('#divTablaEncabezados').html(responseText);	
	zebra('tablaEncabezados');
// 	seleccionarFilaEncabezado();
}


function deleteEncabezado(idEncabezado){

    jConfirm('Confirma la baja del Encabezado?','Confirma la baja del Encabezado?',function(){
        objAH=new AjaxHelper(updateDeleteEncabezado);
        objAH.debug= true;
        objAH.url= '/cgi-bin/koha/catalogacion/visualizacionOPAC/visualizacionOpacDB.pl';
        objAH.encabezado= idEncabezado;
        objAH.tipoAccion= 'DELETE';
        objAH.tabla= 'ENCABEZADO_CAMPO_OPAC';
        //se envia la consulta
        objAH.sendToServer();
  });
}

function updateDeleteEncabezado(responseText){
	clearMessages();

	var Mensaje= JSONstring.toObject(responseText);
  	setMessages(Mensaje);

	cargarTablaEncabezados();
}

function modificarOrden(encabezado, antOrden, action){
	
	if((antOrden == 1)&&(action == 'up')){
		jAlert("No se puede subir m√°s");
	}else{

		objAH=new AjaxHelper(cargarTablaEncabezados);
		objAH.debug= true;
		objAH.url= '/cgi-bin/koha/catalogacion/visualizacionOPAC/visualizacionOpacDB.pl';
		objAH.encabezado= encabezado;
		objAH.orden= antOrden;
		objAH.itemtype= $('#comboTiposItems').val(); 
		objAH.tipoAccion= 'CAMBIAR_ORDEN_ENCABEZADO';
		objAH.action= action;
		//se envia la consulta
		objAH.sendToServer();

	}
}

function cambiarLineaEncabezado(id){
		
	objAH=new AjaxHelper(updateCambiarLineaEncabezado);
	objAH.debug= true;
	objAH.url= '/cgi-bin/koha/catalogacion/visualizacionOPAC/visualizacionOpacDB.pl';
	objAH.encabezado= id;
	objAH.tipoAccion= 'CAMBIAR_LINEA_ENCABEZADO';
	//se envia la consulta
	objAH.sendToServer();
}

function updateCambiarLineaEncabezado(){
	cargarTablaEncabezados();
}


//al seleccionar una fila se cambia el estilo para que se vea cual es la que se selecciona
// function seleccionarFilaEncabezado(){
// 	$("#tablaEncabezados tr:not([tr.titulo_tabla_resultado])").click(
// 				function () {
// 					zebra('tablaEncabezados');
// 				}
//     	);
// }

//*************************************Fin**Encabezados********************************************************

function inicializar(){
// 	$('#divTablaEncabezados').hide();
	ENCABEZADO= 0;
	$('#divAgregarModificarVisualizacion').hide();
	$('#divTablaVisualizacion').hide();
}

//Init Form
$(document).ready(function() {
	
	changeNivel();
	// Help
	$("#topichelp").hide();
	$("#tophelper img.showhelp ").click(function(){
						$("#topichelp").slideToggle('fast');
					});

});

</script>

[% PERL %]
    print C4::AR::Filtros::ayuda_marc() ;
[% END %]

<input type="hidden" id="idEncabezado">
<div style="position: static;" id="tophelper">
<img class="showhelp" src="/intranet-tmpl/images/help.gif" alt="Descricion de la Ventana">
    <div style="display: block;" id="topichelp">
        <p>[% 'Descripcion breve para lo q sirve la ventana....' | i18n %]</p>
    </div>
</div>

<br>

<div class="titulos" >[% 'Visualizaci&oacute;n de campos MARC en OPAC' | i18n %]</div>

<div class="formElemets">
  <div>
<!-- contenedor superior -->
<ul>
	<li>
		<select id="niveles_id" onChange="changeNivel();">
		<option value="1">Nivel1</option>
		<option value="2">Nivel2</option>
		<option value="3">Nivel3</option>
		</select>
		Tipo de item: [% selectItemType %]
		<input 	type="button" Title="[% 'Agregar Encabezado' | i18n %]" onClick="agregarEncabezado()" value="[% 'Agregar' | i18n %]"
				 Title="[% 'Agregar un Encabezado' | i18n %]">
	</li>
	<li>
		<div id="divTablaEncabezados">
		</div>
	</li>
	<li>
		<div id="divAgregarModificarVisualizacion"></div>
	</li>
	<li>
		<div id="divTablaVisualizacion"></div>
	</li>
</ul>
</div>

[% INCLUDE "intranet-bottom.inc" %]
