[% INCLUDE "intranet-top.inc" %]

<script src="/includes/jquery/tablesorter/jquery.tablesorter.js"></script>
<link href="/includes/jquery/tablesorter/blue/style.css" type="text/css" rel="stylesheet">

<!-- para manejar la ventana de campos MARC -->
<script src="/intranet-tmpl/blue/includes/popups/helpCamposMARC.js"></script>


<script>

//arreglo de objetos campo
CAMPOS_ARRAY= new Array();
//arreglo de objetos subcampo
SUBCAMPOS_ARRAY= new Array();


/*
 * eleccionCampoX
 * Funcion que se ejecuta cuando se selecciona un valor del combo campoX (ej. 1xx), y hace un llamado a la 
 * funcion que ejecuta el ajax, con los parametros correspondiente a la accion realizada.
 */
function eleccionCampoX(){
//     if ( $("#campoX").val() != -1){
        objAH=new AjaxHelper(updateEleccionCampoX);
		objAH.debug= true;
        objAH.url="/cgi-bin/koha/catalogacion/estructura/estructuraCataloDB.pl";
        objAH.campoX=$('#campoX').val();
        objAH.nivel=$('#niveles_id').val();
        objAH.tipoAccion="GENERAR_ARREGLO_CAMPOS";
        objAH.sendToServer();
//     }
}

//se genera el combo en el cliente
function updateEleccionCampoX(responseText){
    //Arreglo de Objetos Global
    var campos_array=JSONstring.toObject(responseText);
    //se inicializa el combo
    $("#campo").html('')
    var options = "<option value='-1'>Seleccionar Campo</option>";
    
    for (x=0;x < campos_array.length;x++){
         CAMPOS_ARRAY[campos_array[x].tagfield]= $.trim(campos_array[x].liblibrarian);   
         options+= "<option value=" + campos_array[x].tagfield +" >" + campos_array[x].tagfield + "</option>";
    }
    $("#campo").append(options);
    //se agrega la info al combo
//     enable_disableSelects();
}



function eleccionCampo(){
//     if ($("#campo").val() != -1){
        objAH=new AjaxHelper(updateEleccionCampo);
        objAH.debug= true;
        objAH.url="/cgi-bin/koha/catalogacion/estructura/estructuraCataloDB.pl";
        objAH.campo=$('#campo').val();
        objAH.nivel=$('#niveles_id').val();
        objAH.tipoAccion="GENERAR_ARREGLO_SUBCAMPOS";
        objAH.sendToServer();
//     }
//     else
//         enable_disableSelects();

}


//se genera el combo en el cliente
function updateEleccionCampo(responseText){
//     $('#nombre_campo').html(CAMPOS_ARRAY[$("#campo").val()]);
    //Arreglo de Objetos Global
    var subcampos_array=JSONstring.toObject(responseText);
    //se inicializa el combo
    $("#subcampo").html('');
    var options = "<option value='-1'>Seleccionar SubCampo</option>";
    
    for (x=0;x < subcampos_array.length;x++){
         SUBCAMPOS_ARRAY[ subcampos_array[x].tagsubfield ]= $.trim(subcampos_array[x].liblibrarian);
         options+= "<option value=" + subcampos_array[x].tagsubfield +" >" + subcampos_array[x].tagsubfield + "</option>";
    }
    //se agrega la info al combo
    $("#subcampo").append(options);
//     enable_disableSelects();
}



function eleccionSubCampo(){

// 	objAH=new AjaxHelper(updateEleccionSubCampo);
// 	objAH.debug= true;
// 	objAH.url= '/cgi-bin/koha/catalogacion/visualizacionOPAC/visualizacionOpacResults.pl';
// 	objAH.campoX= $('#campoX').val();
// 	objAH.encabezados= $('#encabezados').val();
// 	objAH.campo= $('#campo').val();
// 	objAH.accion= 'SELECCION_SUB_CAMPO';
// 	objAH.nivel= $('#nivel').val();
// 	objAH.itemtype= $('#comboTiposItems').val();
// 	//se envia la consulta
// 	objAH.sendToServer();
}

// function updateEleccionSubCampo(responseText){
// 	$('#result').html(responseText);
// 	$('#guardar')[0].disabled = false;
// }



function agregarEncabezado(){
	objAH=new AjaxHelper(updateAgregarEncabezado);
	objAH.debug= true;
	objAH.url='/intranet-tmpl/blue/includes/popups/agregarEncabezado.inc';
	objAH.sendToServer();
}


function updateAgregarEncabezado(responseText){
	vAgregarEncabezado=new WindowHelper({draggable: true, opacity: true});
	vAgregarEncabezado.debug= true;
	vAgregarEncabezado.html=responseText;
	vAgregarEncabezado.titulo= AGREGAR_ENCABEZADO;
	vAgregarEncabezado.create();	
	vAgregarEncabezado.height('60%');
	vAgregarEncabezado.width('50%');
	vAgregarEncabezado.open();
}

function cambiarVisibilidad(idEstCat){

	objAH=new AjaxHelper(armarTablaVisualizacion);
	objAH.debug= true;
	objAH.url= '/cgi-bin/koha/catalogacion/visualizacionOPAC/visualizacionOpacDB.pl';
	objAH.id= idEstCat;
	objAH.visible= $('#' + idEstCat).val();
	objAH.tipoAccion= 'CAMBIAR_VISIBILIDAD';
	//se envia la consulta
	objAH.sendToServer();
}

/*
function eleccionCampoX(accion){

	objAH=new AjaxHelper(updateEleccionCampoX);
	objAH.debug= true;
	objAH.url= '/cgi-bin/koha/catalogacion/visualizacionOPAC/visualizacionOpacResults.pl';
	objAH.accion= 'SELECCION_CAMPO';
	objAH.campoX= $('#campoX').val();
	objAH.encabezados= $('#encabezados').val();
	objAH.nivel= $('#nivel').val();
	//se envia la consulta
	objAH.sendToServer();
}

function updateEleccionCampoX(responseText){
	$('#result').show();
	$('#result').html(responseText);
}*/

// function eleccionCampo(accion){
// 
// 	objAH=new AjaxHelper(updateEleccionCampo);
// 	objAH.debug= true;
// 	objAH.url= '/cgi-bin/koha/catalogacion/visualizacionOPAC/visualizacionOpacResults.pl';
// 	objAH.campoX= $('#campoX').val();
// 	objAH.encabezados= $('#encabezados').val();
// 	objAH.campo= $('#campo').val();
// 	objAH.accion= 'SELECCION_SUB_CAMPO';
// 	objAH.nivel= $('#nivel').val();
// 	objAH.itemtype= $('#comboTiposItems').val();
// 	//se envia la consulta
// 	objAH.sendToServer();
// }
// 
// function updateEleccionCampo(responseText){
// 	$('#result').html(responseText);
// 	$('#guardar')[0].disabled = false;
// }


function seleccionarEncabezado(id){
	
	//oculto el boton de guardar
	$('#guardar').show();
	//oculto el boton de modificar
	$('#modificar').hide();
	$('#idEncabezado').val(id);
	eleccionCampoX();
	//muestro la tabla con resultados catalogados
	armarTablaVisualizacion();
}

function modificarDatos(){

	objAH=new AjaxHelper(updateModificarDatos);
	objAH.debug= true;
	objAH.url= '/cgi-bin/koha/catalogacion/visualizacionOPAC/visualizacionOpacDB.pl';
	objAH.textoPredecesor= $('#textoPredecesor').val();
	objAH.textoSucesor= $('#textoSucesor').val(); 
	objAH.separador= $('#separador').val();
	objAH.idestcatopac= idestcatopac;
	objAH.tabla= 'ESTRUCTURA_VISUALIZACION';
	objAH.tipoAccion= 'UPDATE';
	//se envia la consulta
	objAH.sendToServer();

}

function updateModificarDatos(){
	//arma la tabla de configuracion de visualizacion 
	armarTablaVisualizacion();
	//eleccionCampoX();
	$('#result').slideUp('slow');
	$('#modificar').hide();
}

//para guardar el id de la fila seleccionada
var idestcatopac;

function modificarVisualizacion(textpred, textsucc, separador, id){

	objAH=new AjaxHelper(updateModificarVisualizacion);
	objAH.debug= true;
	objAH.url= '/cgi-bin/koha/catalogacion/visualizacionOPAC/visualizacionOpacResults.pl';
	objAH.idestcatopac= id;
	objAH.tipoAccion= 'SELECT';
	objAH.componente= 'CONF_CAMPO_SUBCAMPO';

	idestcatopac= id;
	//se envia la consulta
	objAH.sendToServer();
}

function updateModificarVisualizacion(responseText, textpred, textsucc, separador, tipo){
// como paso los parametros textsucc, separador, etc!!!!!!!!!!
	$('#result').html(responseText);	
	$('#textoPredecesor').val(textpred);
	$('#textoSucesor').val(textsucc);
	$('#separador').val(separador);

	$('#seleccionCampos').hide();
	$('#guardar').hide();
	$('#modificar').show();
	$('#textoPredecesor').focus();
}

function seleccionarCampos(){

	objAH=new AjaxHelper(updateSeleccionarCampos);
	objAH.debug= true;
	objAH.url= '/cgi-bin/koha/catalogacion/visualizacionOPAC/visualizacionOpacResults.pl';
	//se envia la consulta
	objAH.sendToServer();
}

function updateSeleccionarCampos(responseText){
	$('#result').html(responseText);
}

function validarDatosEncabezado(){
	if($('#nomEncabezadoAlta')[0].value == ""){
		alert('Ingrese el encabezado');
		$('#nomEncabezadoAlta')[0].focus();
	}else {
		saveEncabezado();
		closeWindow();
	};
}

function saveConfVisualizacion(){

	objAH=new AjaxHelper(updateSaveConfVisualizacion);
	objAH.debug= true;
	objAH.url= '/cgi-bin/koha/catalogacion/visualizacionOPAC/visualizacionOpacDB.pl';
	objAH.textoPredecesor= $('#textoPredecesor').val();
	objAH.textoSucesor= $('#textoSucesor').val();
	objAH.separador= $('#separador').val();
	objAH.campo= $('#campo').val();
	objAH.subcampo= $('#subcampo').val();
	objAH.idencabezado= $('#idEncabezado').val();
	objAH.tabla= 'ESTRUCTURA_VISUALIZACION';
 	objAH.tipoAccion= 'INSERT';
	//se envia la consulta
	objAH.sendToServer();
}

function updateSaveConfVisualizacion(responseText){

	var Mensaje= JSONstring.toObject(responseText);
  	setMessages(Mensaje);

	//arma la tabla de configuracion de visualizacion 
	armarTablaVisualizacion();
	eleccionCampoX();
}

function deleteRowVisualizacion(OP,ID){

	var is_confirmed = confirm('Confirma la baja?');

	if (is_confirmed) {

		objAH=new AjaxHelper(updateDeleteRowVisualizacion);
		objAH.debug= true;
		objAH.url= '/cgi-bin/koha/catalogacion/visualizacionOPAC/visualizacionOpacDB.pl';
		objAH.tipoAccion= 'DELETE';
		objAH.tabla= 'ESTRUCTURA_VISUALIZACION';
		objAH.idestcatopac= ID;
		//se envia la consulta
		objAH.sendToServer();
	}

}

function updateDeleteRowVisualizacion(responseText){

	clearMessages();
	var Mensaje= JSONstring.toObject(responseText);
  	setMessages(Mensaje);

	armarTablaVisualizacion();
}

function armarTablaVisualizacion(){

	objAH=new AjaxHelper(updateArmarTablaVisualizacion);
	objAH.debug= true;
	objAH.url= '/cgi-bin/koha/catalogacion/visualizacionOPAC/visualizacionOpacDB.pl';
	objAH.encabezados= $('#idEncabezado').val();
	objAH.tipoAccion= 'MOSTAR_TABLA_VISUALIZACION';
	objAH.componente= 'CLOSE_UP_COMBO_ENCABEZADO';
	//se envia la consulta
	objAH.sendToServer();
}

function updateArmarTablaVisualizacion(responseText){
	$('#divTablaVisualizacion').html(responseText);
	zebra('tablaVisualizacion');
	$('#tablaVisualizacion').tablesorter({	
					widgets: ['zebra'],
					headers: { 0: { sorter: false},
							7: { sorter: false},
							8: { sorter: false},
							9: { sorter: false}}
				});
}

function validarDatos(){
	var ok= true;
// y esto para que esta!!!!!!!
	seleccionarEncabezado
	if($('#campoX').selectedIndex == 0){
		alert("Seleccione el filtro para campos");
		$('#campoX').focus();
		ok= false;
	}

	if(($('#campo').selectedIndex == 1)&&(ok)){
		alert("Seleccione el campo");
		$('#campo').focus();
		ok= false;
	}

	if(($('#subcampo').selectedIndex == 1)&&(ok)){
		alert("Seleccione el subcampo");
		$('#subcampo').focus();
		ok= false;
	}

	if(($('#textoPredecesor').value == "")&&(ok)){
		alert("Ingrese el texto predecesor");
		$('#textoPredecesor').focus();
		ok= false;
	}

	if(($('#textoSucesor').value == "")&&(ok)){
		alert("Ingrese el texto sucesor");
		$('#textoSucesor').focus();
		ok= false;
	}

	if(($('#separador').value == "")&&(ok)){
		alert("Ingrese el separador");
		$('#separador').focus();
		ok= false;
	}
	
	if(ok){
	//se guarda la configuracion de visualizacion
		saveConfVisualizacion();
	}
}

function changeNivel(){
	cargarTablaEncabezados();
	$('#divTablaVisualizacion').html('');
	$('#result').html('');
}

function updateNombreEncabezado(idEncabezado, nombre){

	objAH=new AjaxHelper(cargarTablaEncabezados);
	objAH.debug= true;
	objAH.url= '/cgi-bin/koha/catalogacion/visualizacionOPAC/visualizacionOpacDB.pl';
	objAH.encabezado= idEncabezado;
	objAH.nombre= nombre;
	objAH.tipoAccion= 'UPDATE';
	objAH.tabla= 'ENCABEZADO';
	//se envia la consulta
	objAH.sendToServer();

}

//este no se va a usar si se modifican los datos en la fila de la tabla
function modificarEncabezado(idEncabezado){

	$('#updateEncabezado').slideDown('slow');
	$('#nombreNuevo').val(jQuery.trim($('#encabezado'+idEncabezado).text()));
	$('#nombreNuevo').keyup(
		function () {
			$('#encabezado'+idEncabezado).text($('#nombreNuevo').val());
		});

	$('#nombreNuevo').keypress(
		function (e) {
			if(e.which == 13){
				updateNombreEncabezado(idEncabezado, $('#nombreNuevo').val());
				$('#updateEncabezado').slideUp('slow');
			}
		});
}

function EditCell(idObj, id){
	estado= $('#' + idObj + ' > div')[0].getAttribute('selected');

	var array_aux= $('#tablaEncabezados tr > td > div');

	//recorro los input para editar que se puedan estar mostrando
	var valor;
	for(i=0;i<array_aux.length;i++){
		if($('#' + array_aux[i].id)[0].getAttribute('selected') == 'on'){
			valor= $('#' + array_aux[i].id + '> input').val();
			$('#'+array_aux[i].id).html("");
			$('#'+array_aux[i].id).html($.trim(valor));
			$('#'+array_aux[i].id)[0].setAttribute('selected', 'off');
			$('#'+array_aux[i].id)[0].setAttribute('align', 'center');
		}
	}

	if( estado == 'off' ){

		var valor= $('#'+idObj + " > div").html();
		$('#' + idObj + ' > div')[0].setAttribute('selected', 'on');
		var inputO= "<input id='inputUpdate' type='text' size='50' />";
		$('#'+idObj + " > div").html("");
		$('#'+idObj + " > div").html(inputO);

		$('#'+idObj)[0].setAttribute('align', 'left');
		$('#inputUpdate').val($.trim(valor));
		$('#inputUpdate').focus();
		
//agredo eventos al input donde se va a ingresar la actualizacion
		$('#inputUpdate').keypress(
		function (e) {
			var nuevoValor;
		// onEsc
			if(e.which == 0){
				$('#'+idObj + " > div").html("");
				$('#'+idObj + " > div").html(valor);
				$('#' + idObj + ' > div')[0].setAttribute('selected', 'off');
				$('#'+idObj)[0].setAttribute('align', 'center');
			}
		// onEnter
			if(e.which == 13){
				nuevoValor= $('#inputUpdate').val();
				updateNombreEncabezado(id, nuevoValor);
				$('#'+idObj + " > div").html("");
				$('#'+idObj + " > div").html(nuevoValor);
				$('#' + idObj + ' > div')[0].setAttribute('selected', 'off');
				$('#'+idObj)[0].setAttribute('align', 'center');
			}
		});

	}
}

function changeTipoItem(){
	//se llama al mismo evento
	changeNivel();
}

//muestra la tabla de los encabezados, segun nivel e itemtype
function cargarTablaEncabezados(){

	objAH=new AjaxHelper(updateCargarTablaEncabezados);
	objAH.debug= true;
	objAH.url= '/cgi-bin/koha/catalogacion/visualizacionOPAC/visualizacionOpacDB.pl';
	objAH.nivel= $('#niveles_id').val();
	objAH.itemtype= $('#comboTiposItems').val();
	objAH.tipoAccion= 'SELECT';
	objAH.componente= 'CARGAR_TABLA_ENCABEZADOS';
	//se envia la consulta
	objAH.sendToServer();

}

function updateCargarTablaEncabezados(responseText){
	$('#divTablaEncabezados').html(responseText);	
	zebra('tablaEncabezados');
	seleccionarFilaEncabezado();
}


function deleteEncabezado(idEncabezado){

	var is_confirmed = confirm('Confirma la baja del Encabezado?');

	if (is_confirmed) {

		objAH=new AjaxHelper(updateDeleteEncabezado);
		objAH.debug= true;
		objAH.url= '/cgi-bin/koha/catalogacion/visualizacionOPAC/visualizacionOpacDB.pl';
		objAH.encabezado= idEncabezado;
		objAH.tipoAccion= 'DELETE';
		objAH.tabla= 'ENCABEZADO_CAMPO_OPAC';
		//se envia la consulta
		objAH.sendToServer();
	}
}

function updateDeleteEncabezado(responseText){
	clearMessages();

	var Mensaje= JSONstring.toObject(responseText);
  	setMessages(Mensaje);

	cargarTablaEncabezados();
}

function modificarOrden(encabezado, antOrden, action){
	
	if((antOrden == 1)&&(action == 'up')){
		alert("no se puede subir mas");
	}else{

		objAH=new AjaxHelper(cargarTablaEncabezados);
		objAH.debug= true;
		objAH.url= '/cgi-bin/koha/catalogacion/visualizacionOPAC/visualizacionOpacDB.pl';
		objAH.encabezado= encabezado;
		objAH.orden= antOrden;
		objAH.itemtype= $('#comboTiposItems').val(); 
		objAH.tipoAccion= 'CAMBIAR_ORDEN_ENCABEZADO';
		objAH.action= action;
		//se envia la consulta
		objAH.sendToServer();

	}
}

function cambiarLineaEncabezado(id){
		
	linea= 0;
	if($("#checkbox"+id).val() == 0){linea= 1;}//encabezado en linea

	objAH=new AjaxHelper();
	objAH.debug= true;
	objAH.url= '/cgi-bin/koha/catalogacion/visualizacionOPAC/visualizacionOpacDB.pl';
	objAH.encabezado= id;
	objAH.linea= linea;
	objAH.tipoAccion= 'UPDATE';
	objAH.tabla= 'ENCABEZADO';
	//se envia la consulta
	objAH.sendToServer();

}


//al seleccionar una fila se cambia el estilo para que se vea cual es la que se selecciona
function seleccionarFilaEncabezado(){
	$("#tablaEncabezados tr:not([tr.tablaresultadoTitle])").click(
				function () {
					zebra('tablaEncabezados');
				}
    	);
}

//*************************************Fin**Encabezados********************************************************

//Init Form
$(document).ready(function() {
	
	changeNivel();
	// Help
	$("#topichelp").hide();
	$("#tophelper img.showhelp ").click(function(){
						$("#topichelp").slideToggle('fast');
					});
});

</script>
<div style="text-align: right;"><span class="click" onClick="abrirVentanaHelperMARC();">Ayuda MARC</span></div>

<input type="hidden" id="idEncabezado">
<div style="position: static;" id="tophelper">
<img class="showhelp" src="/intranet-tmpl/blue/images/help.gif" alt="Descricion de la Ventana">
    <div style="display: block;" id="topichelp">
        <p>Descripcion breve para lo q sirve la ventana....</p>
    </div>
</div>

<br>

<table width="100%"  border="0" cellpadding="0" cellspacing="0" align="center">
	<tr>
		<td class="pagetitle" >Visualizaci&oacute;n de campos MARC en OPAC</td>
	</tr>
	<tr>	
		<td class="lineagruesa"  align="left" colspan="3"></td>
	</tr>

</table>
<br>

<div class="formElemets">
  <div>
<!-- contenedor superior -->
	<ul>
	<li>
		<select id="niveles_id" onChange="changeNivel();">
		<option value="1">Nivel1</option>
		<option value="2">Nivel2</option>
		<option value="3">Nivel3</option>
		</select>
		Tipo de item: [% selectItemType %]
		<input type="button" Title="Agregar Encabezado" onClick="agregarEncabezado()" value="Agregar" Title="Agregar un Encabezado">
	</li>
	<li>
		<div id="divTablaEncabezados">
		</div>
	</li>
	</ul>
  </div>
<br>
<ul>
<li>
	<p>
    <label for="campoX" style="float:left; width:13%">Seleccion: </label> 
    [% selectCampoX %]
    </p>
</li>
<li>
	<div id="result"></div>
</li>
<li>
	<label for="campo" style="float:left; width:13%">Campo: </label>
		<select name="campo" id="campo" onChange="eleccionCampo()">
			<option value="-1">Seleccionar Campo</option>
		</select>
</li>
<li>
	<label for="subcampo" style="float:left; width:13%">Subcampo: </label>
		<select name="subcampo" id="subcampo" onChange="eleccionSubCampo()">
			<option value="-1">Seleccionar SubCampo</option>
		</select>
</li>
<li>
	<label for="textoPredecesor" style="float: left; width:13%" >
	Texto predecesor:
	</label> 
	<input id="textoPredecesor" name="textoPredecesor" type="text" value="" size="30">
</li>
<li>
	<label for="textoSucesor" style="float: left; width:13%" >
	Texto sucesor:
	</label> 
	<input id="textoSucesor" type="text" value="" size="30">
</li>
<li>
	<label for="separador" style="float: left; width:13%" >
	Separador:
	</label> 
	<input id="separador" type="text" value="" size="30">
</li>
<li>
	<center>
	  <input id="guardar" type="button" value="Guardar" onClick="validarDatos();" disabled=true>
	  <input id="modificar" type="button" value="Modificar" style="display:none;"
		onClick="modificarDatos();">	
	</center>
</li>
<li>
	<div id="divTablaVisualizacion"></div>
	<br>
</li>
<ul>
</div>

[% INCLUDE "intranet-bottom.inc" %]
