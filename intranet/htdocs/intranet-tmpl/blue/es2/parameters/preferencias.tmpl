<!-- TMPL_INCLUDE NAME="intranet-top.inc" -->

<script src="/intranet-tmpl/blue/es2/includes/jquery/jquery.js"></script>
<script src="/intranet-tmpl/blue/es2/includes/jquery/tablesorter/jquery.tablesorter.js"></script>
<script src="/intranet-tmpl/blue/es2/includes/jquery/tablesorter/jquery.tablesorter.pager.js"></script>
<script src="/intranet-tmpl/blue/es2/includes/jquery/tablesorter/jquery.tablesorter.doblePaginador.js"></script>
<link href="/intranet-tmpl/blue/es2/includes/jquery/tablesorter/blue/style.css" type="text/css" rel="stylesheet">

<script src="/intranet-tmpl/blue/es2/includes/AjaxHelper.js"></script>
<script src="/intranet-tmpl/blue/es2/includes/util.js"></script>

<script language="JavaScript" type="text/javascript">

var objAH;//Objeto AjaxHelper.

$(document).ready( function() {
	buscarPreferencia();
	onEnter("buscar",buscarPreferencia);
});

/*
 * tablaOrdenada
 * Hace que la tabla con los resultados, se pueda ordenar por los campos correspondientes y tambien hace que se 
 * pueda usar dos paginadores.
 */
function tablaOrdenada(){
	var tabla=$("#tablaResultado").tablesorter({	
				widgets: ['zebra'],
				headers: { 0: { sorter: false},
					   4: { sorter: false},
					   5: { sorter: false}}
				});
	inicializacion(tabla);
}

/*
 * updateInfoConsulta
 * Actualizacion de los datos despues de una consulta ajax. El resultado se inserta en el div result.
 */
function updateInfoConsulta(responseText){
	$("#result").html(responseText);
	if(objAH.funcion == 1){
		tablaOrdenada();
	}
	HiddeState();
}

/*
 * updateInfoConsultaJSON
 * Actualizacion de los datos despues de una consulta ajax que trae un string json.
 * El resultado se procesa, para mostrar lo que corresponda.
 */
function updateInfoConsultaJSON(responseText){
	procesarJSON(responseText,objAH.idComp,objAH.funcionChange);
	HiddeState();
}


/*
 * buscarPreferencia
 * Busca todas las preferencias o las que se corresponden con el string ingresado para filtrar la busqueda.
 */
function buscarPreferencia(){
	objAH=new AjaxHelper(updateInfoConsulta, Init);
	objAH.url= "/cgi-bin/koha/admin/preferenciasResults.pl";
	objAH.buscar=$("#buscar").val();
	objAH.agregar=0;
	objAH.funcion=1;
	objAH.sendToServer();
	var compo=$("#tipoVar");
	compo.removeAttr("disabled");
}

/*
 * borrarDiv
 * Borra el div que contiene la parte de agregado de variables.
 */
function borrarDiv(){$("#divAgregar").html("");}

/*
 * agregarPref
 * Muestra la parte de agregado de una variable con los componentes correspondientes con el tipo de variable que
 * se eligio.
 */
function agregarPref(){
	var opcion=$("#tipoVar").val();
	borrarDiv();
	var ok=1;
	objAH=new AjaxHelper(updateInfoConsulta, Init);
	objAH.url= "/cgi-bin/koha/admin/preferenciasResults.pl";
	objAH.opcion=opcion;
	objAH.agregar=1;
	objAH.funcion=0;
	if(opcion == "combo"){
		var tabla=$("#tabla").val();
		var campo=$("#campo").val();
		if(tabla == -1 || campo == -1){ok=0;}
		else{objAH.tabla=tabla;
		     objAH.campo=campo;
		}
	}
	if(opcion == "valAuto"){
		var cat=$("#categoria").val();
		if(cat == -1){ok=0;}
		else{objAH.categoria=cat;}
	}
	if(ok){
		objAH.sendToServer();
	}
	else{alert("Elija una tabla de referencia");}
}

/*
 * selectOpcion
 * Dependiendo del tipo de variable a agregar, si se elige una tabla de referencia o algï¿½n valor autorizado, se
 * crean los componentes necesarios para representar la informancion que se necesita.
 */
function selectOpcion(){
	var tabla=$("#tabla");
	var categ=$("#categoria");
	var campo=$("#campo");
	var tipo=$("#tipoVar").val();
	borrarDiv();
	objAH=new AjaxHelper(updateInfoConsultaJSON, Init);
	objAH.url= "/cgi-bin/koha/admin/preferenciasResults.pl";
	objAH.tipo=tipo;
	objAH.json=1;
	if(tipo == "combo" && tabla.length == 0){
		objAH.idComp="tabla";
		objAH.funcionChange="onChange='elegirCampo()'";
		objAH.sendToServer();
	}
	else{
		if(tipo == "combo" && tabla.length == 1){tabla.show();campo.show();}
	}

	if(tipo == "valAuto" && categ.length == 0){
		objAH.idComp="categoria";
		objAH.funcionChange="onChange='elegirCampo()'";
		objAH.sendToServer();
	}
	else{
		if(tipo == "valAuto" && categ.length == 1){categ.show();}
	}

	if(tipo != "combo"){
		tabla.hide();
		campo.hide();
	}
	if(tipo != "valAuto"){ categ.hide();}
}

/*
 * elegirCampo
 * Cuando se selecciona una tabla de referencia se crea un listado con los campos de esa tabla.
 */
function elegirCampo(){
	var tabla=$("#tabla");
	var campo=$("#campo");
	var tipo=$("#tipoVar").val();
	borrarDiv();
	if(tipo == "combo" && tabla.length == 1){
		campo.remove();
		objAH=new AjaxHelper(updateInfoConsultaJSON, Init);
		objAH.url= "/cgi-bin/koha/admin/preferenciasResults.pl";
		objAH.tipo=tipo;
		objAH.json=1;
		objAH.tabla=tabla.val();
		objAH.idComp="campo";
		objAH.funcionChange="onChange='borrarDiv()'";
		objAH.sendToServer();
	}
}

/*
 * procesarJSON
 * Procesa el string json que viene como parametro, y crea el listado de opciones correspondiente y se inserta en
 * en donde corresponda.
 */
function procesarJSON(json, id,change){
	var objetos=JSONstring.toObject(json);
	var opciones="<option value='-1'>Elegir Opcion</option>";
	for(var i=0; i< objetos.length; i++){
		opciones=opciones+"<option value= '"+objetos[i].clave+"'> "+objetos[i].valor+"</option>";
	}
	var sel="<select id='"+id+"'"+change+">"+opciones+"</select>";
	$(sel).insertBefore("#boton");
}

/*
 * respuesta
 * Cuando se guarda una variable nueva se verifica si esta ya exite, si es asi se devuelve un error y se muestra
 * en la pantalla, de lo contrario se guarda la variable.
 */
function respuesta(responseText){
	if(responseText == 0){buscarPreferencia();}
	else{$("#error").html("La variable "+$("#variable").val()+" ya existe en el sistema");}
}

/*
 * guardarVariable
 * Hace el llamado ajax para poder guardar los datos ingresados para la variable.
 */
function guardarVariable(mod){
	objAH=new AjaxHelper(updateInfoGuardarVar, Init);
	objAH.url= "/cgi-bin/koha/admin/preferenciasResults.pl";
	objAH.variable=$("#variable").val();
	objAH.valor=$("#valor").val();
	objAH.explicacion=$("#explicacion").val();
	objAH.tipo=$("#tipoVar").val();
	objAH.json=1;
	objAH.guardar=1;
	objAH.modificar=mod;
	objAH.tabla=$("#tabla").val();
	objAH.campo=$("#campo").val();
	objAH.categoria=$("#categoria").val();
	objAH.sendToServer();
	if(mod){$("#tipoVar").attr("disabled","")}
}

/*
 * updateInfoGuardarVar
 * Funcion que se ejecuta cuando se guarda una variable. Si la variable no existe hace una busqueda para encontrar
 * todas las variables, si existe muestra un mensaje de error en la pantalla.
 */
function updateInfoGuardarVar(responseText){
	respuesta(responseText);
	$("#tabla").remove();
	$("#campo").remove();
	$("#categ").remove();
	HiddeState();
}

/*
 * limpiar
 * Borra el texto ingresado en el componente de busqueda.
 */
function limpiar(){$("#buscar").val("");}

/*
 * modificarVar
 * Hace el llamado ajax para poder modificar y mostrar la parte de modificacion de la variables seleccionada.
 */
function modificarVar(variable,tipo){
	var compo=$("#tipoVar");
	compo.val(tipo);
	compo.attr("disabled","disabled");
	objAH=new AjaxHelper(updateInfoConsulta, Init);
	objAH.url= "/cgi-bin/koha/admin/preferenciasResults.pl";
	objAH.variable=variable;
	objAH.agregar=1;
	objAH.modificar=1;
	objAH.sendToServer();
}

</script>

<p class="pagetitle">Administraci&oacute;n de Preferencias del Sistema</p>
<!-- PARA BUSCAR -->
<br>
<p>
	<input type="text" id="buscar" name="buscar" value="">
	<input type="image" alt="Buscar"  src="<!-- TMPL_VAR name='interface' -->/<!-- TMPL_VAR name='theme' -->/images/boton-buscar.png" onClick="buscarPreferencia()">
	<input type="image" name="clear" id="clear" alt="Limpiar" src="<!-- TMPL_VAR NAME='themelang' -->/images/borrar2.png" border="0" onClick="limpiar()">
</p>
<!-- PARA AGREGAR -->
<p>
	<select id="tipoVar" onChange="selectOpcion()">
		<option value="bool">Si-No</option>
		<option value="texta">Texto grande</option>
		<option value="text">Texto com&uacute;n</option>
		<option value="combo">Lista opci&oacute;n</option>
		<option value="valAuto">Valores autorizados</option>
	</select>
	<input id="boton" type="image" alt="Agregar Preferencia de Sistema"  src="<!-- TMPL_VAR name='interface' -->/<!-- TMPL_VAR name='theme' -->/images/agregar.png" onclick="agregarPref()">
</p>

<div id="result">

</div>

<!-- TMPL_INCLUDE NAME="intranet-bottom.inc" -->
