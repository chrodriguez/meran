[% INCLUDE "FormValidateHelper.inc" %]
[% INCLUDE  "AutocompleteHelper.inc"  %]
<script type="text/javascript" language="javascript" >
// dsp pasar a un .js

var array_ejemplares_id    = new Array() //global, arreglo con los ids de los ejemplares a agregar
var cant_ejemplares_array  = new Array() // global con las cantidades de ejemplares. Se corresponde la posicion con el de ejemplares_id

function buscarDatosNivel2(){
    objAH                   = new AjaxHelper(updateBuscarDatosNivel2)
    objAH.debug             = true
    objAH.showOverlay       = true
    
    objAH.url               = '/cgi-bin/koha/adquisiciones/recomendacionesDB.pl'
    objAH.tipoAccion        = 'BUSQUEDA_RECOMENDACION'
    objAH.idCatalogoSearch  = $('#catalogo_search_hidden').val()
    objAH.sendToServer()
}

function updateBuscarDatosNivel2(responseText){
    $('#ediciones').html(responseText)
    $('#edicion_id').val('').attr("selected",true)
    $('#edicion_id').change( function(){         
        cargarDatosEdicionSeleccionada()
    });
    if (!verificarRespuesta(responseText)) {
        return(0);
        var Messages=JSONstring.toObject(responseText)
        setMessages(Messages)
   }
}

function cargarDatosEdicionSeleccionada(){
    objAH                   = new AjaxHelper(updateCargarDatosEdicionSeleccionada)
    objAH.debug             = true
    objAH.showOverlay       = true
    objAH.url               = '/cgi-bin/koha/adquisiciones/recomendacionesDB.pl'
    objAH.tipoAccion        = 'CARGAR_DATOS_EDICION'
    objAH.edicion           = $('#edicion_id').val()
    objAH.idCatalogoSearch  = $('#catalogo_search_hidden').val()
    objAH.sendToServer();
}


function updateCargarDatosEdicionSeleccionada(responseText){
    $('#datos_edicion_seleccionada').html(responseText);    
}

function limpiarCampos(){
    $('#autor').val("")
    $('#titulo').val("")
    $('#edicion').val("")
    $('#lugar_publicacion').val("")
    $('#editorial').val("")
    $('#fecha').val("")
    $('#coleccion').val("")
    $('#isbn_issn').val("")
    $('#cant_ejemplares').val("")
}


function eliminarFila(filaId){
    $('#tr'+filaId).remove()
}


function agregarRenglon(){
    var id= $('#edicion_id').val()
    
    array_cantidad_ejemplares[array_ejemplares_id.length]   =  $('#cant_ejemplares').val()   
    cant_ejemplares_array[array_ejemplares_id.length]       = id               

    if( ($('#input'+id).val() == null) ){
        var autor               = $('#autor').val()
        var titulo              = $('#titulo').val()
        var edicion             = $('#edicion').val()
        var lugar_publicacion   = $('#lugar_publicacion').val()
        var editorial           = $('#editorial').val()
        var fecha               = $('#fecha').val()
        var coleccion           = $('#coleccion').val()
        var ISBN_ISSN           = $('#isbn_issn').val()
        var cant_ejemplares     = $('#cant_ejemplares').val()
      
        limpiarCampos();
            
        $('#tabla_recomendacion').append('<tr id="tr'+id+'" name='+id+'><input type="hidden" value="'+id+'" id="input'+id+'"><td>'+autor+'</td><td>'+titulo+'</td><td>'+edicion+'</td><td>'+lugar_publicacion+'</td>'+'<td>'+editorial+'</td><td>'+fecha+'</td><td>'+autor+'</td><td>'+coleccion+'</td><td>'+ISBN_ISSN+'</td>'+'<td>'+cant_ejemplares+'</td><td><input type="button" onclick="eliminarFila('+id+')"  value="X"></input></td></tr>')
        $('#recomendacion').show();     
     }
}

function appendPedidoCotizacion(formId){

    objAH                       = new AjaxHelper(updateAppendPedidoCotizacion)
    objAH.debug                 = true
    objAH.showOverlay           = true
    objAH.url                   = '/cgi-bin/koha/adquisiciones/pedidoCotizacionDB.pl'
    objAH.tipoAccion            = 'APPEND_PEDIDO_COTIZACION'
    
    objAH.pedido_cotizacion_id  = $('#pedido_cotizacion_id').val()
    objAH.ejemplares_ids_array  = array_ejemplares_id
    objAH.cant_ejemplares_array = cant_ejemplares_array
    objAH.sendToServer()
}

function updateAppendPedidoCotizacion(responseText){
    if (!verificarRespuesta(responseText)) {
        return(0);
        var Messages=JSONstring.toObject(responseText);
        setMessages(Messages);
   }
}

</script>

<script type="text/javascript" language="javascript">
    $(document).ready(function() {
        CrearAutocompleteCatalogo({ 
              IdInput: 'catalogo_search', 
              IdInputHidden: 'catalogo_search_hidden', 
              callBackFunction: buscarDatosNivel2,
        })
        $('#carga_manual').click(function(){        
                  $('#datos_edicion').hide()
        });
        $('#catalogo_search').blur(function(){        
                  limpiarCampos()
        });
        $('#recomendacion').hide();
        makeToggle('carga_manual','trigger',null,true);
        makeToggle('motivo','trigger',null,true);
        makeToggle('comentario','trigger',null,true);
    });
</script>

<div class="column1-unit">
    <div class="recomendacionform">
            <input type="hidden" name="action" value="agregar">
            </fieldset>
              
            <fieldset> <legend class="titulo_legend trigger click">[% "Busqueda de Datos del Material" | i18n %]</legend>
                <p><label for="catalogo_search" class="left">[% 'Palabra Clave:' | i18n %]</label>
                <input type='text' id='catalogo_search' name='catalogo_search' value='' size=40 tabindex='3' style="float: left"></p>
                <input type='hidden' id='catalogo_search_hidden' name='catalogo_search_hidden' value=''>                                
            </fieldset>
            <div id="ediciones"></div>
            <div id="datos_edicion_seleccionada"></div>
            <fieldset><legend class="titulo_legend trigger click">&nbsp;[% 'Motivo de la propuesta' | i18n %]&nbsp;</legend>
                <div class="motivo" id="motivo">
                    <textarea name="motivo_propuesta" id="motivo_propuesta" cols="45" class="required" rows="10" tabindex="17"></textarea>
                </div>
            </fieldset>
            <fieldset><legend class="titulo_legend trigger click">&nbsp;[% 'Comentarios' | i18n %]&nbsp;</legend>
                <div class="comentario" id="comentario">
                    <textarea name="comment" id="comment" cols="45" class="required" rows="10" tabindex="17"></textarea>
                    <input type="hidden" name="post_message" id="post_message" value="1"/>
                </div>
            </fieldset>  
            <form id="pedido_cotizacion_form" name="recom_form" method="post" action="adquisiciones/pedidoCotizacionDB.pl">       
            <fieldset  id="recomendacion"><legend class="titulo_legend trigger click">&nbsp;[% 'Recomendacion' | i18n %]&nbsp;</legend>
                <table id="tabla_recomendacion" class="tabla_datos" cellspacing='0' cellpadding='0'>
                    <thead>    
                        <th align="center">
                            [% "Autor" | i18n %]
                        </th>
                        <th align="center">
                            [% "T&iacute;tulo" | i18n %]
                        </th>
                        <th align="center">
                            [% "Edici&oacute;n" | i18n %]
                        </th>
                        <th align="center">
                            [% "Lugar de publicaci&oacute;n" | i18n %]
                        </th>
                        <th align="center">
                            [% "Editorial" | i18n %]
                        </th>
                        <th align="center">
                            [% "Fecha" | i18n %]
                        </th>
                        <th align="center">
                            [% "Colecci&oacute;n" | i18n %]
                        </th>
                        <th align="center">
                            [% "ISBN/ISSN" | i18n %]
                        </th>
                        <th align="center">
                            [% "Fecha" | i18n %]
                        </th>
                        <th align="center">
                            [% "Cantidad de ejemplares" | i18n %]
                        </th>
                        <th>
                            [% "Eliminar" | i18n %]
                        </th> 
                    </thead>
                    <tbody>
                    </tbody>
                </table>
                <input type="button" value="Agregar Pedido" onclick="appendPedidoCotizacion('pedido_cotizacion_form')">
            </fieldset>
            </form>           
    </div>         
</div>
