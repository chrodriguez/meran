[% INCLUDE   'intranet-top.inc'  %]

<script src="/includes/sha1.js"></script>  
<script src="/includes/pidcrypt.js"></script>  
<script src="/includes/pidcrypt_util.js"></script> 
<script src="/includes/md5.js"></script>
<script src="/includes/md5_cbc.js"></script>
<script src="/includes/aes_core.js"></script>
<script src="/includes/aes_cbc.js"></script>  



<script type="text/javascript">

function objeto_usuario(){
    this.text;
    this.ID;
}

function encriptar(texto_a_encriptar, key){
// AESEncryptCtr(plaintext, password, nBits)
//  * @param ciphertext source text to be encrypted
//  * @param password   the password to use to generate a key
//  * @param nBits      number of bits to be used in the key (128, 192, or 256)
// function AESDecryptCtr(ciphertext, password, nBits) 

//     var key= b64_sha256(b64_md5(key));
//     key = 'nEEhnZwM8ZdiFYYZpcixWnOUmCG57lvr6ksUJuiMXpo';
    var aes = new pidCrypt.AES.CBC();
    //encrypt the plaintext and returns the encrypted text
    //parameters: plaintext(String), password(String) and options
    var crypted = aes.encryptText(texto_a_encriptar, key, {nBits: 256});
    
    return crypted;
}

function desencriptar(texto_a_desencriptar, key){
    var aes = new pidCrypt.AES.CBC();
    var plain = aes.decryptText(texto_a_desencriptar, key, {nBits: 256, UTF8: false});

    return plain;
}


     //muestra los ejemplares del grupo
function guardarCambiarPassword(){

    var key= b64_sha256(b64_md5($('#actualpassword').val()));

    document.datosAEnviar.actual_password = encriptar($('#actualpassword').val(), key);
    document.datosAEnviar.new_password1.value = encriptar($('#newpassword1').val(), key);
    document.datosAEnviar.new_password2.value = encriptar($('#newpassword2').val(), key);
    document.datosAEnviar.usuario.value = usuario.ID;
    document.datosAEnviar.changePassword.value = 1;
    document.datosAEnviar.submit();
}

function updateGuardarCambiarPassword(responseText){
    var Messages= JSONstring.toObject(responseText);
    setMessages(Messages);
}

$(document).ready(function() {
    
    usuario= new objeto_usuario();
    usuario.text= "[% completo %]";
    usuario.ID= "[% nro_socio %]";

});

</script>

<form action='/cgi-bin/koha/usuarios/change_passwordDB.pl' method="post" name="datosAEnviar">
        <input type="hidden" name="new_password1">
        <input type="hidden" name="new_password2">
        <input type="hidden" name="usuario">
        <input type="hidden" name="changePassword">
        <input type="hidden" name="actual_password">
        <input type="hidden" name="token" value="[% token %]">
</form>

<div class="titulos">[% 'Cambio de contrase&ntilde;a obligatorio' | i18n %]

<div class='tableMsgUser'>
    <font class='fontMsgUser'>
        <b>
            <div id='mensajes'>
                [% mensaje %]
            </div>
        </b>
    </font>
</div>

[% IF nopermission %]
<!-- This is what is displayed if user doesn't have permission -->
<table align="center" width="100%">
	<tr>
    		<td align="center">Disculpe, Koha no cree que usted tenga permiso para esta p&aacute;gina.</td>
   	</tr>
</table>
[% END %]

[% IF timed_out %]
<!-- This is what is displayed if login has timed out -->
<table align="center" width="100%">
   <tr>
    <td align="center">Disculpe, su sesi&oacute;n ha caducado. Por favor ingrese nuevamente</td>
   </tr>
</table>
[% END %]

[% IF different_ip %]
<!-- This is what is displayed if user's IP has changed -->
<table align="center" width="100%">
   <tr>
    <td align="center">Esta accediendo a Koha desde una direcci&oacute;n IP diferente! Por favor ingrese nuevamente.</td>
   </tr>
</table>
[% END %]

[% IF invalid_username_or_password %]
<!-- This is what is displayed if the username or password doesn't work -->
<table align="center" width="100%">
   <tr>
    <td align="center">Ha ingresado un nombre de usuario o password incorrecto. Por favor intente nuevamente.</td>
   </tr>
</table>
[% END %]


[% IF passwordrepeted %]
 	<table align="center" width="100%">
	<tr>
	<td align="center"><font color="red">La contrase&ntilde;a no puede ser la misma que ten&iacute;a</font></td>
	</tr>
	</table>
[% END %]
<center>
<br>
<br>
<form method="post" name="datos">
<input type="hidden" name="newpassword">
<table border="0" cellpadding="0" cellspacing="0" width="60%">
    <tr><td align="center" valign="middle">

    <table border="0"  cellpadding="0" cellspacing="0">
    <tr>
        <td> <b>Contrase&ntilde;a Actual:</b></td>
            <td><input type="password" name="" id="actualpassword"></td>
    </tr>


	<tr>
		<td> <b>Nueva Contrase&ntilde;a:</b></td>
	     	<td><input type="password" name="newpassword1" id="newpassword1"></td>
    </tr>
	
	<tr><td>&nbsp;</td><td>&nbsp;</td></tr>
	<tr>
        <td><b>Repetir Contrase&ntilde;a:&nbsp;</b></td>
        <td><input type="password" name="newpassword2"  id="newpassword2"></td>
    </tr>
	<tr><td>&nbsp;</td><td>&nbsp;</td></tr>
	<tr><td colspan="2" align="center"><input type="button" value="Entrar" onClick="guardarCambiarPassword()"></td></tr>
    </table>
    </td></tr>
</table>
</form>


[% INCLUDE 'intranet-bottom.inc' %]
