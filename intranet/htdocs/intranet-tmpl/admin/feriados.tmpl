[% INCLUDE "intranet-top.inc" %]

[% INCLUDE 'datePicker.inc' %]

<script type="text/javascript">

    function contains(a, obj){
        for(var i = 0; i < a.length; i++) {
            if(a[i] === obj){
            return true;
            }
        }
        return false;
    }

    function deleteFromFECHAS(fecha){
        //Fecha Vieja
        var FECHAS_SEL= new Array();
        for(var i = 0; i < FECHAS.length; i++) {
            if(FECHAS[i]!=fecha){FECHAS_SEL.push(FECHAS[i]);}
        }
        FECHAS=FECHAS_SEL;
    }

    var FECHAS=new Array();
    var firstTime=1; //PORQUE MIERDA SE EJECUTA LA 1RA VEZ!!!

    function proximosFeriados(){

        objAH=new AjaxHelper(updateProximosFeriados);
        objAH.url=URL_PREFIX+'/admin/proximosFeriados.pl';
        objAH.sendToServer();
    }


    function updateProximosFeriados(responseText){
        $('#proximosFeriados').html(responseText);
    }

    function postFecha(date,stat,feriado){
        objAH=new AjaxHelper(updatePostFeriado);
        objAH.debug= true;
        objAH.showOverlay   = true;
        objAH.url=URL_PREFIX+'/admin/postFecha.pl';
        objAH.debug= true;
        objAH.date= date;
        objAH.stat= stat;
        objAH.feriado= feriado;
        objAH.sendToServer();
    }

    function updatePostFeriado(responseText){
        proximosFeriados();
    }

    function agregarFeriado(fecha){
          jPrompt('[% "Razón del Feriado" | i18n %]', '', '[% "Feriados" | i18n %]', function(texto) {
             if (texto){
                 postFecha(fecha,'true',texto);
                 FECHAS.push(fecha);
                }
            $('#calendarioFeriados').datepick('setDate', FECHAS);
          });
    }

    function eliminarFeriado(fecha,index) {
        jConfirm('[% "Eliminar el feriado" | i18n %] '+ fecha +' ?', '[% "Feriados" | i18n %]', function(r) {
                   if(r){
                         postFecha(fecha,'false','');
                         deleteFromFECHAS(fecha);
                        }
                $('#calendarioFeriados').datepick('setDate', FECHAS);
        });
    }


    $(function(){
        crearDatePickerMultiple('calendarioFeriados',4,999,
                function(dates){
                    if (firstTime){
                        firstTime=0;
                    }
                    else{
                        var dateSelected=dates.pop();//Esto me dá la última fecha seleccionada, salvo que no haya más fechas.
                        if (dateSelected){ 
                            dates.push(dateSelected);
                            var fecha= $.datepick.formatDate('dd/mm/yyyy',dateSelected);

                            if (!contains(FECHAS,fecha)){
                                //Fecha Nueva
                                agregarFeriado(fecha);
                            }
                            else{
                                //Fecha Vieja
                                var FECHAS_SEL= new Array();
                                for(var i = 0; i < dates.length; i++) {
                                    FECHAS_SEL.push($.datepick.formatDate('dd/mm/yyyy',dates[i]));
                                }

                                var fecha_borrada='';
                                var index;
                                for(var i = 0; i < FECHAS.length; i++) {
                                    if (!contains(FECHAS_SEL,FECHAS[i])){
                                        fecha_borrada = FECHAS[i];
                                        index=i;
                                    }
                                }
                                if(fecha_borrada){
                                    eliminarFeriado(fecha_borrada,index); 
                                }
                            }
                        }
                    }
                }
        );
        });

    $(document).ready(function(){
        [% FOREACH date IN dates %]
            FECHAS.push('[% date.getFecha %]');
        [% END %]

       $('#calendarioFeriados').datepick('setDate', FECHAS);
       proximosFeriados();
    }
    );

</script>

<fieldset>
    <legend class="titulos">[% "Feriados" | i18n %]</legend>

    <div style="float:left"  id="calendarioFeriados" >
    </div>

    <div style="float:right"  id="proximosFeriados" >
    </div>

</fieldset>


[% INCLUDE "intranet-bottom.inc" %]
