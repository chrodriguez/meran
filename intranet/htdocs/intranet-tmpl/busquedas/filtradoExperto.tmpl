[% INCLUDE "intranet-top.inc" %]

<!-- para manejar la ventana de campos MARC -->
<script src="/intranet-tmpl/includes/popups/helpCamposMARC.js"></script>


<script language="javascript" type="text/javascript">

var objAH;
function ordenarPor(orden){
	objAH.sort(orden);
}

function changePage(ini){
	objAH.changePage(ini);
}

// Realiza la busqueda RE AVANZADA!!!!
function busquedaReAvanzada(){
	var consulta = $('#consulta').val();
	if(consulta != ""){
		objAH=new AjaxHelper(updateInfo);
		objAH.url= '/cgi-bin/koha/busquedas/busquedaAvanzadaDB.pl';
		objAH.funcion= 'changePage';
		objAH.nivel1= $('#nivel1').val();
		objAH.nivel2= $('#nivel2').val();
		objAH.nivel3= $('#nivel3').val();
		objAH.nivel1rep= $('#n1r').val();
		objAH.nivel2rep= $('#n2r').val();
		objAH.nivel3rep= $('#n3r').val();
		objAH.operador= $(':checked').val();
		objAH.accion='buscar';
		objAH.sendToServer();
	}
	else{
		jAlert('[% "No ingreso datos para consultar" | i18n %]');
	}

}

// Hace una busqueda por el id del autor cuando se toca en el link del mismo.
function buscarPorAutor(idAutor){
	objAH=new AjaxHelper(updateInfo);
    jAlert();
	objAH.url= '/cgi-bin/koha/busquedas/busqueda.pl';
	objAH.idAutor= idAutor;
	objAH.sendToServer();
}

function updateInfo(responseText){
	$('#resultBusqueda').html(responseText);
	zebra('tablaResult');
}

// Crea el string con los campos correspondiente al campoX elegido
function seleccionCampoX(){
	objAH=new AjaxHelper(crearOpcionesCampo);
	objAH.url= '/cgi-bin/koha/busquedas/busquedaAvanzadaDB.pl';
	objAH.campoX= $('#campoX').val();
	objAH.accion='seleccionCampoX';
	objAH.sendToServer();
}

function crearOpcionesCampo(responseText){
	crearOpciones(responseText,"#campo");
}

// Crea el string con los subcampos correspondientes a el campo elegido.
function seleccionCampo(){
	var campo=$('#campo').val();
	campo=campo.split("/")[1];
	objAH=new AjaxHelper(crearOpcionesSubcampo);
	objAH.url= '/cgi-bin/koha/busquedas/busquedaAvanzadaDB.pl';
	objAH.campo= campo;
	objAH.accion='seleccionCampo';
	objAH.sendToServer();
}

function crearOpcionesSubcampo(responseText){
	crearOpciones(responseText,"#subcampo");
}

// Crea el select con los valores de la tabla de referencia que corresponde al campo elegido.
function buscarReferencia(){
	var campo=$('#mapeo').val();
	campo=campo.split("#")[1]
	objAH=new AjaxHelper(updateInfoReferencia);
	objAH.url= '/cgi-bin/koha/busquedas/busquedaAvanzadaDB.pl';
	objAH.campo= campo;
	objAH.accion='busquedaReferencia';
	objAH.sendToServer();
}

function updateInfoReferencia(responseText){
	ubicarComponente(responseText);
	eventoEnter("#valor1","primero");
}

//Ubica el componente que viene desde la llamada a ajax
function ubicarComponente(txt){
	$("#valor1").remove();
	$("#div1").append(txt);
}

//Crea las opciones de los select de los campos y subcampos con el string que llega de la llamada ajax
function crearOpciones(texto,id){
	var inputSel=$(id);
	var arreglo=texto.split("#");
	var i=0;
	var option=null;
	var txtnode;
	inputSel.html("");

	option = document.createElement("option");
	option.setAttribute("value", -1);
        option.appendChild(document.createTextNode("Elegir"));
        inputSel[0].appendChild(option);

	for(i;i<arreglo.length - 1;i++){
		option = document.createElement("option");
		option.setAttribute("value", arreglo[i]);
		if(id == "#campo"){
			txtnode=document.createTextNode(arreglo[i].split("/")[1]);
		}
		else{
			txtnode=document.createTextNode(arreglo[i]);
		}
        	option.appendChild(txtnode);
        	inputSel[0].appendChild(option);
	}
}

// Crea el texto a mostrar en el textarea y ingresa los campos a consultar en los input hidden que corresponda
function agregarConsulta(tipo){
	var ok=true;
	var campo;
	var tabla;
	var cond;
	var valor;
	var string;
	var textarea=$("#consulta");
	if(tipo=='primero'){
		valor=$("#valor1");
		var valorAMostrar;
		if(valor[0].type != "text"){
			valorAMostrar= valor[0].selectedIndex;
			valorAMostrar=valor[0].options[valorAMostrar].text;
		}
		else{
			valorAMostrar=valor.val();
		}
		if(valor.val() != ""){
			var mapeo=$("#mapeo").val();
			if(mapeo== -1){
				ok=false;
			}
			else{
				mapeo=mapeo.split("#");
				tabla=mapeo[0];
				campo=$("#mapeo option:selected").text();
				cond=$("#cond1").val();
				var hidden=$("#"+tabla);
				hidden.val(hidden.val() + mapeo[1]+"/"+cond+"/"+valor.val()+"#");
				string=campo+" "+cond+" "+valorAMostrar+"\n";
			}
		}
		else{
			ok=false;
		}
	}
	else{
		valor=$("#valor2");
		if(valor.val() != ""){
			campo=$("#campo").val();
			var subcampo=$("#subcampo").val();
			if(campo == -1 || subcampo == -1){
				ok=false;
			}
			else{
				tabla=campo.split("/")[0];
				campo=campo.split("/")[1];
				cond=$("#cond2").val();
				var hidden=$("#"+tabla);
				hidden.val(hidden.val()+campo+"/"+subcampo+"/"+cond+"/"+valor.val()+"#");
				string=campo+" "+subcampo+" "+cond+" "+valor.val()+"\n";
			}
		}
		else{
			ok=false;
		}
	}
	if(ok){
		textarea[0].appendChild(document.createTextNode(string));
	}
	else{
		jAlert("Datos incorrectos");
		valor[0].focus();
	}
	
}

// limpia las entradas de la consulta y los input hidden
function limpiar(){
	$('#nivel1').val("");
	$('#nivel2').val("");
	$('#nivel3').val("");
	$('#n1r').val("");
	$('#n2r').val("");
	$('#n3r').val("");
	$('#consulta').html("");
	$('#valor1').val("");
	$('#valor2').val("");
}

// Crea un formulario para poder mandar los parametros por post (no se muestran en la url), necesita un div con id
// formulario
function mostrarDetalle(id1){
	var params="id1="+id1;
	crearForm("/cgi-bin/koha/busquedas/detalle.pl",params);
}

//Agrega el evento keypress (en esta caso el enter), a los input que se ingresa el valor de la busqueda.
function eventoEnter(id,tipo){
	$(id).keypress(function (e) {
		if(e.which == 13){
			agregarConsulta(tipo);
 		}
	});
}


$(document).ready(function() {
	eventoEnter("#valor2","segundo");
});
</script>


<!-- PARA PODER CREAR EL FORMULARIO -->
<div id="formulario"></div>


<fieldset id="busqueda" class="clearFieldset">
	<legend class="titulo_legend">[% "B&uacute;squeda Experta en el cat&aacute;logo" | i18n %]</legend>
[% PERL %]
    print C4::AR::Filtros::ayuda_marc() ;
[% END %]
	<div class="formElemets">
		<ul class="listaCondicionesHorizontales">
			<li>
			    <div><input name="tipo" type=radio id=tipo value="AND" checked>Y (AND)</div>
			    <div><input name="tipo" type=radio id=tipo value="OR">O (OR)</div>
			</li>
			
			<li>
			   <fieldset>
               <legend class="titulo_legend"><label for="cond1">[% "Campo Meran:" | i18n %]</label></legend>
               <div>[% mapeo %]</div>
			    <div><label for="cond1">[% "Condici&oacute;n:" | i18n %]</label> 
                <select id="cond1">
						<option value="=">[% "Igual" | i18n %]</option>
						<option value="<>">[% "Distinto" | i18n %]</option>
						<option value=">">[% "Mayor" | i18n %]</option>
						<option value="<">[% "Menor" | i18n %]</option>
						<option value="Empieza">[% "Empieza" | i18n %]</option>
						<option value="Contiene">[% "Contiene" | i18n %]</option>
						<option value="Finaliza">[% "Finaliza" | i18n %]</option>
				</select>
				</div>
                <div><label for="valor1"> [% "Valor:" | i18n %] </label> 
                    <input type="text"  id="valor1">
                </div>
                <div>
                <input type="button" id="boton1" value="+" onClick="agregarConsulta('primero')">
                </div>
                </fieldset>
			</li>
			
			<li>
			   <fieldset>
               <legend class="titulo_legend"><label for="campoX">[% "Campo Marc:" | i18n %]</label></legend>
                <div>
                    <select id="campoX" onChange="seleccionCampoX()">
					    <option value="-1">[% "Elegir" | i18n %]</option>
                        <option value="0">0XX</option>
                        <option value="1">1XX</option>
                        <option value="2">2XX</option>
                        <option value="3">3XX</option>
                        <option value="4">4XX</option>
                        <option value="5">5XX</option>
                        <option value="6">6XX</option>
                        <option value="7">7XX</option>
                        <option value="8">8XX</option>
                        <option value="9">9XX</option>
                    </select>
                </div>
                <div>
                    <select id="campo" onChange="seleccionCampo()">
                        <option value="-1">[% "Elegir" | i18n %]</option>
				    </select>
                </div>
                <div>
				     <select id="subcampo">
					<option value="-1">[% "Elegir" | i18n %]</option>
				     </select>
                </div>
                <div>
			 <label for="cond2">[% "Condici&oacute;n:" | i18n %]</label> 
                      <select id="cond2">
						<option value="=">[% "Igual" | i18n %]</option>
						<option value="<>">[% "Distinto" | i18n %]</option>
						<option value=">">[% "Mayor" | i18n %]</option>
						<option value="<">[% "Menor" | i18n %]</option>
						<option value=[% "Empieza" | i18n %]>[% "Empieza" | i18n %]</option>
						<option value=[% "Contiene" | i18n %]>[% "Contiene" | i18n %]</option>
						<option value=[% "Finaliza" | i18n %]>[% "Finaliza" | i18n %]</option>
					  </select>
                </div>
                <div>
			<label for="valor2">[% "Valor:" | i18n %] </label>
            <input type="text"  id="valor2">
                </div>
                <div>
			<input type="button"  value="+" onClick="agregarConsulta('segundo')">
                </div>
			   </fieldset>
			</li>
			<li>
			   <fieldset>
               <legend class="titulo_legend"><label for="consulta">[% "Consulta:" | i18n %]</label></legend>
				<textarea id="consulta" cols="96" rows="7" readonly="readonly"></textarea>
			   </fieldset>
			</li>
		</ul>

		<ul class="listaMenuBotones-horizontal">
			<li>
                        [% PERL %]
                                print C4::AR::Filtros::to_Button(   text    => "[% 'Buscar' | i18n %]",
                                                                    boton   => "boton_buscar",
                                                                    onClick => "busquedaReAvanzada();",
                                                                    title   => "[% 'Buscar en el cat&aacute;logo' | i18n %]",
                                        ) ;
                        [% END %]
                        [% PERL %]
                                print C4::AR::Filtros::to_Button(   text    => "[% 'Limpiar' | i18n %]",
                                                                    boton   => "boton_buscar",
                                                                    onClick => "limpiar();",
                                                                    title   => "[% 'Limpiar el formulario' | i18n %]",
                                        ) ;
                        [% END %]
			</li>
		</ul>

	</div>
</fieldset>
<input type="hidden" id="nivel1">
<input type="hidden" id="nivel2">
<input type="hidden" id="nivel3">
<input type="hidden" id="n1r">
<input type="hidden" id="n2r">
<input type="hidden" id="n3r">
<fieldset id="busqueda">
	<legend class="titulo_legend">[% "Resultados de la B&uacute;squeda Experta" | i18n %]</legend>
<div id="resultBusqueda"></div>

</fieldset>


[% INCLUDE "intranet-bottom.inc" %]
