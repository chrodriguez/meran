<!-- TMPL_INCLUDE NAME="intranet-top.inc" -->


<script src="/intranet-tmpl/blue/es2/includes/jquery/jquery.js"></script>

<script src="/intranet-tmpl/blue/es2/includes/json/jsonStringify.js"></script>

<!-- TMPL_INCLUDE NAME="helpCamposMARC.inc" -->

<link href="/intranet-tmpl/blue/es2/includes/jquery/jquery.autocomplete.css" type="text/css" rel="stylesheet">
 

<script>
//Agrego el codigo para mostrar el estado de la busqueda en Ajax
<!-- TMPL_INCLUDE NAME="state.js" -->
//funciones para la parte de agregar un campo temporal son las misma que se usan en el tmpl de catalogacion.
<!-- TMPL_INCLUDE NAME="seleccionCamposMarc.js" -->
// funciones para asignar a los componentes que corresponda la funcion de autocomplete.
<!-- TMPL_INCLUDE NAME="autocompletables.js" -->
//funciones para crear los componenentes segun los datos que se obtienen de la base de datos.
<!-- TMPL_INCLUDE NAME="crearComponentes.js" -->


/*
 * CrearAutocomplete1
 * Asigna la funcion de autocomplete a el input text del autor.
 */
function CrearAutocomplete1(nivel){
	if(nivel==1){
		crearAuto("autor","autores","reemplazar","idAutor");
	}
	
}

/*
 * consultarAjax
 * Funcion que realiza el llamado ajax para realizar las operaciones correspondientes segun los parametros, cuando
 * se completa realiza otro llamado ajax para obtener los datos necesarios para crear las componentes 
 * correspondientes a los parametros recibidos.
 */
function consultarAjax(params,nivel,paramsJSON){
	var url="/cgi-bin/koha/acqui.simple/agregarItemResultsDB.pl";
	var paso=nivel;
	if(nivel==3){
		paso=2;
	}
	$.ajax({
		type: "POST",
		url: "/cgi-bin/koha/acqui.simple/agregarItemResults.pl",
		data: params,
		beforeSend: Init,
		complete: function(ajax){
				$("#result2").html(ajax.responseText);
				CrearAutocomplete1(nivel);
				HiddeState();
				consultarAjaxJSON(paso,paramsJSON,url);
			}
	});
}

/*
 * seleccionTipoItem
 * Funcion que se ejecuta cuando se seleccion un valor del combo itemtype.
 */
function seleccionTipoItem(){
	$("#result").html("");
	var params="itemtype="+$("#itemtype").val()+"&nivel=1&paso=1";
	consultarAjax(params,1,"");
}

/*
 * borrarN1
 * Elimina de la base de datos el documento con id1 igual al parametro que ingresa y todos los otros datos 
 * correspondiente a los otros niveles que hacen referencia al id1.
 */
function borrarN1(id1){
	$("#result").html("");
	var params="id1="+id1+"&itemtype="+$("#itemtype").val() +"&nivel=1&accion2=borrar";
	consultarAjax(params,1,"");
}

/*
 * modificarN1
 * Funcion que obtiene los datos ingresados en el nivel 1 para poder crear los componentes con los valores
 * guardados en la base de datos y poder modificarlos.
 */
function modificarN1(id1){
	$("#result").html("");
	var params= "id1="+id1+"&itemtype="+ $("#itemtype").val() +"&nivel=1&accion=modificarN1";
	var paramsJSON="id1="+id1+"&accion=modificarN1"+"&itemtype=ALL";
	consultarAjax(params,1,paramsJSON);
}

/*
 * borrarGrupo
 * Elimina de la base de datos el grupo correspodiente a los parametros que ingresan, y los ejemplares que hay en 
 * ese grupo.
 */
function borrarGrupo(id1,id2){
	$("#result").html("");
	var params= "id1="+id1+"&id2="+id2+"&itemtype="+ $("#itemtype").val() +"&accion2=borrarN2";
	consultarAjax(params,2,"");
}

/*
 * ajaxModificarGrupo
 * Funcion que realiza el llamado ajax para dibujar los componentes en la pantalla de un grupo.
 * retorna strign en json.
 */
function ajaxModificarGrupoJSON(id1,id2){
	var params="id1="+id1+"&id2="+id2+"&json=1";
	$.ajax({
		type: "POST",
		url: "/cgi-bin/koha/acqui.simple/editarGrupo.pl",
		data: params,
		beforeSend: Init,
		complete: function(ajax){
				procesarInfoJson(ajax.responseText);
				HiddeState();
			}
	});
}

/*
 * modificarGrupo
 * Dibuja la pagina donde se van a colocar los componentes que se creen a partir del llamado ajax con json.
 */
function modificarGrupo(id1,id2){
	$("#result").html("");
	var params="id1="+id1+"&id2="+id2+"&json=0";
	$.ajax({
		type: "POST",
		url: "/cgi-bin/koha/acqui.simple/editarGrupo.pl",
		data: params,
		beforeSend: Init,
		complete: function(ajax){
				$("#contenido").html(ajax.responseText);
				ajaxModificarGrupoJSON(id1,id2);
				HiddeState();
			}
	});
}


/*
 * modNivel2
 * Guarda en la base de datos los cambios hechos al grupo con id= id2.
 */
function modNivel2(id1,id2){
	var ok=1;
	var cantIds=$("#cantIds").val();
	ok=obtenerIdsValores(cantIds);
	var itemtype=$("#itemtype").val();
	var params="id1="+id1+"&itemtype="+itemtype;
	if(ok){
		var str=JSONstring.make(arrayjson);
		$.ajax({
			type: "POST",
			url: "/cgi-bin/koha/acqui.simple/editarGrupo.pl",
			data: "cantIds="+cantIds+"&id1="+id1+"&id2="+id2+"&respuesta="+str+"&accion=modNivel2&json=0",
			beforeSend: Init,
			complete: function(ajax){
				HiddeState();
				location.href="agregarItem.pl?origen=ModNivel2&itemtype="+itemtype+"&id1="+id1;
			}
		});
	}
	else{
		alert("Por favor complete los campos del formulario que son obligatorios");
	}
}

/*
 * ajaxAgregarEjemplarJSON
 * Funcion que realiza el llamado ajax para dibujar los componentes en la pantalla del ejemplar a agregar.
 * retorna strign en json.
 */
function ajaxAgregarEjemplarJSON(params){
	params=params + "&json=1";
	$.ajax({
		type: "POST",
		url: "/cgi-bin/koha/acqui.simple/agregarEjemplar.pl",
		data: params,
		beforeSend: Init,
		complete: function(ajax){
				procesarInfoJson(ajax.responseText);
				HiddeState();
			}
	});
}

/*
 * agregarEjemplar
 * Dibuja la pagina donde se van a colocar los componentes que se generen a partir de la consulta ajax
 */
function agregarEjemplar(id1,id2,itemtype){
	$("#result").html("");
	var params="id1="+id1+"&id2="+id2+"&itemtype="+itemtype;
	$.ajax({
		type: "POST",
		url: "/cgi-bin/koha/acqui.simple/agregarEjemplar.pl",
		data: params + "&json=0",
		beforeSend: Init,
		complete: function(ajax){
				$("#contenido").html(ajax.responseText);
				HiddeState();
				ajaxAgregarEjemplarJSON(params);
			}
	});
}

/*
 * agregarNivel3
 * Guarda en la base de datos el ejemplar que se quiere agregar.
 */
function agregarNivel3(id1,id2){
	var ok=1;
	var itemtype=$("#itemtype").val();
	var cantIds=$("#cantIds").val();
	ok=obtenerIdsValores(cantIds);
	var barcodes=$("#codbarra").val();
	var cantItems=$("#cantitems").val();
	
	if(ok){
		var str=JSONstring.make(arrayjson);
		$.ajax({
			type: "POST",
			url: "/cgi-bin/koha/acqui.simple/agregarEjemplar.pl",
			data: "cantIds="+cantIds+"&id1="+id1+"&id2="+id2+"&respuesta="+str+"&cantItems="+cantItems+"&barcodes="+barcodes+"&accion=agregarNivel3",
			beforeSend: Init,
			complete: function(ajax){
				HiddeState();
				location.href="agregarItem.pl?id1="+id1+"&itemtype="+itemtype;
			}
		});
	}
	else{
		alert("Por favor complete los campos del formulario que son obligatorios");
	}
}



/*
 * guardarDatos
 * Combierte el arreglo con los datos de los componentes y los valores ingresado en un string (con json) para
 * poder mandarlo por parametro y poder guardarlos en la base de datos.
 */
function guardarDatos(paso){
	var str=JSONstring.make(arrayjson);
	var params="paso=" +  paso +
		"&itemtype=" +  $("#itemtype").val() +
		"&respuesta=" +  str +
		"&cantIds=" +  $("#cantIds").val() +
		"&id1=" +  $("#id1").val();
	if(paso==2){
 		params=params + "&idAutor=" + $("#idAutor").val() +
			"&accion=" + $("#accion").val() + "&nivel=" + paso;
	}
	if(paso==3){
		params=params + "&codbarra=" + $("#codbarra").val() +
			"&cantitems=" + $("#cantitems").val() +
			"&nivel=2";
	}
	consultarAjax(params,paso,"");
}

/*
 * guardarItem
 * Obtiene los valores de los datos ingresados. Y si los campos obligatorios no estan en blanco los guarda.
 */
function guardarItem(paso){
	var ok=1;
	var cantIds=$("#cantIds").val();
	ok=obtenerIdsValores(cantIds);
	if(ok){
		guardarDatos(paso+1);
		$("#result").html(""); //limpia la div result (agregar campo temporal)
	}
	else{
		alert("Por favor complete los campos del formulario que son obligatorios");
	}
}


/*
 * agregarNivel2
 * Carga los componentes necesarios a la pagina para poder agregar un grupo al documento con el id1
 * Esta funcion se ejecuta cuando se viene de la pagina busqEjemplar.pl
 */
function agregarNivel2(array){
	var id1=array[0].split('=')[1];
	var itemtype=array[1].split('=')[1];
	var paramsJSON="id1="+id1+"&itemtype="+itemtype;
	var params=paramsJSON + "&accion2=agregarN2&nivel=2&paso=2";
	consultarAjax(params,2,paramsJSON);
}


function modificarDetalleGrupo(id1,id2,itemtype){
	$.ajax({
		type: "POST",
		url: "/cgi-bin/koha/acqui.simple/agregarItemResults.pl",
		data: "itemtype="+itemtype+"&id1="+id1+"&accion2=agregarN2&nivel=2&paso=2",
		beforeSend: Init,
		complete: function(ajax){
				$("#result2").html(ajax.responseText);
				HiddeState();
				modificarGrupo(id1,id2);
			}
	});
}

//Funcion que se ejecuta cuando se carga la pagina, dependiendo de donde viene ejecuta las funciones correspondientes.
$(document).ready( function() {
	var array = location.href.split('?');
	if (array.length >1){
		var array=array[1].split('&');
		var origen=array[0].split('=')[1];
		switch(origen){
		  case "detalle":
			var nivel=array[1].split('=')[1];
			var itemtype=array[2].split('=')[1];
			var id1=array[3].split('=')[1];
			if(nivel==1){
				var params="id1="+id1+"&itemtype="+ itemtype +"&nivel=1&accion=modificarN1";
				var paramsJSON="id1="+id1+"&accion=modificarN1"+"&itemtype=ALL";
				consultarAjax(params,1,paramsJSON);
			}
			if(nivel==2){
				var id2=array[4].split('=')[1];
				modificarDetalleGrupo(id1,id2,itemtype);
			}
			break;
		  case "ModNivel2":
			var itemtype=array[1].split('=')[1];
			var id1=array[2].split('=')[1];
			var params="id1="+id1+"&itemtype="+ itemtype +"&nivel=2&accion=modificarN2";
			var paramsJSON="id1="+id1+"&itemtype="+itemtype;
			consultarAjax(params,3,paramsJSON);
			break;
		  default:
			agregarNivel2(array);
			break;
		}
	}
} );



</script>



<p class="pagetitle" >Agregar Documento</p>

Esquema de ingreso de datos tipo: <!-- TMPL_VAR NAME="selectItemType" -->
<br><br>

<!-- div que se genera con el llamdo de ajax para la parte de llenado de los campos -->
<div id= "result2"></div>
<br>
<!-- div que se genera con el llamdo de ajax para la parte del agregado temporal de campos -->
<div id= "result" style="clear:both"></div>



<!-- TMPL_INCLUDE NAME="intranet-bottom.inc" -->

