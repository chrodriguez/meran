[% INCLUDE "intranet-top.inc" %]

<script type="text/javascript" language="javascript">

    $(document).ready( function() {
	    makeDataTable('#prestamosVencidos');
	    checkedAll("prestamos_vencidos", "prestamo");
    });
    
    var selected = new Array();

    function enviarMailsATodos(){

        objAH                   = new AjaxHelper(updateEnviarMailsATodos);
        objAH.url               = URL_PREFIX+"/admin/circulacion/prestamos_vencidosDB.pl";
        objAH.showOverlay       = true;
        objAH.tipoAccion        = "ENVIAR_TODOS_MAILS_PRESTAMOS_VENCIDOS";
        objAH.sendToServer();

    }

    function updateEnviarMailsATodos(responseText){

        var Messages=JSONstring.toObject(responseText);
        setMessages(Messages);

    }
    
    function enviarMailsASeleccionados(){

        objAH                   = new AjaxHelper(updateEnviarMailsASeleccionados);
        objAH.url               = URL_PREFIX+"/admin/circulacion/prestamos_vencidosDB.pl";
        objAH.showOverlay       = true;
        objAH.tipoAccion        = "ENVIAR_A_SELECCION_MAILS_PRESTAMOS_VENCIDOS";
        getSeleccionados();
        objAH.ids_prestamos     = selected;
        objAH.sendToServer();

    }

    function updateEnviarMailsASeleccionados(responseText){

        // limpia esta variable sino quedan prestamos viejos
        selected = new Array();
        var Messages=JSONstring.toObject(responseText);
        setMessages(Messages);

    }
    
    // devuelve los id de los prestamos seleccionados
    function getSeleccionados(){
    
        var checkeds   = $("tr input[type='checkbox']:checked");

        if (checkeds.length > 0){
        
            //alert(selected[0].id)
            
            for(i = 0; i < checkeds.length; i++) {
                selected.push(checkeds[i].id);
            }
            
        }else{
        
            jAlert(POR_FAVOR_SELECCIONE_ALGUN_PRESTAMO);
            
        }

        
    }

</script>

<fieldset>
    <legend class="titulo_legend">[% "Pr&eacute;stamos vencidos" | i18n %] </legend>
        [% IF cantidad  %]
 [% IF cantidad  %]
      [% PERL %]
                print C4::AR::Filtros::tableHeader(   
                                  id              => "prestamosVencidos",
                                  class           => "",
                                  selectAll_id    => "prestamos_vencidos",
                                  columns         => ['[% "Tipo de pr&eacute;stamo"|i18n %]','[% "Fecha de pr&eacute;stamo"|i18n %]',
                                                      '[% "Ejemplar"|i18n %]','[% "N&uacute;mero de Socio"|i18n %]',
                                                     ]
                                                                   
                                        ) ;
      [% END %]

			<tbody>
		      [% FOREACH prestamo IN prestamos %]
		      	<tr>
		     		<td>
		     		    <input type="checkbox" id="[% prestamo.getId_prestamo %]" name="prestamo" >
				    </td>
				
		          	<td>
		                [% prestamo.getTipo_prestamo %]
				    </td>
		          	<td>
		          	    [% prestamo.getFecha_prestamo %]
				    </td>
				    <td>
		          	    [% prestamo.nivel3.codigo_barra %]
				    </td>
		     		<td>
		                [% prestamo.socio.getNro_socio %]
				    </td>
		
		        </tr>
		      [% END %]
		     </tbody>
		    <tfoot>
		    <tr>
		      <td>[% PERL %]
		              print C4::AR::Filtros::action_button(
		                                              button       => "btn click btn-warning",
		                                              action       => "enviarMailsATodos();",
		                                              icon         => "",
		                                              title        => "Enviar a todos",
		                                          ) ;
		       
		      [% END %]
		      [% PERL %]
		              print C4::AR::Filtros::action_button(
		                                              button       => "btn click btn-primary",
		                                              action       => "enviarMailsASeleccionados();",
		                                              icon         => "",
		                                              title        => "Enviar a seleccionados",
		                                          ) ;
		       
		      [% END %]</td>
		    </tr>
		    </tfoot>
  </table>
[% ELSE %]
    <div class="well">
        <div class="resultados_consulta">[% "No hay pr&eacute;stamos vencidos" | i18n %]</div> 
    </div>      
[% END %]

   

<!--<button class="clean-gray" onclick="enviarMailsASeleccionados();">Enviar a Seleccionados</button>-->
</fieldset>

[% INCLUDE "intranet-bottom.inc" %]
