[% INCLUDE  "intranet-top.inc" %]

<script src="/intranet-tmpl/includes/circulacion.js"></script>
<script src="/intranet-tmpl/includes/catalogacion.js"></script>

<!-- Se incluyen las librerias necesarias para manejar autocomplete -->
[% INCLUDE "AutocompleteHelper.inc" %]

<script>

/*=================================================================REVISADO===================================================================*/

function inicializar(){
	ID_N1=0; //para saber el id del nivel 1
	ID_N2=0; //para saber el id del nivel 2
	ID_N3=0; //para saber el id del nivel 3
}

// function borrarNivel1(id1) implementado en catalogacion.js

function updateBorrarN1(responseText){
    var info=JSONstring.toObject(responseText);  
    //se borrar el nivel 1 y en cascada nivel 2 y 3 si esta permitido
    //se refresca la info   
    var Messages = info.Message_arrayref;
    setMessages(Messages);
    if (! (hayError(Messages) ) ){
        //oculto todo el registro con los grupos y sus items
        $('#detalleComun').slideUp('slow');
        //borro el contenido
        $('#detalleComun').html('');
    }
}

// function borrarN2(id2) //esta implementado en catalogacion.js

function updateBorrarN2(responseText){
    var info=JSONstring.toObject(responseText);  
    var Messages= info.Message_arrayref;
    setMessages(Messages);
    if (! (hayError(Messages) ) ){
        //oculto todo el grupo con los items
        $('#grupo'+objAH.id2).slideUp('slow');
        //borro el contenido
        $('#fieldset_grupo'+objAH.id2).html('');
    }
}

function borrarN3(id2, id3){
//id2 es necesario para luego de eliminar un ejemplar, se debe refrescar los ejemplares del nivel3

    jConfirm(ESTA_SEGURO_QUE_DESEA_BORRARLO,CATALOGO_TITLE, function(confirmStatus){if (confirmStatus) {
		ID_N2= id2;
		objAH=new AjaxHelper(updateBorrarN3);
		objAH.debug= true;
		objAH.url="/cgi-bin/koha/catalogacion/estructura/estructuraCataloDB.pl";
 		objAH.id3_array= [id3];
		objAH.nivel=3;
		objAH.itemtype=$("#id_tipo_doc").val();
		objAH.tipoAccion="ELIMINAR_NIVEL";
		objAH.sendToServer();
	}
});
}

function updateBorrarN3(responseText){
    var info=JSONstring.toObject(responseText);  
    var Messages= info.Message_arrayref;
    setMessages(Messages);
    if (! (hayError(Messages) ) ){
	    ejemplaresDelGrupo(ID_N2);
    }
}

//muestra los ejemplares del grupo
function ejemplaresDelGrupo(id2){

	objAH=new AjaxHelper(updateEjemplaresDelGrupo);
	objAH.debug= true;
	objAH.url= '/cgi-bin/koha/catalogacion/estructura/estructuraCataloDB.pl';
	objAH.id2= id2;
	objAH.tipoAccion= 'MOSTRAR_DETALLE_NIVEL3';
	//se envia la consulta
	objAH.sendToServer();

}

function updateEjemplaresDelGrupo(responseText){
	$('#ejemplaresDelGrupo'+objAH.id2).html(responseText);
	zebra('tablaResult');
}


function buscarUsuario(id2, id3){
	objAH=new AjaxHelper(updateBuscarUsuario);
	objAH.debug= true;
    objAH.url='/cgi-bin/koha/utils/pop_ups.pl';
    objAH.pop_up_template= 'buscar_usuario'; 
	objAH.debug= true;
	objAH.sendToServer();

	items_array[0]=id3;
 	ID_N2= id2;
}

function updateBuscarUsuario(responseText){

	vBuscarUsuario=new WindowHelper({draggable: true, opacity: true});
	vBuscarUsuario.debug= true;
	vBuscarUsuario.html=responseText;
	vBuscarUsuario.create();	
	vBuscarUsuario.titulo= 'Buscar Usuario';
	vBuscarUsuario.height('30%');
	vBuscarUsuario.width('40%');
	vBuscarUsuario.focus= 'campoUsuario';
	vBuscarUsuario.open();
}

/*=============================================================FIN====REVISADO================================================================*/

function detalleMARC(id3){
	objAH=new AjaxHelper(updateInfoMARC);
	objAH.debug= true;
	objAH.url= "/cgi-bin/koha/busquedas/MARCDetalle.pl";
	objAH.id3= id3;
	//se envia la consulta
	objAH.sendToServer();
}

function updateInfoMARC(responseText){
	$('#detalleComun').slideUp("slow");
	$('#detalleMARC').html(responseText);
	$('#detalleMARC').show();
	scrollTo('detalleMARC');
}

function verDivs(){
	$('#detalleComun').slideDown("slow");
	$('#detalleComun').show();
	$('#detalleMARC').slideUp("slow");
// 	scrollTo('ejemplaresDelGrupo'+ID_N2);
}

/*************************************************CIRCULACUION***************************************************/
// ESTO PARECE QUE NO SE VA A USAR
function objeto_datos(){
	this.array_ids3;
	this.usuario;
	this.id3;
	this.accion;
}


/******************************************CIRCULACUION DESDE EL DETALLE****************************************/
var items_array = new Array();
// parche, ver si se puede hacer mejor
var grupo;


function renovarPrestamo(userId,userNom,id2,id_prestamo){
	

	USUARIO=new objeto_usuario();
	USUARIO.ID=userId;
	USUARIO.text=userNom;

	objAH=new AjaxHelper(generaDivRenovacion); //generaDivRenovacion esta en circulacion.js
	objAH.debug= true;
	objAH.url= '/cgi-bin/koha/circ/circulacionDB.pl';
	objAH.tipoAccion= 'RENOVACION';
	array=new Array;
	array[0]= id_prestamo;
	objAH.datosArray= array;
	objAH.nro_socio= USUARIO.ID;
	//se envia la consulta
	objAH.sendToServer();
	//guardo el id2 para actualizar los ejemplares del grupo, por ahora lo hago asi!!!!!!!
	ID_N2= id2;
}

function devolverPrestamo(userId,userNom,id2,id_prestamo){

	array=new Array;
	array[0]= id_prestamo;
	USUARIO=new objeto_usuario();
	USUARIO.ID=userId;
	USUARIO.text=userNom;

	objAH=new AjaxHelper(generaDivDevolucion); //llama a generar div de ciculacion.js
	objAH.debug= true;
	objAH.url= '/cgi-bin/koha/circ/circulacionDB.pl';
	objAH.tipoAccion= 'DEVOLUCION';
	objAH.datosArray= array;
	objAH.nro_socio= USUARIO.ID;
	//se envia la consulta
	objAH.sendToServer();
	//guardo el id2 para actualizar los ejemplares del grupo, por ahora lo hago asi!!!!!!!
	ID_N2= id2;
}

/*
* REDEFINIDA, se encuentra definida en circulacion.js
*/
function updateInfoRenovar(responseText){
	cancelarDiv();

	var infoHash= JSONstring.toObject(responseText);
	var messageArray= infoHash.messages;
	var ticketsArray= infoHash.tickets;
	//Mensajes 
	for(i=0; i<messageArray.length;i++){
  		setMessages(messageArray[i]);
	}
	//Tickets si hay
	for(i=0; i<ticketsArray.length;i++){
		imprimirTicket(ticketsArray[i].ticket,i);
	}

	ejemplaresDelGrupo(ID_N2);
	inicializar();
}

/*
* REDEFINIDA, se encuentra definida en circulacion.js
*/
function updateInfoDevolver(responseText){
	cancelarDiv();

	var infoHash= JSONstring.toObject(responseText);
	var messageArray= infoHash.Messages_arrayref;
	setMessages(messageArray);

	ejemplaresDelGrupo(ID_N2);
	inicializar();
}

function confirmarPrestamo(){

	if( $('#campoUsuario').val() != ''){
		objAH=new AjaxHelper(generaDivPrestamo);
		objAH.debug= true;
		objAH.url= '/cgi-bin/koha/circ/circulacionDB.pl';
		objAH.tipoAccion= 'CONFIRMAR_PRESTAMO';
		objAH.datosArray= items_array;
		objAH.nro_socio= USUARIO.ID;
		//se envia la consulta
		objAH.sendToServer();
		vBuscarUsuario.close();
	}else{
		jAlert(INGRESE_EL_USUARIO);
		$('#campoUsuario').focus();
	}
}


//esta funcion esta REDEFINIDA de la libreria de circulacion.js, es invocada desde la funcion prestar()
function updateInfoPrestarReserva(responseText){
	cancelarDiv();

	var infoHash= JSONstring.toObject(responseText);
	var messageArray= infoHash.messages;
	var ticketsArray= infoHash.tickets;
	var mensajes= '';
	for(var i=0; i<messageArray.length;i++){
		imprimirTicket(ticketsArray[i].ticket,i);
  		setMessages(messageArray[i]);
	}
	ejemplaresDelGrupo(ID_N2);
}


/************************************************FIN CIRCULACUION************************************************/

$(document).ready(function(){
	inicializar();
	zebra("tablaResult");	
});

</script>

<div id="confirmar_div" class="pane"></div>
<br>


<!-- PARA PODER CREAR EL FORMULARIO -->
<div id="formulario"></div>

<div id="detalleMARC"></div>

<div id="detalleComun">
<div id="titulo">
	<p class="titulos"> 
		[% titulo %]
		[% FOREACH datosautor %]
			(<a class="click" onClick="filtroPorAutor([% id %])">[% completo %]</a>)
		[% END %]
	</p>
</div>

<!-- ---------------Registro de libro TABLE------- -->



<fieldset>
<strong><legend>[% "Detalles de Nivel 1 registro" | i18n %] [% id1 %]</legend></strong>

<div class="detalle">

    [% PERL %]
        print C4::AR::Filtros::link_to( text =>     C4::AR::Filtros::to_Icon( boton   => "icon_edicion" ),
                                        url =>      "datosDocumento.pl", 
                                        params =>   ["id1=[% id1 %]","tipoAccion=MODIFICAR_NIVEL_1"],
                                        title =>    "[% 'Editar Nivel 1' | i18n %]"
                                    ) ;
    [% END %]

    [% PERL %]
        print C4::AR::Filtros::to_Icon(    
                                            boton   => "icon_borrar",
                                            onClick => "borrarN1([% id1 %]);",
                                            title   => "[% 'Borrar Nivel 1' | i18n %]",
                ) ;
    [% END %]
    
	<ul class="listado_sin_margen">
    [% FOREACH nivel1 %]
		[% IF liblibrarian %]
			[% IF dato %]
			<li>	[% liblibrarian %]: <strong>[% dato %]</strong></li>
			[% END %]
		[% END %]

	[% END %]
	</ul>
	N&uacute;mero Total de Ejemplares:<b> [% cantItemN1 %]</b> 
</div>
</fieldset>
[% FOREACH nivel2 %]
<div id="fieldset_grupo[% id2 %]">
<fieldset>
<strong><legend>[% "Detalles de Nivel 2 para registro" | i18n %] [% id2 %] GRUPO - [% tipo_documento %]</legend></strong>

        <div id="grupo[% id2 %]">
        
        <div class="detalle">
        <!-- NIVEL 2 -->
	        <div id="[% id2 %]" style="position: relative; float:right;"></div>
	        [% PERL %]
		        print C4::AR::Filtros::link_to(	text => 	C4::AR::Filtros::to_Icon( boton   => "icon_edicion" ),
										        url => 		"datosDocumento.pl", 
										        params =>	["id1=[% id1 %]","id2=[% id2 %]","tipoAccion=MODIFICAR_NIVEL_2"],
										        title =>	"[% 'Editar Nivel 2' | i18n %]"
									        ) ;
	        [% END %]
        
        <div>
            [% PERL %]
                                print C4::AR::Filtros::to_Icon(  
                                                                    boton   => "icon_borrar",
                                                                    onClick => "borrarN2([% id2 %]);",
                                                                    title   => "[% 'Borrar Grupo' | i18n %]",
                                        ) ;
            [% END %]
        </div>
	        <br>
	        [% IF amazon_cover %]
		        <div class='amazon_cover_detail' style="position: relative; float:right;">
				        <img name="cover"  VALUE="" BORDER=0 src="[% themelang %]/[% lang %]/[% amazon_cover %]" title="Tapa" >
		        </div>
		        <br>
	        [% END %]
	<ul class="listado_sin_margen">
	        [% FOREACH nivel2_array %]
			        [% IF liblibrarian %]
				        [% IF dato %]
					       <li> [% liblibrarian %]: <strong>[% dato %]</strong></li>
				        [% END %]
			        [% END %]
        
	        [% END %] <!-- END FOREACH nivel2_array -->
            <li>
            <fieldset>
            <strong><legend>[% "Ejemplares del grupo" | i18n %] [% id2 %]</legend></strong>
            <div id="ejemplaresDelGrupo[% id2 %]" >
            [% INCLUDE "estructura/ejemplaresDelGrupo.tmpl" %]
            </div> <!--end <div id="ejemplaresDelGrupo -->
            </fieldset></li>
            </div>
       </div> <!--Fin <div id="grupo TMPL_VAR NAME='id2'-->
</fieldset>
</div>
[% END %]<!-- END FOREACH Nivel 2-->

</div> <!-- Fin DIV detalleComun -->
[% INCLUDE  "intranet-bottom.inc" %]
