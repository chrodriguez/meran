<!-- TMPL_INCLUDE NAME="intranet-top.inc" -->

<script src="/intranet-tmpl/blue/es2/includes/util.js"></script>
<script src="/intranet-tmpl/blue/es2/includes/circulacion.js"></script>
<script src="/intranet-tmpl/blue/es2/includes/MessageHelper.js"></script>
<script src="/intranet-tmpl/blue/es2/includes/WindowHelper.js"></script>

<!-- TMPL_INCLUDE NAME="../includes/popups/cambiarPassword.inc" -->

<script>

var objAH;


//*************************************Para manejar el historial de prestamos***********************************
function ordenar(orden){
	objAH.sort(orden);
}

function changePage(ini){
	objAH.changePage(ini);
}

function mostrarHistorialDePrestamos(){
	objAH=new AjaxHelper(updateMostrarHistorialDePrestamos);
	objAH.url='/cgi-bin/koha/usuarios/reales/historialPrestamos.pl';
	objAH.borrowernumber= usuario.ID;
	objAH.funcion= 'changePage';
	objAH.sendToServer();
}

function updateMostrarHistorialDePrestamos(responseText){
	$('#historialPrestamos').html(responseText);
	zebra('tablaHistorialPrestamos');
}


//*******************************Fin Para manejar el historial de prestamos************************************


//************************************Para manejar la circulacion**********************************************

function openPopup() {
	window.open('../prestamoInterBiblio.pl?accion=ingresarDatos&bornum=<!-- TMPL_VAR NAME=bornum -->','Prestamos interbibliotecarios','width=640,height=500,toolbar=yes,scrollbars=yes,status=yes');
}

//REDEFINIDO, se encuentra en circulacion.js
function updateInfoDevRen(responseText){
// 	alert("ejecuto updateInfoDevRen LOCAL!!!");
	cancelarDiv();
	clearMessages()

	var infoHash= JSONstring.toObject(responseText);
	var messageArray= infoHash.messages;
	var ticketsArray= infoHash.tickets;
	
	var mensajes= '';
	for(i=0; i<messageArray.length;i++){
		imprimirTicket(ticketsArray[i].ticket,i);
  		setMessages(messageArray[i]);
	}

	detallePrestamos(usuario.ID);
	//puede que llegue al  max de prestamos y se cancelen las reservas
	detalleReservas(usuario.ID);
	//puede que luego de devolver el usuario sea sancionado
	detalleSanciones(usuario.ID);
}

//REDEFINIDO, se encuentra en circulacion.js, se llama luego de realizar un prestamo
function updateInfoPrestarReserva(responseText){
// 	alert("ejecuto updateInfoPrestarReserva LOCAL!!!");
	cancelarDiv();
	clearMessages();

	var infoHash= JSONstring.toObject(responseText);
	var messageArray= infoHash.messages;
	var ticketsArray= infoHash.tickets;
	var mensajes= '';
	for(var i=0; i<messageArray.length;i++){
		imprimirTicket(ticketsArray[i].ticket,i);
  		setMessages(messageArray[i]);
	}

	detalleReservas(usuario.ID);
	detallePrestamos(usuario.ID);
}


//REDEFINIDO, se ejecuta cancelarReserva de circulacion.js y luego se ejecuta esta funcion
function updateInfoCancelacion(responseText){

	var Message=JSONstring.toObject(responseText);
	setMessage(Message);
	detalleReservas(objAH.borrowernumber);
}

function detallePrestamos(borr){

	objAH=new AjaxHelper(updateDetallePrestamos);
	objAH.url='/cgi-bin/koha/usuarios/reales/detallePrestamos.pl';
	objAH.borrnumber= borr;
	objAH.sendToServer();
}

function updateDetallePrestamos(responseText){
	$('#prestamos').html(responseText);
	zebra('prestamosResult');
}

function detalleReservas(borr){

	objAH=new AjaxHelper(updateDetalleReservas);
	objAH.url='/cgi-bin/koha/usuarios/reales/detalleReservas.pl';
	objAH.borrnumber= borr;
	objAH.sendToServer();
}


function updateDetalleReservas(responseText){
	$('#reservas').html(responseText);
	zebra('reseravsAsignadasResult');
	zebra('reservasEnEsperaResult');
}

$(document).ready(function() {

	checkedAll('checkAllReservas','chkboxReservas');
	checkedAll('checkAllPrestamos','chkboxPrestamos');
	zebra("tablaResult");
	
	//definido en circulacion.js
	usuario= new objeto_usuario();
	usuario.text= "<!-- TMPL_VAR NAME='completo' -->";
	usuario.ID= "<!-- TMPL_VAR NAME='bornum' -->";

	datosDeUsuario(usuario.ID)
	detallePrestamos(usuario.ID);
	detalleReservas(usuario.ID);
	detalleSanciones(usuario.ID);

	$("#historialPrestamosToggle").toggle(	function(){
// 							$(this).addClass("selected");
							$('#historialPrestamos').slideUp('slow');
						},
						function(){
// 							$(this).removeClass("selected");
							$('#historialPrestamos').slideDown('slow');
						}
	);

});


//**********************************Fin**Para manejar la circulacion********************************************

//*******************************************Para cambiar permisos***********************************************

function modificarPermisos(){
	objAH=new AjaxHelper(updateModificarPermisos);
	objAH.debug= true;
	objAH.url='/cgi-bin/koha/usuarios/reales/usuariosRealesDB.pl';
	objAH.usuario= usuario.ID;
	objAH.tipoAccion= 'MOSTRAR_PERMISOS';
	objAH.sendToServer();
}

function updateModificarPermisos(responseText){
//se crea el objeto que maneja la ventana para modificar los permisos
	vModificarPermisos=new WindowHelper();
	vModificarPermisos.html=responseText;
	vModificarPermisos.titulo= 'PERMISOS DE ACCESO';
	vModificarPermisos.create();
}

function guardarPermisos(){

	var chck= $("input[@name=chkpermisos]:checked"); //obtengo todos los check seleccionados
	var array= new Array;
	var long=chck.length;
 	if ( long == 0){
 		alert("Elija al menos un permiso");
 	}
 	else{

		for(var i=0; i< long; i++){
			array[i]=chck[i].value;
		}

		objAH=new AjaxHelper(updateGuardarPermisos);
		//objAH.debug= true;
		objAH.tipoAccion= 'GUARDAR_PERMISOS';
		objAH.url= '/cgi-bin/koha/usuarios/reales/usuariosRealesDB.pl';
		objAH.usuario= usuario.ID;
		objAH.array_permisos= array;
		objAH.sendToServer();
 	}
}

function updateGuardarPermisos(responseText){

	closeWindowPermisos();	
	var Message=JSONstring.toObject(responseText);
	setMessage(Message);
}

//****************************************Fin para cambiar permisos*********************************************

//************************************************Eliminar Usuario**********************************************
function eliminarUsuario(){

	var is_confirmed = confirm('Confirma la baja ?');

	if (is_confirmed) {

		objAH=new AjaxHelper(updateEliminarUsuario);
		objAH.url='/cgi-bin/koha/usuarios/reales/usuariosRealesDB.pl';
		objAH.debug= true;
		objAH.borrowernumber= usuario.ID;
		objAH.tipoAccion= 'ELIMINAR_USUARIO';
		objAH.sendToServer();

	}
}

function updateEliminarUsuario(responseText){
	var Message=JSONstring.toObject(responseText);
	setMessage(Message);
}

//*********************************************Fin***Eliminar Usuario*********************************************


//*********************************************Modificar Datos Usuario*********************************************
function modificarDatosDeUsuario(){
	objAH=new AjaxHelper(updateModificarDatosDeUsuario);
	objAH.url='/cgi-bin/koha/usuarios/reales/usuariosRealesDB.pl';
	objAH.debug= true;
	objAH.borrowernumber= usuario.ID;
	objAH.tipoAccion= 'MODIFICAR_USUARIO';
	objAH.sendToServer();
}

function updateModificarDatosDeUsuario(responseText){
//se crea el objeto que maneja la ventana para modificar los datos del usuario
	vDatosUsuario=new WindowHelper();
	vDatosUsuario.html=responseText;
	vDatosUsuario.create();	
}

function guardarModificacioUsuario(){

	objAH=new AjaxHelper(updateGuardarModificacioUsuario);
	objAH.url='/cgi-bin/koha/usuarios/reales/usuariosRealesDB.pl';
	objAH.debug= true;
	objAH.borrowernumber= usuario.ID;
	objAH.cardnumber= $('#cardnumber').val();
	objAH.sex= $("input[@name=sex]:checked").val();
	objAH.physstreet= $('#physstreet').val();
	objAH.streetaddress= $('#streetaddress').val();
	objAH.firstname= $('#firstname').val();
	objAH.dateofbirth= $('#dateofbirth').val();
	objAH.emailaddress= $('#emailaddress').val();
	objAH.dateenrolled= $('#dateenrolled').val();
	objAH.dstreetcity= $('#dstreetcity').val();
	objAH.altrelationship= $('#altrelationship').val();
	objAH.othernames= $('#othernames').val();
	objAH.phoneday= $('#phoneday').val();
	objAH.categorycode= $('#categorycode').val();
	objAH.city= $('#city').val();
	objAH.phone= $('#phone').val();
	objAH.borrowernotes= $('#borrowernotes').val();
	objAH.surname= $('#surname').val();
	objAH.ethnicity= $('#ethnicity').val();
	objAH.branchcode= $('#branchcode').val();
	objAH.zipcode= $('#zipcode').val();
	objAH.homezipcode= $('#homezipcode').val();
	objAH.documenttype= $('#documenttype').val();
	objAH.documentnumber= $('#documentnumber').val();
	objAH.studentnumber= $('#studentnumber').val();
	objAH.updatepassword= $('#updatepassword').val();
	objAH.tipoAccion= 'GUARDAR_MODIFICACION_USUARIO';
 	objAH.sendToServer();

}

function updateGuardarModificacioUsuario(responseText){
	var Message=JSONstring.toObject(responseText);
	setMessage(Message);
	vDatosUsuario.hide();
	datosDeUsuario();
}

function datosDeUsuario(){
	objAH=new AjaxHelper(updateDatosDeUsuario);
	objAH.url='/cgi-bin/koha/usuarios/reales/usuariosRealesDB.pl';
	objAH.debug= true;
	objAH.borrowernumber= usuario.ID;
	objAH.tipoAccion= 'DATOS_USUARIO';
	objAH.sendToServer();
}

function updateDatosDeUsuario(responseText){
	$('#detalleUsuario').html(responseText);
}
//*********************************************Fin***Modificar Datos Usuario***************************************
</script>

<!-- Mensajes de Informacion al Usuario -->
<div class="tableMsgUser">
	<font class="fontMsgUser"><b>
	<div id="mensajes"></div>
	</b></font>
</div>

<br>
<div id="confirmar_div"></div>
<br>

<div style="clear:both">

	<!-- 	DETALLE USUARIO -->
	<div id="detalleUsuario"></div>
		
	<!--DETALLE DE PRESTAMOS-->
	<div id="prestamos"></div>
	
	<!-- DETALLE DE RESERVAS -->
	<div id="reservas"></div>
	
	<!-- DETALLE DE SANCIONES -->
	<div id="sanciones"></div>
	
	<p align="center"><span class="click" onClick="mostrarHistorialDePrestamos()">Historial de Pr&eacute;stamos</span></p>	
	
	<div id="historialPrestamosToggle" class="click" style="width: 10px; ">[-]</div>
	<!-- DETALLE DEL HISTORICO DE PRESTAMOS DEL USUARIO -->
	<div id="historialPrestamos"></div>

</div>

<!-- TMPL_INCLUDE NAME="intranet-bottom.inc" -->
