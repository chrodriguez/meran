[% INCLUDE 'intranet-top.inc' %]
[% USE HTML %]

<script type="text/javascript">

    var objAH;
    //arreglo de objetos campo
    CAMPOS_ARRAY= new Array();
    //arreglo de objetos subcampo
    SUBCAMPOS_ARRAY= new Array();

    function agregarAyudaMarcShow(){
      $('#addAyudaMarcForm').modal();
    } 

    function hideAyudaMarcShow(){
        $('#addAyudaMarcForm').modal('hide');
    }

    function eleccionCampoX(){
        objAH               = new AjaxHelper(updateEleccionCampoX);
        objAH.debug         = true;
        objAH.showOverlay   = true;
        objAH.url           = URL_PREFIX+"/catalogacion/visualizacionOPAC/visualizacionOpacDB.pl";
        objAH.campoX        = $('#campoX').val();
        objAH.tipoAccion    = "GENERAR_ARREGLO_CAMPOS";
        objAH.sendToServer();
    }

    function eleccionSubCampo(){

        $('#liblibrarian').val(SUBCAMPOS_ARRAY[$('#subcampo').val()].liblibrarian);
    }

    //se genera el combo en el cliente
    function updateEleccionCampoX(responseText){
        //Arreglo de Objetos Global
        var campos_array = JSONstring.toObject(responseText);
        //se inicializa el combo
        $("#campo").html('')
        var options = "<option value='-1'>Seleccionar CampoX</option>";
        
        for (x=0;x < campos_array.length;x++){
             CAMPOS_ARRAY[campos_array[x].campo]= $.trim(campos_array[x].liblibrarian);   
             options+= "<option value=" + campos_array[x].campo +" >" + campos_array[x].campo + "</option>";
        }
        $("#campo").append(options);

    }

    function eleccionCampo(){
        objAH               = new AjaxHelper(updateEleccionCampo);
        objAH.debug         = true;
        objAH.showOverlay   = true;  
        objAH.url           = URL_PREFIX+"/catalogacion/visualizacionOPAC/visualizacionOpacDB.pl";
        objAH.campo         = $('#campo').val();
        objAH.tipoAccion    = "GENERAR_ARREGLO_SUBCAMPOS";
        objAH.sendToServer();
    }

    //se genera el combo en el cliente
    function updateEleccionCampo(responseText){

        $('#nombre_campo').html(CAMPOS_ARRAY[$("#campo").val()]);
        //Arreglo de Objetos Global
        var subcampos_array = JSONstring.toObject(responseText);
        //se inicializa el combo
        $("#subcampo").html('');

        var options = "<option value='-1'>Seleccionar SubCampo</option>";
        
        for (x=0;x < subcampos_array.length;x++){

            var subcampo            = new Object;    
            subcampo.liblibrarian   = '';
            subcampo.obligatorio    = '';
            subcampo.liblibrarian   =  $.trim(subcampos_array[x].liblibrarian);
            subcampo.obligatorio    = $.trim(subcampos_array[x].obligatorio); 
            SUBCAMPOS_ARRAY[ subcampos_array[x].subcampo ]= subcampo;

            options+= "<option value=" + subcampos_array[x].subcampo +" >" + subcampos_array[x].subcampo + "</option>";
        }
        //se agrega la info al combo
        $("#subcampo").append(options);
    }

    function agregarAyudaMarc(){

        objAH               = new AjaxHelper(updateAgregarVisualizacion);
        objAH.debug         = true;
        objAH.showOverlay   = true;
        objAH.url           = URL_PREFIX+"/admin/ayudaMarc/ayudaMarcDB.pl";
        objAH.tipoAccion    = 'AGREGAR_VISUALIZACION';
        var campo           = $.trim($("#campo").val());
        var subcampo        = $.trim($("#subcampo").val());
        var ayuda           = $.trim($("#ayuda").val());  
          
        if ( (campo) && (subcampo) && (ayuda) ){
            objAH.campo         = campo;
            objAH.subcampo      = subcampo;
            objAH.ayuda         = ayuda;       
            objAH.sendToServer();
        }else{
            jAlert(SELECCIONE_VISTA_OPAC);
        }
        
    }

    function updateAgregarVisualizacion(responseText){
        hideAyudaMarcShow();
        var Messages        = JSONstring.toObject(responseText);
        setMessages(Messages);
        if (! (hayError(Messages) ) ){
    //        mostrarTabla(); 
            eleccionDeEjemplar(); 
            $("#tablaResultSubCampos").html("");
        }   
    }
      
</script>

<fieldset>
    <legend>[% "Ayudas MARC" | i18n %]</legend>
        [% IF cant %]
                [% PERL %]
                    print C4::AR::Filtros::tableHeader(   
                                           id              => "portada_opac_result",
                                           class           => "",
                                           columns         => ['[% "UI"|i18n %]','[% "Campo"|i18n %]','[% "Subcampo"|i18n %]','[% "Acciones"|i18n %]',]
                                ) ;
                [% END %]
                
                <tbody id="portada_opac_result_sortable">
                [% FOREACH a IN ayudasMarc %]
                    <tr id="[% a.id %]">
                        <td>[% a.unidad_informacion.getNombre %]</td>
                        <td>[% a.getCampo %]</td>
                        <td>[% a.getSubCampo %]</td>
                        <td>
                              [% PERL %]
                                      print C4::AR::Filtros::action_set_button(    
                                            title => "Modificar", 
                                            action=>"modificarPortada([% p.id %])", 
                                            icon=>"icon-white icon-edit",
                                            button          => 'btn btn-primary',
                                            actions         => [
                                                                    {title  => "Eliminar", 
                                                                     url    =>"[% url_prefix %]/admin/portada_opac.pl",
                                                                     params =>['id_portada=[% p.id %]','tipoAccion=DEL'], 
                                                                     icon   =>"icon-trash"
                                                                    },
                                                                ],
                                              ) ;
                            [% END %]
                        </td>
                    </tr>    
                [% END %]
                </tbody>
             </table>
        [% ELSE %]
            <div class="alert alert-info">[% 'No hay niguna ayuda MARC' | i18n %]</div>
        [% END %]
</fieldset>

<div class="form-actions">
    [% PERL %]
                print C4::AR::Filtros::action_button(   
                        button   => "btn btn-primary",
                        action   => 'agregarAyudaMarcShow();',
                        title   => "[% 'Agregar ayuda' | i18n %]",
                    ) ;
    [% END %]
</div>

<div id="addAyudaMarcForm" class="modal hide fade" >
    [% INCLUDE 'form_ayuda_marc.inc' %]
</div>
                
[% INCLUDE 'intranet-bottom.inc' %]