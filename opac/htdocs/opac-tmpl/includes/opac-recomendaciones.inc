[% INCLUDE "FormValidateHelper.inc" %]
[% INCLUDE  "AutocompleteHelper.inc"  %]


<script src="/opac-tmpl/includes/opac-searchFunciones.js" type="text/javascript"></script>
<script src="/opac-tmpl/includes/tabletojson.js" type="text/javascript"> </script>
<script src="/opac-tmpl/includes/opac-recomendaciones.js" type="text/javascript"></script>
<script src="/includes/jquery/modal/jquery.simplemodal.js" type="text/javascript"></script>
<script type="text/javascript">

function buscarDatosNivel2(){
        objAH                   = new AjaxHelper(updateBuscarDatosNivel2);
        objAH.debug             = true;
        objAH.showOverlay       = true;
        objAH.url               = '/cgi-bin/koha/opac-recomendacionesDB.pl';
        objAH.tipoAccion        = 'BUSQUEDA_RECOMENDACION';
        objAH.idCatalogoSearch  = $('#catalogo_search_hidden').val();
        objAH.sendToServer();
}

function traerImputsVacios(){
        objAH                   = new AjaxHelper(updateTraerImputsVacios);
        objAH.debug             = true;
        objAH.showOverlay       = true;
        objAH.url               = '/cgi-bin/koha/opac-recomendacionesDB.pl';
        objAH.tipoAccion        = 'BUSQUEDA_RECOMENDACION_SIN_RESULTADOS';
        objAH.sendToServer();
}


function updateTraerImputsVacios(responseText){
  $('#datos_edicion_seleccionada').html(responseText); 

}

function guardarRecomendacion(){
   
    $(".eliminar").remove();
    $("#tabla_recomendacion").hide();
    alert( $("#tabla_recomendacion"));
    $("#tabla_recomendacion").tabletojson({
            headers: "Autor,Titulo, Edicion, Lugar Publicacion, Editorial, Fecha, ISBN/ISSN, Nivel 2, Cantidad, Motivo, Comentario",
            attribHeaders: "{}",
            returnElement: "#table",
            complete: function(x){
                
                 objAH                     = new AjaxHelper(updateGuardarRecomendacion);
                 objAH.url                 = '/cgi-bin/koha/opac-recomendacionesAdd.pl';
                 objAH.debug               = true;
                 objAH.showOverlay         = true;
                 objAH.table               = JSONstring.toObject(x);
                 objAH.motivo_propuesta    = $('#motivo_propuesta').val();
                 objAH.comment             = $('#comment').val();
                 objAH.tipoAccion          = 'GUARDAR_RECOMENDACION';
                 objAH.sendToServer();
            }
        })
    $(".tr").remove
    
}

function updateGuardarRecomendacion(responseText){
  
   if (!verificarRespuesta(responseText)) {
            return(0);
            var Messages=JSONstring.toObject(responseText);
            setMessages(Messages);
   }
}


function updateBuscarDatosNivel2(responseText){
   $('#ediciones').html(responseText);
   

   $('#edicion_id').val('').attr("selected",true);
   $('#edicion_id').change( function(){    
              var edicion=this.options[this.selectedIndex].text
              
              cargarDatosEdicionSeleccionada(edicion)
   });
   if (!verificarRespuesta(responseText)) {
            return(0);
            var Messages=JSONstring.toObject(responseText);
            setMessages(Messages);
   }
}


function cargarDatosEdicionSeleccionada(edicion){
        objAH                   = new AjaxHelper(updateCargarDatosEdicionSeleccionada);
        objAH.debug             = true;
        objAH.showOverlay       = true;
        objAH.url               = '/cgi-bin/koha/opac-recomendacionesDB.pl';
        objAH.tipoAccion        = 'CARGAR_DATOS_EDICION';
        objAH.edicion_id        = $('#edicion_id').val();
        objAH.edicion           = edicion;
        objAH.idCatalogoSearch  = $('#catalogo_search_hidden').val();
        objAH.sendToServer();
}


function updateCargarDatosEdicionSeleccionada(responseText){
   $('#datos_edicion_seleccionada').html(responseText);    

//    if (!verificarRespuesta(responseText)) {
//             return(0);
//             var Messages=JSONstring.toObject(responseText);
//             setMessages(Messages);
//    }
}

function bloquearCampos(){
     $('#autor').attr('readonly', true); 
     $('#titulo').attr('readonly', true); 
     /*$('#edicion').attr('readonly', true);*/ 
     $('#lugar_publicacion').attr('readonly', true); 
     $('#editorial').attr('readonly', true); 
     $('#isbn_issn').attr('readonly', true); 
     $('#fecha').attr('readonly', true); 

}

function verificarBusqueda(){
    if ($('#catalogo_search_hidden').val() != (-1)){
            $('#carga_manual').hide();
            buscarDatosNivel2();
            bloquearCampos();
            $('#ediciones').show();
    } else {   
           traerImputsVacios();
           validateForm(agregarRenglon);
           $('#carga_manual').show();
           $('#ediciones').hide(); 
    }
}

$(document).ready( function() {
    CrearAutocompleteCatalogo({ 
          IdInput: 'catalogo_search', 
          IdInputHidden: 'catalogo_search_hidden', 
          callBackFunction: verificarBusqueda,
    })
    $('#catalogo_search').blur(function(){        
              limpiarCampos()
    });
    $('#recomendacion').hide();
    makeToggle('carga_manual','trigger',null,true);
});



</script>        
     
<div class="column1-unit">
  <!--    [% message %]--> 
      <div style= "width: 169%;" class="recomendacionform">
              <input type="hidden" name="action" value="agregar">
              <fieldset> <legend class="titulo_legend trigger click">[% "Busqueda de Datos del Material" | i18n %]</legend>
                          <!-- <li class="item">-->
                                <p><label for="catalogo_search" style="float: left; padding-right:10px">[% 'Keyword' | i18n %]</label>
                                <input type='text' id='catalogo_search' name='catalogo_search' value='' size=40 tabindex='3' style="float: left"></p>
                                <input type='hidden' id='catalogo_search_hidden' name='catalogo_search_hidden' value=''>
                         <!--   </li>  -->                 
              </fieldset>
              <div id="ediciones"></div>

              <div class="carga_manual" id="carga_manual"> 
                     [% PERL %]
                          print C4::AR::Filtros::setHelp(text => "[% 'No se han encontrado resultados para la busqueda realizada. Si lo desea, puede llenar los campos manualmente' | i18n %]",
                                        );   C4::AR::Debug::debug("Save Detalle");
                     [% END %]
                  
           </div>       
           <div id="datos_edicion_seleccionada"></div>
              <fieldset  id="recomendacion"><legend class="titulo_legend trigger click">&nbsp;[% 'Recomendacion' | i18n %]&nbsp;</legend>
                  <table id="tabla_recomendacion" name= "tabla_recomendacion" class="tabla_datos" cellspacing='0' cellpadding='0'>
                          <thead>    
                              <th align="center">
                                  [% "Autor" | i18n %]
                              </th>
                              <th align="center">
                                  [% "T&iacute;tulo" | i18n %]
                              </th>
                              <th align="center">
                                  [% "Edici&oacute;n" | i18n %]
                              </th>
                              <th align="center">
                                  [% "Lugar de publicaci&oacute;n" | i18n %]
                              </th>
                              <th align="center">
                                  [% "Editorial" | i18n %]
                              </th>
                              <th align="center">
                                  [% "Fecha" | i18n %]
                              </th>
                             <!-- <th align="center">
                                  [% "Colecci&oacute;n" | i18n %]
                              </th>-->
                              <th align="center">
                                  [% "ISBN/ISSN" | i18n %]
                              </th>
                              <th align="center">
                                  [% "Nivel 2" | i18n %]
                              </th>
                              <th align="center">
                                  [% "Cantidad de ejemplares" | i18n %]
                              </th>
                              <th align="center">
                                  [% "Motivo de la Propuesta" | i18n %]
                              </th>
                               <th align="center">
                                  [% "Comentarios" | i18n %]
                              </th>
                              <th class="eliminar" align="center">
                                  [% "Eliminar" | i18n %]
                              </th>
                                  
                        </thead>
                        <tbody>
                        </tbody>
                      </table>
                      <input type="button" onclick="guardarRecomendacion()" value="Enviar Recomendacion">
                </fieldset>
                  
      </div>         
</div>
        
