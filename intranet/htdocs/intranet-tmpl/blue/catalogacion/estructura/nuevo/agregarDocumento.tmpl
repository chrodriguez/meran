[% INCLUDE "intranet-top.inc" %]

<script src="/intranet-tmpl/blue/includes/autocompletables.js"></script>
<link href="/intranet-tmpl/blue/includes/jquery/jquery.autocomplete.css" type="text/css" rel="stylesheet">

 <script src="/intranet-tmpl/blue/includes/CombosHelper.js"></script> 
<!-- para manejar la ventana de campos MARC -->
<script src="/intranet-tmpl/blue/includes/popups/helpCamposMARC.js"></script>


<script>

//************************************************REVISADO******************************************************************
id1=0; //para saber el id del nivel 1
id2=0; //para saber el id del nivel 2
id3=0; //para saber el id del nivel 3
dataModif = 0;
modificar = 0;
// array_info_combo= 0; //para guardar las opciones de los combos que se generan en el cliente

//arreglo de objetos componentes, estos objetos son actualizados por el usuario y luego son enviados al servidor
COMPONENTES_ARRAY= new Array();

function inicializar(){
    //arreglo de objetos campo
    COMPONENTES_ARRAY= new Array();
}

//esta funcion sincroniza la informacion del cliente con el arreglo de componentes para enviarlos al servidor
function syncComponentesArray(){
    for(var i=0; i < COMPONENTES_ARRAY.length; i++){
        COMPONENTES_ARRAY[i].dato= $('#'+COMPONENTES_ARRAY[i].idCompCliente).val();
        
    }
}

//para mantener el nivel que se esta procesando
_nivelActual= 1;

function getDivDelNivel(){
    
    switch(_nivelActual){
        case 1:
            return 'estructuraDelNivel1';   
        break;
        case 2:
            return 'estructuraDelNivel2';
        break;
        case 3:
            return 'estructuraDelNivel3';
        break;
    }
}


// FIXME esto podria ser generico para los 3 niveles
function mostrarEstructuraDelNivel1(){
    _nivelActual= 1;
    
    objAH=new AjaxHelper(updateMostrarEstructuraDelNivel1);
    objAH.debug= true;
    objAH.url="/cgi-bin/koha/catalogacion/estructura/nuevo/estructuraCataloDB.pl";
    objAH.tipoAccion= "MOSTRAR_ESTRUCTURA_DEL_NIVEL";
    objAH.nivel= _nivelActual;
    
    objAH.id_tipo_doc= 'ALL';//$("#tipo_nivel3_id").val();
    objAH.sendToServer();
}



function mostrarDataNivel1(){

    if (modificar){
      for (x=0; x<dataModif.length; x++){
         $('#'+dataModif[x].CEC.idCompCliente).val(dataModif[x].dato);
         COMPONENTES_ARRAY[x].rep_n1_id = dataModif[x].rep_n1_id;
         if (_nivelActual == 2)
            COMPONENTES_ARRAY[x].rep_n2_id = dataModif[x].rep_n2_id;
      }
   }
}

function updateMostrarEstructuraDelNivel1(responseText){
    $("#estructuraDelNivel1").html("");
    $("#estructuraDelNivel2").html("");
    $("#estructuraDelNivel3").html("");
    $("#nivel1Tabla").show();
    //muestra los campos fijos del Nivel1
    crearComponentesNivel1();
    //proceso la info del servidor y se crean las componentes en el cliente
    procesarInfoJson(responseText); 
    //Para ver si se llamó a modificar o no...
    mostrarDataNivel1();
}

function mostrarEstructuraDelNivel2(){
    _nivelActual= 2;

    objAH=new AjaxHelper(updateMostrarEstructuraDelNivel2);
    objAH.debug= true;
    objAH.url="/cgi-bin/koha/catalogacion/estructura/nuevo/estructuraCataloDB.pl";
    objAH.tipoAccion= "MOSTRAR_ESTRUCTURA_DEL_NIVEL";
    objAH.nivel= _nivelActual;
    objAH.id_tipo_doc= $("#tipo_nivel3_id").val();
    objAH.sendToServer();
}

function updateMostrarEstructuraDelNivel2(responseText){
    $("#estructuraDelNivel2").html("");
    $('#nivel2Tabla').show();
    $('#nivel3Tabla').hide();
    //muestra los campos fijos del Nivel2
    crearComponentesNivel2();
    //proceso la info del servidor y se crean las componentes en el cliente
    procesarInfoJson(responseText);
}

function mostrarEstructuraDelNivel3(){
    _nivelActual= 3;

    objAH=new AjaxHelper(updateMostrarEstructuraDelNivel3);
    objAH.debug= true;
    objAH.url="/cgi-bin/koha/catalogacion/estructura/nuevo/estructuraCataloDB.pl";
    objAH.tipoAccion= "MOSTRAR_ESTRUCTURA_DEL_NIVEL";
    objAH.nivel= _nivelActual;
    objAH.id_tipo_doc= $("#tipo_nivel3_id").val();
    objAH.sendToServer();
}

function updateMostrarEstructuraDelNivel3(responseText){
    $("#estructuraDelNivel3").html("");
    $('#nivel3Tabla').show();
    //muestra los campos fijos del Nivel3
//     crearComponentesNivel3();
    //proceso la info del servidor y se crean las componentes en el cliente
    procesarInfoJson(responseText);
}

//esta funcion muestra la info en la barra laterarl del NIVEL 1 luego de ser guardado
function mostrarInfoAltaNivel1(id1){
    objAH=new AjaxHelper(updateMostrarInfoAltaNivel1);
    objAH.debug= true;
    objAH.url="/cgi-bin/koha/catalogacion/estructura/nuevo/estructuraCataloDB.pl";
    objAH.tipoAccion= "MOSTRAR_INFO_NIVEL1_LATERARL";
    objAH.id1= id1;
    objAH.sendToServer();
}

function updateMostrarInfoAltaNivel1(responseText){
    $('#nivel1Tabla').slideUp('slow');
    $('#estructuraDelNivel1').html('');
    $('#nivel1').html(responseText);
}

//esta funcion muestra la info en la barra laterarl del NIVEL 2 luego de ser guardado
function mostrarInfoAltaNivel2(id2){
    objAH=new AjaxHelper(updateMostrarInfoAltaNivel2);
    objAH.debug= true;
    objAH.url="/cgi-bin/koha/catalogacion/estructura/nuevo/estructuraCataloDB.pl";
    objAH.tipoAccion= "MOSTRAR_INFO_NIVEL2_LATERARL";
    objAH.id2= id2; //voy a mostrar todos los nivel 2 del nivel1 con el q se esta trabajando, asi este vuela
    objAH.id1= id1;
    objAH.sendToServer();
}

function updateMostrarInfoAltaNivel2(responseText){
    $('#nivel2Tabla').slideUp('slow');
    $('#estructuraDelNivel2').html('');
    $('#nivel2').html(responseText);
}

function guardarDocumentoN1(){

    syncComponentesArray();
    objAH=new AjaxHelper(updateGuardarDocumentoN1);
    objAH.debug= true;
    objAH.url="/cgi-bin/koha/catalogacion/estructura/nuevo/estructuraCataloDB.pl";
    objAH.tipoAccion= "GUARDAR_NIVEL_1";
    objAH.id_tipo_doc= $("#tipo_nivel3_id").val();
    objAH.hayRepetibles= COMPONENTES_ARRAY.length;
    objAH.infoArrayNivel1= COMPONENTES_ARRAY;
    objAH.modificado = modificar;
    objAH.id1 = id1;
    objAH.sendToServer();
    modificar = 0;
}

function updateGuardarDocumentoN1(responseText){

    var info=JSONstring.toObject(responseText);
    var Messages= info.Message_arrayref;
    id1= info.id1;
    setMessages(Messages);
    if (! (hayError(Messages) ) ){
        inicializar();
        //carga la barra lateral con info de nivel 1
        mostrarInfoAltaNivel1(id1);
        mostrarEstructuraDelNivel2();
    }
}

function guardarDocumentoN2(){
    syncComponentesArray();
    objAH=new AjaxHelper(updateGuardarDocumentoN2);
    objAH.debug= true;
    objAH.url="/cgi-bin/koha/catalogacion/estructura/nuevo/estructuraCataloDB.pl";
    objAH.tipoAccion= "GUARDAR_NIVEL_2";
    objAH.tipo_documento= $("#tipo_nivel3_id").val();
    objAH.hayRepetibles= COMPONENTES_ARRAY.length;
    objAH.infoArrayNivel2= COMPONENTES_ARRAY;
    objAH.modificado = modificar;
    objAH.id1 = id1;
    objAH.id2 = id2; //por si se modificó
    objAH.sendToServer();
}

function updateGuardarDocumentoN2(responseText){

    var info=JSONstring.toObject(responseText);
    var Messages= info.Message_arrayref;//obtengo los mensajes para el usuario
    id2= info.id2;
//     id1= info.id1;
    setMessages(Messages);
    if (! (hayError(Messages) ) ){
        inicializar();
        //carga la barra lateral con info de nivel 1
        mostrarInfoAltaNivel2(id2);
        mostrarEstructuraDelNivel3();
    }
}


function guardarDocumentoN3(){
    syncComponentesArray();
    objAH=new AjaxHelper(updateGuardarDocumentoN3);
    objAH.debug= true;
    objAH.url="/cgi-bin/koha/catalogacion/estructura/nuevo/estructuraCataloDB.pl";
    objAH.tipoAccion= "GUARDAR_NIVEL_3";
    objAH.tipo_documento= $("#tipo_nivel3_id").val();
    objAH.hayRepetibles= COMPONENTES_ARRAY.length;
    objAH.infoArrayNivel2= COMPONENTES_ARRAY;
    objAH.id1 = id1;
    objAH.id2 = id2;
    objAH.sendToServer();
}

function updateGuardarDocumentoN3(responseText){

    var info=JSONstring.toObject(responseText);
    var Messages= info.Message_arrayref; //obtengo los mensajes para el usuario
    id3= info.id3;
    setMessages(Messages);

   //PARA LIMPIAR EL VALUE DE TODOS (ASI INGRESA UNO NUEVO)
   var allInputs = $('#estructuraDelNivel3 :input');
       for (x=0; x< allInputs.length; x++)
            allInputs[x].value="";
    if (! (hayError(Messages) ) ){
        inicializar();
        //muestra la tabla con los ejemplares agregados
        mostrarInfoAltaNivel3(info.id1, info.id2);
    }
}

//esta funcion muestra la info en la barra laterarl del NIVEL 2 luego de ser guardado
function mostrarInfoAltaNivel3(id1, idNivel2){
    objAH=new AjaxHelper(updateMostrarInfoAltaNivel3);
    objAH.debug= true;
    objAH.url="/cgi-bin/koha/catalogacion/estructura/nuevo/estructuraCataloDB.pl";
    objAH.tipoAccion= "MOSTRAR_INFO_NIVEL3_TABLA";
    objAH.id1= id1;
    objAH.id2= idNivel2;
    id2= idNivel2;
    objAH.sendToServer();
}

function updateMostrarInfoAltaNivel3(responseText){
    $('#detalleDelNivel3').html(responseText);
    zebra('tablaResult');
}

/*
 * procesarInfoJson
 * procesa la informacion que esta en notacion json, que viene del llamado ajax.
 * @params
 * json, string con formato json.
 */
function procesarInfoJson(json){
    objetos=JSONstring.toObject(json);
    
    for(var i=0; i< objetos.length; i++){
        //guardo el objeto para luego enviarlo al servidor una vez que este actualizado
        COMPONENTES_ARRAY[i]= objetos[i];
        procesarObjeto(objetos[i]);
    }
}

/*
 * procesarObjeto
 * procesa el objeto json, para poder crear el componente adecuado al tipo de datos que vienen en el objeto.
 * @params
 * objeto, elemento que contiene toda la info necesaria.
 */
function procesarObjeto(objeto){
    var libtext= $.trim(objeto.liblibrarian);
    var tipo= $.trim(objeto.tipo);
    var ref= objeto.referencia;
    var valor= objeto.valor;
    var varios= objeto.varios;
    var idComp= objeto.idCompCliente;
    var comp;
    var hidden=" ";
    var strComp;
    var auto=0;
    var unoLinea=0;
    var idDiv="div"+idComp;
    var divComp= crearDivComponente(idDiv);
    var divLabel= crearDivLabel(libtext);
    strComp="<div class='divContentComponente'> "+divLabel+divComp+"</div>";
    $(strComp).appendTo("#"+getDivDelNivel());

    switch(tipo){
        case "text":
            //tipo,id,opciones,valor
            comp= crearComponente(tipo,idComp,"","");
            $(comp).appendTo("#"+idDiv);
            $("#"+idComp).val(objeto.valText);
            auto= objeto.referencia;
        break;
        case "combo":
//             var opciones= JSONstring.toObject(objeto.opciones);
            comp= crearComponente(tipo,idComp,opciones,valor);
            $(comp).appendTo("#"+idDiv);
        break;
        case "texta2":
            compText=crearComponente("text",idComp,"","");
            comp=crearComponente("texta","texta"+idComp,"readonly='readonly'","");
            var boton="<input type='image' value='borrar ultima opcion' onclick='borrarEleccion("+idComp+")' src='[% themelang %]/images/sacar.png'>";
            comp="<div style='float: left;padding-right:1%; padding-bottom: 1%;'>"+comp+"</div>";
            compText=compText+" "+boton;
            $(compText).appendTo("#"+idDiv);
            $(comp).appendTo("#strComp"+idComp);
            $("#texta"+idComp).val(objeto.valTextArea);
            auto= objeto.referencia;
        break;
    }

    //Se agregan clases para cuando tenga que recuperar los datos.
    if(objeto.obligatorio == "1"){
        hacerComponenteObbligatoria(idComp);
    }
    //Para crear el autocomplete correspondiente
//     if(auto){
//         var tabla=objeto.tabla;
//         var campos=objeto.campos;
//         var orden=objeto.orden;
//         var separador=objeto.separador;
//         crearAuto(idComp,tabla,accion,id,campos,orden,separador);
//     }
}

/*
 * crearComponente
 * crea el string HTML del componente correspondiente al parametro tipo.
 * @params
 * tipo, corresponde a la clase de componente html que se quiere crear.
 * id, identificador para el componente que se va a crear.
 * opciones, son las opciones que se generan si el componente es un combobox, para los demas esta en blanco.
 */
function crearComponente(tipo,id,opciones,valor){
    var comp;

    switch(tipo){
        case "text": comp="<input type='"+tipo+"' id='"+id+"' value='"+valor+"' size='80'>";
        break;
        case "combo": comp="<select id='"+id+"'>\n<option value=''>Elegir opci&oacute;n</option>\n";
            var op="";
            var def="";
            for(var i=0; i< opciones.length; i++){
                if(valor == opciones[i].clave){
                    def=" selected='selected' ";
                }
                op=op+"<option value='"+opciones[i].clave+ "'" + def +"'>"+opciones[i].valor+"</option>\n";
                def="";
            }
            comp=comp+op+"</select>";
        break;
        case "texta": comp="<textarea id='"+id+"' "+ opciones +" rows='4'>"+valor+"</textarea>";
        break;
    }

    return comp;
}

function crearComponentesNivel1(){
    var comp= crearComponente('text','titulo',[],'');
    var divComp= crearDivComponente('divTitulo');
    var divLabel= crearDivLabel('Título');
    strComp="<div class='divContentComponente'> "+divLabel+divComp+"</div>";
    $(strComp).appendTo("#estructuraDelNivel1");
    $(comp).appendTo("#divTitulo");    

    hacerComponenteObbligatoria('titulo');
}

function crearComponentesNivel2(){

    var comp= crearComponente('text','tipo_documento',[],'');
    hacerComponenteObbligatoria('tipo_documento');
    var divComp= crearDivComponente('divTipoDocumento');  
    var divLabel= crearDivLabel('Tipo de Documento');
    strComp="<div class='divContentComponente'> "+divLabel+divComp+"</div>";
    $(strComp).appendTo("#estructuraDelNivel2");
    $(comp).appendTo("#divTipoDocumento");  

    comp= crearComponente('text','nivel_bibliografico',[],'');
    hacerComponenteObbligatoria('nivel_bibliografico');
    divComp= crearDivComponente('divNivelBibliografico');
    divLabel= crearDivLabel('Nivel Bibliográfico');
    strComp="<div class='divContentComponente'> "+divLabel+divComp+"</div>";
    $(strComp).appendTo("#estructuraDelNivel2");    
    $(comp).appendTo("#divNivelBibliografico");
    
    comp= crearComponente('text','soporte',[],'');
    hacerComponenteObbligatoria('soporte');
    divComp= crearDivComponente('divSoporte');
    divLabel= crearDivLabel('Soporte');
    strComp="<div class='divContentComponente'> "+divLabel+divComp+"</div>";
    $(strComp).appendTo("#estructuraDelNivel2");    
    $(comp).appendTo("#divSoporte");

    comp= crearComponente('text','pais_publicacion',[],'');
    hacerComponenteObbligatoria('pais_publicacion');
    divComp= crearDivComponente('divPaisPublicacion');
    divLabel= crearDivLabel('Pais de Publicacion');
    strComp="<div class='divContentComponente'> "+divLabel+divComp+"</div>";
    $(strComp).appendTo("#estructuraDelNivel2");    
    $(comp).appendTo("#divPaisPublicacion");

    comp= crearComponente('text','lenguaje',[],'');
    hacerComponenteObbligatoria('lenguaje');
    divComp= crearDivComponente('divLenguaje');
    divLabel= crearDivLabel('Lenguaje');
    strComp="<div class='divContentComponente'> "+divLabel+divComp+"</div>";
    $(strComp).appendTo("#estructuraDelNivel2");    
    $(comp).appendTo("#divLenguaje");

    comp= crearComponente('text','ciudad_publicacion',[],'');
    hacerComponenteObbligatoria('ciudad_publicacion');
    divComp= crearDivComponente('divCiudadPublicacion');
    divLabel= crearDivLabel('Ciudad de Publicacion');
    strComp="<div class='divContentComponente'> "+divLabel+divComp+"</div>";
    $(strComp).appendTo("#estructuraDelNivel2");    
    $(comp).appendTo("#divCiudadPublicacion");

    comp= crearComponente('text','anio_publicacion',[],'');
    hacerComponenteObbligatoria('anio_publicacion');
    divComp= crearDivComponente('divAnioPublicacion');
    divLabel= crearDivLabel('Año de Publicacion');
    strComp="<div class='divContentComponente'> "+divLabel+divComp+"</div>";
    $(strComp).appendTo("#estructuraDelNivel2");    
    $(comp).appendTo("#divAnioPublicacion");
}


// function crearComponentesNivel3(){
//     getOptionsComboUI();//recupero el arreglo de opcciones de UI
// 
//     var comp= crearComponente('text','barcode',[],'');
//     hacerComponenteObbligatoria('barcode');
//     var divComp= crearDivComponente('divCodigoBarra');  
//     var divLabel= crearDivLabel('Codigo de Barra');
//     strComp="<div class='divContentComponente'> "+divLabel+divComp+"</div>";
//     $(strComp).appendTo("#estructuraDelNivel3");
//     $(comp).appendTo("#divCodigoBarra");  
// 
//     comp= crearComponente('text','signatura_topografica',[],'');
//     hacerComponenteObbligatoria('signatura_topografica');
//     divComp= crearDivComponente('divSignaturaTopografica');
//     divLabel= crearDivLabel('Signatura Topografica');
//     strComp="<div class='divContentComponente'> "+divLabel+divComp+"</div>";
//     $(strComp).appendTo("#estructuraDelNivel3");    
//     $(comp).appendTo("#divSignaturaTopografica");
//     
// alert(array_info_combo);
//     comp= crearComponente('combo','id_ui_poseedora',array_info_combo,'');
//     hacerComponenteObbligatoria('id_ui_poseedora');
//     divComp= crearDivComponente('divUIPoseedora');
//     divLabel= crearDivLabel('UI Poseedora');
//     strComp="<div class='divContentComponente'> "+divLabel+divComp+"</div>";
//     $(strComp).appendTo("#estructuraDelNivel3");    
//     $(comp).appendTo("#divUIPoseedora");
// 
//     comp= crearComponente('combo','id_ui_origen',array_info_combo,'');
//     hacerComponenteObbligatoria('id_ui_origen');
//     divComp= crearDivComponente('divUIOrigen');
//     divLabel= crearDivLabel('UI Origen');
//     strComp="<div class='divContentComponente'> "+divLabel+divComp+"</div>";
//     $(strComp).appendTo("#estructuraDelNivel3");    
//     $(comp).appendTo("#divUIOrigen");
// 
//     comp= crearComponente('text','para_sala',[],'');
//     hacerComponenteObbligatoria('para_sala');
//     divComp= crearDivComponente('divParaSala');
//     divLabel= crearDivLabel('Para Sala');
//     strComp="<div class='divContentComponente'> "+divLabel+divComp+"</div>";
//     $(strComp).appendTo("#estructuraDelNivel3");    
//     $(comp).appendTo("#divParaSala");
// }

// Esta funcion convierte una componete segun idObj en obligatoria, agrega * a la derecha de la misma
function hacerComponenteObbligatoria(idObj){
    $("#"+idObj).addClass("obligatorio");
    $("<b> * </b>").insertAfter($("#"+idObj));    
}

// Esta funcion crea un divComponente con un id segun parametro idObj
function crearDivComponente(idObj){
    return "<div id='"+idObj+"' class='divComponente'></div>";
}

// Esta funcion crea un divLabel con un Label segun parametro
function crearDivLabel(label){
    return "<div class='divLabelComponente'>  "+label+": </div>";
}
//************************************************FIN REVISADO**************************************************************


/*  *****  EL OBJETO objAH SE ENCUENTRA EN LA LIBRERIA DE seleccionCamposMarc.js ***** */

/*
 * CrearAutocomplete1
 * Asigna la funcion de autocomplete a el input text del autor.
 */
function CrearAutocomplete1(nivel){
	if(nivel==1){
		crearAuto("autor","autores","reemplazar","idAutor");
	}
	
}

/*
 * updateInfoAgregarItem
 * Funcion que se ejecuta cuando termina el llamado ajax de varias funciones.
 */
function updateInfoAgregarItem(responseText){
	$("#result2").html(responseText);
	CrearAutocomplete1(objAH.nivel);
	consultarAjaxJSON();
}

/*
 * borrarN1
 * Elimina de la base de datos el documento con id1 igual al parametro que ingresa y todos los otros datos 
 * correspondiente a los otros niveles que hacen referencia al id1.
 */
function borrarN1(id1){
	$("#result").html("");
	objJSON=new AjaxHelper();
    objJSON.debug= true;
	objJSON.itemtype=$("#id_tipo_doc").val();
	objJSON.paso=1;

	objAH=new AjaxHelper(updateBorrarN1);
   objAH.debug= true;
	objAH.url="/cgi-bin/koha/catalogacion/estructura/nuevo/estructuraCataloDB.pl";
	objAH.id1=id1;
	objAH.nivel=1;
	objAH.itemtype=$("#id_tipo_doc").val();
	objAH.tipoAccion="ELIMINAR_NIVEL";
	objAH.sendToServer();
}
function updateBorrarN1(responseText){
    var info=JSONstring.toObject(responseText);
    var Messages= info.Message_arrayref;
    setMessages(Messages);
}
/*
 * modificarN1
 * Funcion que obtiene los datos ingresados en el nivel 1 para poder crear los componentes con los valores
 * guardados en la base de datos y poder modificarlos.
 */
function modificarN1(id1){
   inicializar();
	$("#result").html("");
	objAH=new AjaxHelper(updateModificarN1);
   objAH.url="/cgi-bin/koha/catalogacion/estructura/nuevo/estructuraCataloDB.pl";
   objAH.debug= true;
	objAH.tipoAccion="MOSTRAR_ESTRUCTURA_DEL_NIVEL_CON_DATOS";
	objAH.itemtype="ALL";
   objAH.id = id1;
   objAH.nivel = 1;
	objAH.sendToServer();
}
function updateModificarN1(responseText){
   modificar = 1;
   dataModif = JSONstring.toObject(responseText);
   mostrarEstructuraDelNivel1();
   
   
}

function modificarN2(id2){
   inicializar();
   $("#result").html("");
   objAH=new AjaxHelper(updateModificarN2);
   objAH.url="/cgi-bin/koha/catalogacion/estructura/nuevo/estructuraCataloDB.pl";
   objAH.debug= true;
   objAH.tipoAccion="MOSTRAR_ESTRUCTURA_DEL_NIVEL_CON_DATOS";
   objAH.itemtype="ALL";
   objAH.id = id2;
   objAH.nivel = 2;
   objAH.sendToServer();
}
function updateModificarN1(responseText){
   modificar = 1;
   dataModif = JSONstring.toObject(responseText);
   mostrarEstructuraDelNivel2();
   
   
}
/*
 * borrarGrupo
 * Elimina de la base de datos el grupo correspodiente a los parametros que ingresan, y los ejemplares que hay en 
 * ese grupo.
 */
function borrarGrupo(id1,id2){
	$("#result").html("");
	
	objJSON=new AjaxHelper();
    objJSON.debug= true;
	objJSON.itemtype=$("#id_tipo_doc").val();
	objJSON.paso=2;
	
	objAH=new AjaxHelper(updateInfoAgregarItem);
    objAH.debug= true;
	objAH.url="/cgi-bin/koha/catalogacion/estructura/nuevo/estructuraCataloDB.pl";
	objAH.id2=id2;
	objAH.nivel=2;
	objAH.itemtype=$("#id_tipo_doc").val();
	objAH.tipoAccion="ELIMINAR_NIVEL";
	objAH.sendToServer();
}

/*
 * ajaxModificarGrupo
 * Funcion que realiza el llamado ajax para dibujar los componentes en la pantalla de un grupo.
 * retorna strign en json.
 */
function ajaxModificarGrupoJSON(id1,id2){
	objAH=new AjaxHelper(procesarInfoJson);
    objAH.debug= true;
	objAH.url="/cgi-bin/koha/catalogacion/estructura/editarGrupo.pl";
	objAH.id1=id1;
	objAH.id2=id2;
	objAH.json=1;
	objAH.sendToServer();
}

/*
 * updateInfoModGrupo
 * Funcion que se ejecuta cuando termina el llamado ajax de la funcion modificarGrupo.
 */
function updateInfoModGrupo(responseText){
	$("#contenido").html(responseText);
	ajaxModificarGrupoJSON(objAH.id1,objAH.id2);
}

/*
 * modificarGrupo
 * Dibuja la pagina donde se van a colocar los componentes que se creen a partir del llamado ajax con json.
 */
function modificarGrupo(id1,id2){
	$("#result").html("");
	
	objAH=new AjaxHelper(updateInfoModGrupo);
    objAH.debug= true;
	objAH.url="/cgi-bin/koha/catalogacion/estructura/editarGrupo.pl";
	objAH.id1=id1;
	objAH.id2=id2;
	objAH.json=0;
	objAH.sendToServer();
}

/*
 * redirigirURL
 * Funcion que se ejecuta cuando termina el llamado ajax de la funcion modNivel2 y agregarNivel3.
 */
function redirigirURL(responseText){
	location.href="agregarItem.pl?origen="+objAH.accion+"&id1="+objAH.id1+"&itemtype="+$("#id_tipo_doc").val();
}

/*
 * modNivel2
 * Guarda en la base de datos los cambios hechos al grupo con id= id2.
 */
function modNivel2(id1,id2){
	var ok=1;
	var cantIds=$("#cantIds").val();
	ok=obtenerIdsValores(cantIds);
	if(ok){
		objAH=new AjaxHelper(redirigirURL);
        objAH.debug= true;
		objAH.url="/cgi-bin/koha/catalogacion/estructura/editarGrupo.pl";
		objAH.id1=id1;
		objAH.id2=id2;
		objAH.cantIds=cantIds;
		objAH.respuesta=arrayjson;
		objAH.accion="modNivel2";
		objAH.json=0;
		objAH.sendToServer();
		
	}
	else{
		alert('[% "Por favor complete los campos del formulario que son obligatorios" | i18n %]');
	}
}

/*
 * ajaxAgregarEjemplarJSON
 * Funcion que realiza el llamado ajax para dibujar los componentes en la pantalla del ejemplar a agregar.
 * retorna strign en json.
 */
function ajaxAgregarEjemplarJSON(id1,id2,itemtype){
	objAH=new AjaxHelper(procesarInfoJson);
    objAH.debug= true;
	objAH.url="/cgi-bin/koha/catalogacion/estructura/agregarEjemplar.pl";
	objAH.id1=id1;
	objAH.id2=id2;
	objAH.itemtype=itemtype;
	objAH.json=1;
	objAH.sendToServer();
}

function updateInfoAgrEjemplar(responseText){
	$("#contenido").html(responseText);
	ajaxAgregarEjemplarJSON(objAH.id1,objAH.id2,objAH.itemtype);
}

/*
 * agregarEjemplar
 * Dibuja la pagina donde se van a colocar los componentes que se generen a partir de la consulta ajax
 */
function agregarEjemplar(id1,id2,itemtype){
	$("#result").html("");

	objAH=new AjaxHelper(updateInfoAgrEjemplar);
    objAH.debug= true;
	objAH.url="/cgi-bin/koha/catalogacion/estructura/agregarEjemplar.pl";
	objAH.id1=id1;
	objAH.id2=id2;
	objAH.itemtype=itemtype;
	objAH.sendToServer();
}

/*
 * agregarNivel3
 * Guarda en la base de datos el ejemplar que se quiere agregar.
 */
function agregarNivel3(id1,id2){
	var ok=1;
	var itemtype=$("#id_tipo_doc").val();
	var cantIds=$("#cantIds").val();
	ok=obtenerIdsValores(cantIds);
	var barcodes=$("#codbarra").val();
	var cantItems=$("#cantitems").val();
	
	if(ok){
		objAH=new AjaxHelper(redirigirURL);
        objAH.debug= true;
		objAH.url="/cgi-bin/koha/catalogacion/estructura/agregarEjemplar.pl";
		objAH.id1=id1;
		objAH.id2=id2;
		objAH.cantIds=cantIds;
		objAH.cantItems=cantItems;
		objAH.barcodes=barcodes;
		objAH.respuesta=arrayjson;
		objAH.accion="agregarNivel3";
		objAH.sendToServer();
		
	}
	else{
		alert('[% "Por favor complete los campos del formulario que son obligatorios" | i18n %]');
	}
}



/*
 * guardarDatos
 * Combierte el arreglo con los datos de los componentes y los valores ingresado en un string (con json) para
 * poder mandarlo por parametro y poder guardarlos en la base de datos.
 */
function guardarDatos(paso){
	objJSON=new AjaxHelper();
    objJSON.debug= true;
	objJSON.itemtype=$("#itemtype").val();
	objJSON.paso=paso;
	
	objAH=new AjaxHelper(updateInfoAgregarItem);
    objAH.debug= true;
	objAH.url="/cgi-bin/koha/catalogacion/estructura/agregarItemResults.pl";
	objAH.paso=paso;
	objAH.id1=$("#id1").val();
	objAH.itemtype=$("#id_tipo_doc").val();
	objAH.respuesta=arrayjson;
	objAH.cantIds=$("#cantIds").val();
	
	if(paso==2){
		objAH.idAutor=$("#idAutor").val();
		objAH.accion=$("#accion").val();
		objAH.nivel=paso;
	}
	if(paso==3){
		objJSON.paso=2;
		
		objAH.codbarra=$("#codbarra").val();
		objAH.cantitems=$("#cantitems").val();
		objAH.nivel=2;
	}
	objAH.sendToServer();
}

/*
 * guardarItem
 * Obtiene los valores de los datos ingresados. Y si los campos obligatorios no estan en blanco los guarda.
 */
function guardarItem(paso){
	var ok=1;
	var cantIds=$("#cantIds").val();
	ok=obtenerIdsValores(cantIds);
	if(ok){
		guardarDatos(paso+1);
		$("#result").html(""); //limpia la div result (agregar campo temporal)
	}
	else{
		alert('[% "Por favor complete los campos del formulario que son obligatorios" | i18n %]');
	}
}

/*
 * updateInfoModDetalleGrupo
 * Funcion que se ejecuta cuando termina el llamado ajax de la parte de ready, origen=detalle y nivel=2.
 */
function updateInfoModDetalleGrupo(responseText){
	$("#result2").html(responseText);
	modificarGrupo(objAH.id1,objAH.id2);
}

//Funcion que se ejecuta cuando se carga la pagina, dependiendo de donde viene ejecuta las funciones correspondientes.
$(document).ready( function() {
//SE PUEDE MANDAR UN OBJETO A LA URL Y TRABAJARLO EN EN PL, COMO EN prestamos.pl y devolucion.pl!!!!!
	var array = location.href.split('?');
	if (array.length >1){
		var array=array[1].split('&');
		var origen=array[0].split('=')[1];

		objAH=new AjaxHelper(updateInfoAgregarItem);
        objAH.debug= true;
		objAH.url="/cgi-bin/koha/catalogacion/estructura/agregarItemResults.pl";
		objAH.id1=array[1].split('=')[1];
		objAH.itemtype=array[2].split('=')[1];
		switch(origen){
		  case "detalle":
			var nivel=array[3].split('=')[1];
			if(nivel==1){
				objJSON=new AjaxHelper();	
                objJSON.debug= true;
				objJSON.id1=objAH.id1;
				objJSON.accion="modificarN1";
				objJSON.itemtype="ALL";
				objJSON.paso=1;

				objAH.debug=true;
				objAH.nivel=1;
				objAH.accion="modificarN1";
				
			}
			if(nivel==2){
				var id2=array[4].split('=')[1];
				objAH.onComplete=updateInfoModDetalleGrupo;
				objAH.paso=2;
				objAH.nivel=2;
				objAH.id2=id2;
				objAH.accion2="agregarN2";
			}
			break;
		  case "modNivel2":
			objJSON=new AjaxHelper();
            objJSON.debug= true;
			objJSON.id1 = objAH.id1;
			objJSON.itemtype = objAH.itemtype;
			objJSON.paso=2;

			objAH.nivel=2;
			objAH.accion="modificarN2";
			break;
		  default:
			objJSON=new AjaxHelper();
            objJSON.debug= true;
			objJSON.id1=objAH.id1;
			objJSON.itemtype=objAH.itemtype;
			objJSON.paso=2;
	
			objAH.paso=2;
			objAH.nivel=2;
			objAH.accion2="agregarN2";
			break;
		}
		objAH.sendToServer();
	}
} );



</script>
<div style="text-align: right;"><span class="click" onClick="abrirVentanaHelperMARC();">Ayuda MARC</span></div>

<p class="pagetitle" >[% "Agregar Documento" | i18n %]</p>

[% "Esquema de ingreso de datos tipo:" | i18n %] [% selectItemType %]
<br><br>

<div class="todo">

<div class="lateral">
    <div id="nivel1" class="nivel1Lateral"></div>
    <div class="nivel2Barra">
        <div id="nivel2" class="nivel2Lateral"></div>
    </div>
</div>   <!--END <div class="lateral">-->

<div class="centro">

<span id="nivel1Tabla">
    <table width="100%" cellspacing="0" cellpadding="0" border="0">
        <tr class="tablaresultadoTitle">
            <td width="1%" align="left" valign="top">
                <img src="[% themelang %]/images/izquierda.png">
            </td>
            <td colspan="7" class=inputFontNormal> 
                    <b>[% "Agregar Documento:" | i18n %] [% descripcion %]  (paso: 1 de 3) </b>
            </td>
            <td width="1%" align="right" valign="top">
                <img src="[% themelang %]/images/derecha.png">
            </td>
        </tr>
    </table>

<!--     CAMPOS FIJOS DEL NIVEL 1 -->
    <div class="divContentComponente">
    <div class="divLabelComponente"> T&iacute;tulo: </div>
        <div id="divTitulo" class="divComponente">
            <input id="titulo" class="obligatorio" type="text" size="80" value=""/><b> * </b>
        </div>
    </div>
    
<!--     CAMPOS DINAMICOS DEL NIVEL1 -->
    <div id= "estructuraDelNivel1"></div>

    <br>
    <p><b>&nbsp;* [% "Campos obligatorios" | i18n %]</b></p>
    
    <center>
    <input  type="image" src="[% themelang %]/images/guardar.png" value="[% 'Guardar nivel 1' | i18n %]" title="[% 'Guardar nivel 1' | i18n %]"  
            onClick="guardarDocumentoN1()">
    </center>
</span>

<span id="nivel2Tabla">
    <table width="100%" cellspacing="0" cellpadding="0" border="0">
        <tr class="tablaresultadoTitle">
            <td width="1%" align="left" valign="top">
                <img src="[% themelang %]/images/izquierda.png">
            </td>
            <td colspan="7" class=inputFontNormal> 
                    <b>[% "Agregar Grupo:" | i18n %] [% descripcion %]  (paso: 2 de 3) </b>
            </td>
            <td width="1%" align="right" valign="top">
                <img src="[% themelang %]/images/derecha.png">
            </td>
        </tr>
    </table>
    

    <div class="divContentComponente">
        <div class="divLabelComponente">  Tipo de Documento: </div>
            <div id="divTipoDocumento" class="divComponente">[% comboTipoDocumento %]</div>
    </div>

    <div class="divContentComponente"> 
        <div class="divLabelComponente">  Nivel Bibliogr&aacute;fico: </div>
            <div id="divNivelBibliografico" class="divComponente"><input id="nivel_bibliografico" value="" size="80" type="text"></div>
    </div>

    <div class="divContentComponente">
        <div class="divLabelComponente">  Soporte: </div>
            <div id="divSoporte" class="divComponente"> generar combo tipo soporte en el servidor </div>
    </div>

    <div class="divContentComponente"> 
        <div class="divLabelComponente">  Pais de Publicaci&oacute;n: </div>
            <div id="divPaisPublicacion" class="divComponente">generar combo en el server<input id="pais_publicacion" value="" size="80" type="text"></div>
    </div>

    <div class="divContentComponente"> 
        <div class="divLabelComponente">  Lenguaje: </div>
            <div id="divLenguaje" class="divComponente">generar combo en el server<input id="lenguaje" value="" size="80" type="text"></div>
    </div>
    
    <div class="divContentComponente">
        <div class="divLabelComponente">  Ciudad de Publicaci&oacute;n: </div>
            <div id="divCiudadPublicacion" class="divComponente">generar combo en el server<input id="ciudad_publicacion" value="" size="80" type="text"></div>
    </div>

    <div class="divContentComponente">
        <div class="divLabelComponente">  A&ntilde;o de Publicaci&oacute;n: </div>
            <div id="divAnioPublicacion" class="divComponente"><input id="anio_publicacion" value="" size="80" type="text"></div>
    </div>

<!--     CAMPOS DINAMICOS DEL NIVEL 2 -->
    <div id= "estructuraDelNivel2"></div>

    <br>
    <p><b>&nbsp;* [% "Campos obligatorios" | i18n %]</b></p>
    
    <center>
    <input  type="image" src="[% themelang %]/images/guardar.png" value="[% 'Guardar nivel 2' | i18n %]" title="[% 'Guardar nivel 1' | i18n %]"  
            onClick="guardarDocumentoN2()">
    </center>
</span>

<span id="nivel3Tabla">
    <table width="100%" cellspacing="0" cellpadding="0" border="0">
        <tr class="tablaresultadoTitle">
            <td width="1%" align="left" valign="top">
                <img src="[% themelang %]/images/izquierda.png">
            </td>
            <td colspan="7" class=inputFontNormal> 
                    <b>[% "Agregar Ejemplar:" | i18n %] [% descripcion %]  (paso: 3 de 3) </b>
            </td>
            <td width="1%" align="right" valign="top">
                <img src="[% themelang %]/images/derecha.png">
            </td>
        </tr>
    </table>

<!--     CAMPOS FIJOS DEL NIVEL 3   -->
    <div class="divContentComponente"> 
        <div class="divLabelComponente">  Codigo de Barra: </div>
        <div id="divCodigoBarra" class="divComponente"><input class="obligatorio" id="barcode" value="" size="80" type="text"><b> * </b></div>
    </div>
    <div class="divContentComponente"> 
        <div class="divLabelComponente">  Signatura Topografica: </div><div id="divSignaturaTopografica" class="divComponente">
            <input class="obligatorio" id="signatura_topografica" value="" size="80" type="text"><b> * </b></div>
    </div>
    <div class="divContentComponente"> <div class="divLabelComponente">  UI Poseedora: </div>
        <div id="divUIPoseedora" class="divComponente">
            [% selectUIPoseedora %]<b> * </b>
        </div>
    </div>
    <div class="divContentComponente"> <div class="divLabelComponente">  UI Origen: </div>
        <div id="divUIOrigen" class="divComponente">
            [% selectUIOrigen %]<b> * </b>
        </div>
    </div>
    <div class="divContentComponente"> <div class="divLabelComponente">  Para Sala: </div><div id="divParaSala" class="divComponente">
        <input class="obligatorio" id="para_sala" value="" size="80" type="text"><b> * </b></div>
    </div>

<!--     CAMPOS DINAMICOS DEL NIVEL 3 -->
    <div id= "estructuraDelNivel3"></div>

    <br><p><b>&nbsp;* [% "Campos obligatorios" | i18n %]</b></p>
    
    <center>
    <input  type="image" src="[% themelang %]/images/guardar.png" value="[% 'Guardar nivel 3' | i18n %]" title="[% 'Guardar nivel 1' | i18n %]"  
            onClick="guardarDocumentoN3()">
    </center>
</span>

</div> <!--END <div class="centro">-->

<!-- detalle del Nivel 3, segun Nivel 2 seleccionado -->
<div id="detalleDelNivel3" class="nivel3Footer"></div>

</div> <!--END <div class="todo">-->

[% INCLUDE "intranet-bottom.inc" %]

