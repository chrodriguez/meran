
-- No se usa esta tabla
drop table users;

-- Se renombro la tabla

RENAME TABLE usr_socios  TO usr_socio;

--Se deja el id_persona en usr_socio
ALTER TABLE `usr_persona`  DROP `id_socio`;

--se modifico el campo
ALTER TABLE `usr_persona` CHANGE `vesion_documento` `version_documento` CHAR( 1 ) CHARACTER SET latin1 COLLATE latin1_swedish_ci NOT NULL DEFAULT 'P' ;

--se modificaron los campos


ALTER TABLE `usr_socio` CHANGE `lastlogin` `last_login` DATETIME NULL DEFAULT NULL ,
CHANGE `lastchangepassword` `last_change_password` DATE NULL DEFAULT NULL ,
CHANGE `changepassword` `change_password` TINYINT( 1 ) NOT NULL DEFAULT '0';

ALTER TABLE `usr_persona` ADD `activo` tinyint( 1 ) unsigned NOT NULL default '1';

ALTER TABLE `usr_estado` ADD `id_estado` INT( 11 ) NOT NULL AUTO_INCREMENT PRIMARY KEY FIRST ;
ALTER TABLE `usr_estado` ADD UNIQUE (`id_persona` ,`fuente`);


--RENAMES si no lo hacen no anda nada!!!--

RENAME TABLE userflags TO usr_permiso;
RENAME TABLE sessions TO sist_sesion;
RENAME TABLE systempreferences TO pref_preferencia_sistema;
--


NO RENOMBRE LA TABLA CATEGORIES PARA NO ROMPER TODO, SE EXPORTO LA INFO Y SE MODIFICO EL NOMBRE DE LA TABLA
HAY 2 TABLAS AHORA, MAS ADELANTE SE ELIMINA CATEGORIES

CREATE TABLE `usr_ref_categoria_socio` (
  `categorycode` char(2) NOT NULL default '',
  `description` text,
  `enrolmentperiod` smallint(6) default NULL,
  `upperagelimit` smallint(6) default NULL,
  `dateofbirthrequired` tinyint(1) default NULL,
  `finetype` varchar(30) default NULL,
  `bulk` tinyint(1) default NULL,
  `enrolmentfee` decimal(28,6) default NULL,
  `overduenoticerequired` tinyint(1) default NULL,
  `issuelimit` smallint(6) default NULL,
  `reservefee` decimal(28,6) default NULL,
  `borrowingdays` smallint(30) NOT NULL default '14',
  UNIQUE KEY `categorycode` (`categorycode`)
) ENGINE=innodb DEFAULT CHARSET=latin1;

-- 
-- Volcar la base de datos para la tabla `categories`
-- 

INSERT INTO `usr_ref_categoria_socio` (`categorycode`, `description`, `enrolmentperiod`, `upperagelimit`, `dateofbirthrequired`, `finetype`, `bulk`, `enrolmentfee`, `overduenoticerequired`, `issuelimit`, `reservefee`, `borrowingdays`) VALUES 
('ES', 'Estudiante', 0, 55, 18, NULL, NULL, 0.000000, 0, 0, 0.000000, 14),
('IN', 'Investigador', 15, 100, 0, NULL, NULL, 0.000000, 0, 8, 0.000000, 14),
('DO', 'Docente', 10, 80, 0, NULL, NULL, 0.000000, 1, 5, 0.000000, 14),
('ND', 'No Docente', 10, 0, 0, NULL, NULL, 0.000000, 1, 3, 0.000000, 14),
('EG', 'Egresado', 10, 0, 0, NULL, NULL, 0.000000, 1, 3, 0.000000, 14),
('PG', 'Postgrado', NULL, 90, NULL, NULL, NULL, NULL, 1, 3, NULL, 14);

ALTER TABLE `usr_ref_categoria_socio` ADD PRIMARY KEY ( `categorycode` ) ;

ALTER TABLE usr_socio ADD FOREIGN KEY(id_persona) REFERENCES usr_persona(id_persona);



-- LOS BRANCHES


-- 
-- Estructura de tabla para la tabla `pref_unidad_informacion`
-- 

CREATE TABLE `pref_unidad_informacion` (
  `id_ui` varchar(4) NOT NULL,
  `nombre` varchar(255) NOT NULL,
  `direccion` varchar(255) default NULL,
  `alt_direccion` varchar(255) default NULL,
  `telefono` varchar(255) default NULL,
  `fax` varchar(255) default NULL,
  `email` varchar(255) default NULL,
  PRIMARY KEY  (`id_ui`)
) ENGINE=MyISAM DEFAULT CHARSET=latin1;

-- 
-- Volcar la base de datos para la tabla `pref_unidad_informacion`
-- 

INSERT INTO `pref_unidad_informacion` (`id_ui`, `nombre`, `direccion`, `alt_direccion`, `telefono`, `fax`, `email`) VALUES 
('DEO', 'Facultad de Ciencias Económicas', '6 entre 47 y 48. 1° subusuelo', '0221-423-6771/6769', '', 'biblio@econo.unlp.edu.ar', NULL),
('DIF', 'Facultad de Informática', '115 esquina 50. 1° subusuelo', '', '', 'biblioteca@info.unlp.edu.ar', NULL),
('CD', 'Centro de Documentación', '7 Nº 445', '', '', '', NULL);


-- NUEVAS PREFERENCIAS


INSERT  INTO  `pref_preferencia_sistema` (  `variable` ,  `value` ,  `explanation` ,  `options` ,  `type`  ) 
VALUES ( 'autoActivarPersona',  '0',  'Activa por defecto un alta de una persona',  NULL ,  NULL );




ALTER TABLE `pref_unidad_informacion` ADD PRIMARY KEY ( `id_ui` );


-- Se creo una nueva preferencia, el 'defaultBranch' se conserva para que no se rompa nada, despues se borra

INSERT INTO `pref_preferencia_sistema` ( `variable` , `value` , `explanation` , `options` , `type` )
VALUES (
'defaultUI', 'DEO', 'Unidad de informacion por defecto', NULL , NULL
); 



INSERT INTO `pref_preferencia_sistema` ( `variable` , `value` , `explanation` , `options` , `type` )
VALUES (
'defaultTipoDoc', 'DNI', 'Tipo de Documento por defecto', NULL , NULL
); 


INSERT INTO `pref_preferencia_sistema` ( `variable` , `value` , `explanation` , `options` , `type` )
VALUES (
'defaultCategoriaSocio', 'ES', 'Categoria de Socio por defecto', NULL , NULL
); 

INSERT INTO `pref_preferencia_sistema` ( `variable` , `value` , `explanation` , `options` , `type` )
VALUES (
'defaultDisponibilidad', 'ES', 'Disponibilidad por defecto', NULL , NULL
); 



CREATE TABLE `ref_disponibilidad` (
  `codigo` tinyint(5) NOT NULL default '0',
  `nombre` varchar(255) NOT NULL default '',
  PRIMARY KEY  (`codigo`),
  UNIQUE KEY `nombre` (`nombre`)
) ENGINE=MyISAM DEFAULT CHARSET=latin1;

-- 
-- Volcar la base de datos para la tabla `ref_disponibilidad`
-- 

INSERT INTO `ref_disponibilidad` (`codigo`, `nombre`) VALUES 
(1, 'Perdido'),
(2, 'Compartido'),
(4, 'Baja'),
(5, 'Ejemplar deteriorado'),
(6, 'En Encuadernación'),
(0, 'Disponible');

ALTER TABLE usr_socio ADD FOREIGN KEY ( cod_categoria ) REFERENCES usr_ref_categoria_socio( categorycode ) ;

ALTER TABLE `usr_persona` ADD `es_socio` INT( 1 ) UNSIGNED NOT NULL DEFAULT '0' COMMENT '1= si; 0=no';

ALTER TABLE `usr_estado` DROP `id_socio` =======

ALTER TABLE `usr_estado` DROP INDEX `id_persona` 

 ALTER TABLE `usr_estado`
  DROP `id_persona`;


ALTER TABLE usr_socio ADD FOREIGN KEY ( id_estado ) REFERENCES usr_estado( id_estado ) 


ALTER TABLE `usr_socio` ADD `activo` TINYINT( 1 ) UNSIGNED NOT NULL DEFAULT '1' AFTER `id_estado` ;

ALTER TABLE `usr_persona` DROP `activo` ;

ALTER TABLE `usr_persona` ADD `legajo` VARCHAR( 8 ) NOT NULL ;

--- PARA TESTEAR SESSIONES, PARA Q NO SE QUEDEN AFUERA

INSERT INTO `usr_estado` (`id_estado`, `regular`, `categoria`, `fuente`) VALUES
(20, 1, 'NN', 'ES UNA FUENTE DEFAULT, PREGUNTARLE A EINAR....');

INSERT INTO `usr_persona` (`id_persona`, `legajo`, `version_documento`, `nro_documento`, `tipo_documento`, `apellido`, `nombre`, `titulo`, `otros_nombres`, `iniciales`, `calle`, `barrio`, `ciudad`, `telefono`, `email`, `fax`, `msg_texto`, `alt_calle`, `alt_barrio`, `alt_ciudad`, `alt_telefono`, `nacimiento`, `fecha_alta`, `sexo`, `telefono_laboral`, `cumple_condicion`) VALUES 
(1, '26329', 'P', '27855859', '1', 'Carbone', 'Miguel', 'titulo', 'otros nombreeeeeessssssssssss', 'DGR', '1', NULL, '343978', '4227804', 'carbon@yahoo.com.ar', NULL, NULL, NULL, NULL, '7920', NULL, '2009-12-24', NULL, 'M', NULL, 0);


INSERT INTO `usr_socio` (`id_persona`, `id_socio`, `nro_socio`, `id_ui`, `cod_categoria`, `fecha_alta`, `expira`, `flags`, `password`, `last_login`, `last_change_password`, `change_password`, `cumple_requisito`, `id_estado`, `activo`) VALUES 
(1, 3, '26320', 'DEO', 'DO', NULL, NULL, NULL, 'ICy5YqxZB1uWSwcVLSNLcA', NULL, NULL, 0, NULL, 20, 1);


ALTER TABLE `usr_permiso` ADD PRIMARY KEY ( `bit` ) ;

ALTER TABLE `usr_permiso` ADD UNIQUE (`flagdesc`);

ALTER TABLE `usr_permiso` CHANGE `flag` `flag` VARCHAR( 255 ) CHARACTER SET latin1 COLLATE latin1_swedish_ci NULL DEFAULT NULL , CHANGE `flagdesc` `flagdesc` VARCHAR( 255 ) CHARACTER SET latin1 COLLATE latin1_swedish_ci NULL DEFAULT NULL ;


ALTER TABLE `usr_estado`  ENGINE = innodb;

ALTER TABLE `usr_ref_estado`  ENGINE = innodb;

ALTER TABLE `usr_permiso`  ENGINE = innodb;

--Se agrego en koha.conf la siguiente variable, si se setea en 1 se loguean "solos" los objetos
debug=1
